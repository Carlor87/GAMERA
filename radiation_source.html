

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Radiation: source &mdash; GAMERA 0.9 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="GAMERA 0.9 documentation" href="index.html"/>
        <link rel="up" title="Radiation" href="radiation.html"/>
        <link rel="next" title="Radiation: header" href="radiation_header.html"/>
        <link rel="prev" title="Radiation: public members" href="radiation_members.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> GAMERA
          

          
          </a>

          
            
            
              <div class="version">
                0.9
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation and Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">Tutorial</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="classes.html">Class Documentation</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="radiation.html">Radiation</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="radiation_members.html">Radiation: public members</a></li>
<li class="toctree-l3"><a class="reference internal" href="radiation_members.html#radiation-private-members">Radiation: private members</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="">Radiation: source</a></li>
<li class="toctree-l3"><a class="reference internal" href="radiation_header.html">Radiation: header</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="particles.html">Particles</a></li>
<li class="toctree-l2"><a class="reference internal" href="utils.html">Utils</a></li>
<li class="toctree-l2"><a class="reference internal" href="astro.html">Astro</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">GAMERA</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
          <li><a href="classes.html">Class Documentation</a> &raquo;</li>
      
          <li><a href="radiation.html">Radiation</a> &raquo;</li>
      
    <li>Radiation: source</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/radiation_source.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="radiation-source">
<h1>Radiation: source<a class="headerlink" href="#radiation-source" title="Permalink to this headline">Â¶</a></h1>
<div class="highlight-C++"><div class="highlight"><pre><span class="cp">#include &quot;Radiation.h&quot;</span>
<span class="cm">/**</span>
<span class="cm"> * Constructor. Nothing fancy, just initialises some stuff.</span>
<span class="cm"> */</span>
<span class="n">Radiation</span><span class="o">::</span><span class="n">Radiation</span><span class="p">()</span> <span class="p">{</span>
  <span class="cm">/* Default values */</span>
  <span class="n">fUtils</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Utils</span><span class="p">();</span>
  <span class="n">ParticleVector</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
  <span class="n">DEBUG</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  <span class="n">fintbrems</span> <span class="o">=</span> <span class="n">lintbrems</span> <span class="o">=</span> <span class="n">fintpp</span> <span class="o">=</span> <span class="n">lintpp</span> <span class="o">=</span> <span class="n">fintic</span> <span class="o">=</span> <span class="n">lintic</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="n">ldiffbrems</span> <span class="o">=</span> <span class="n">fdiffbrems</span> <span class="o">=</span> <span class="n">ldiffsynch</span> <span class="o">=</span> <span class="n">fdiffsynch</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="n">ldiffic</span> <span class="o">=</span> <span class="n">fdiffic</span> <span class="o">=</span> <span class="n">ldiffpp</span> <span class="o">=</span> <span class="n">fdiffpp</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="n">TargetPhotonEdens</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="n">TargetPhotonVector</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
  <span class="n">TargetPhotonVectorOld</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
  <span class="n">INTEGRATEOVERGAMMAS</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  <span class="n">QUIETMODE</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  <span class="n">PiModel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">SynchModel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">integratorTolerance</span> <span class="o">=</span> <span class="mf">5.e-2</span><span class="p">;</span>
  <span class="n">acc</span> <span class="o">=</span> <span class="n">gsl_interp_accel_alloc</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Standard destructor.</span>
<span class="cm"> */</span>
<span class="n">Radiation</span><span class="o">::~</span><span class="n">Radiation</span><span class="p">()</span> <span class="p">{}</span>

<span class="kt">void</span> <span class="n">Radiation</span><span class="o">::</span><span class="n">Reset</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">ParticleVector</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
  <span class="n">ElectronVector</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
  <span class="n">ProtonVector</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
  <span class="n">gsl_spline_free</span><span class="p">(</span><span class="n">ElectronLookup</span><span class="p">);</span>
  <span class="n">gsl_spline_free</span><span class="p">(</span><span class="n">ProtonLookup</span><span class="p">);</span>
  <span class="n">gsl_spline_free</span><span class="p">(</span><span class="n">TargetPhotonLookup</span><span class="p">);</span>
  <span class="n">BField</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="n">n</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="n">fintbrems</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="n">lintbrems</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="n">fintpp</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="n">lintpp</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="n">fintic</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="n">lintic</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Calculates the differential photon emission at energy &#39;e&#39; [erg]. This results</span>
<span class="cm"> *  in</span>
<span class="cm"> * - differential fluxes, fdiff* [(no. of photons)/(erg*s*cm^2)]</span>
<span class="cm"> * - differential photon rate, fdiff* [(no. of photons)/(erg*s)]</span>
<span class="cm"> *</span>
<span class="cm"> * The * stands for Brems(-strahlung), IC and pp (i.e. pi^0 decay) components.</span>
<span class="cm"> * These quantities are private members.</span>
<span class="cm"> *</span>
<span class="cm"> * It calls the &#39;DifferentialEmissionComponent&#39;</span>
<span class="cm"> * function for the relevant radiation mechanisms:</span>
<span class="cm"> * - protons (&#39;particletype&#39;=1)</span>
<span class="cm"> *   + inelastic p-p scattering</span>
<span class="cm"> * - electrons (&#39;particletype&#39;=0)</span>
<span class="cm"> *   + IC emission</span>
<span class="cm"> *   + Bremsstrahlung</span>
<span class="cm"> *   + Synchrotron radiation</span>
<span class="cm"> *</span>
<span class="cm"> * This function calculates the appropriate (depending on the particle species)</span>
<span class="cm"> * radiation mechanism and their gamma-ray flux by calling</span>
<span class="cm"> * the method &#39;DifferentialEmissionComponent&#39;.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">Radiation</span><span class="o">::</span><span class="n">CalculateDifferentialGammaEmission</span><span class="p">(</span><span class="kt">double</span> <span class="n">e</span><span class="p">,</span> <span class="kt">int</span> <span class="n">particletype</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">ldiffbrems</span> <span class="o">=</span> <span class="n">fdiffbrems</span> <span class="o">=</span> <span class="n">ldiffsynch</span> <span class="o">=</span> <span class="n">fdiffsynch</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="n">ldiffic</span> <span class="o">=</span> <span class="n">fdiffic</span> <span class="o">=</span> <span class="n">ldiffpp</span> <span class="o">=</span> <span class="n">fdiffpp</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>

  <span class="cm">/* Conversion of differential photon rate to flux</span>
<span class="cm">   [ph/(erg*s) -&gt; ph/(erg*s*cm^2)] */</span>
  <span class="kt">double</span> <span class="n">lumtoflux</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">distance</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;### Radiation::CalculateDifferentialGammaEmission: Distance to &quot;</span>
            <span class="s">&quot;particles not specified -&gt; Flux equals now the luminosity! ###&quot;</span>
         <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">lumtoflux</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span>
    <span class="n">lumtoflux</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="mf">4.</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">distance</span> <span class="o">*</span> <span class="n">distance</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">particletype</span> <span class="o">!=</span> <span class="mf">0.</span> <span class="o">&amp;&amp;</span> <span class="n">particletype</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;### Radiation::CalculateDifferentialGammaEmission: Please provide &quot;</span>
            <span class="s">&quot;proper particle spectrum and particle type!  ###&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">particletype</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ElectronVector</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="o">||</span>
      <span class="p">(</span><span class="n">particletype</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ProtonVector</span><span class="p">.</span><span class="n">size</span><span class="p">()))</span> <span class="p">{</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;### Radiation::CalculateDifferentialGammaEmission: No accelerated &quot;</span>
            <span class="s">&quot;particles! Exiting... ###&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">particletype</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ParticleVector</span> <span class="o">=</span> <span class="n">ElectronVector</span><span class="p">;</span>
    <span class="n">radiationMechanism</span> <span class="o">=</span> <span class="s">&quot;Bremsstrahlung&quot;</span><span class="p">;</span>
    <span class="n">ldiffbrems</span> <span class="o">=</span> <span class="n">DifferentialEmissionComponent</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
    <span class="n">fdiffbrems</span> <span class="o">=</span> <span class="n">lumtoflux</span> <span class="o">*</span> <span class="n">ldiffbrems</span><span class="p">;</span>

    <span class="n">radiationMechanism</span> <span class="o">=</span> <span class="s">&quot;InverseCompton&quot;</span><span class="p">;</span>
    <span class="n">ldiffic</span> <span class="o">=</span> <span class="n">DifferentialEmissionComponent</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
    <span class="n">fdiffic</span> <span class="o">=</span> <span class="n">lumtoflux</span> <span class="o">*</span> <span class="n">ldiffic</span><span class="p">;</span>

    <span class="n">radiationMechanism</span> <span class="o">=</span> <span class="s">&quot;Synchrotron&quot;</span><span class="p">;</span>
    <span class="n">ldiffsynch</span> <span class="o">=</span> <span class="n">DifferentialEmissionComponent</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
    <span class="n">fdiffsynch</span> <span class="o">=</span> <span class="n">lumtoflux</span> <span class="o">*</span> <span class="n">ldiffsynch</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">particletype</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ParticleVector</span> <span class="o">=</span> <span class="n">ProtonVector</span><span class="p">;</span>
    <span class="n">radiationMechanism</span> <span class="o">=</span> <span class="s">&quot;ppEmission&quot;</span><span class="p">;</span>
    <span class="n">ldiffpp</span> <span class="o">=</span> <span class="n">DifferentialEmissionComponent</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
    <span class="n">fdiffpp</span> <span class="o">=</span> <span class="n">lumtoflux</span> <span class="o">*</span> <span class="n">ldiffpp</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;### Radiation::CalculateDifferentialGammaEmission: WTF?! That is &quot;</span>
            <span class="s">&quot;not possible!!&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Calculates the integral photon Emission above energy &#39;e&#39; [erg]. This gives</span>
<span class="cm"> * - integral fluxes, fint* [(no. of photons)/(s*cm^2)]</span>
<span class="cm"> * - photon rate, lint* [(no. of photons)/s]</span>
<span class="cm"> *</span>
<span class="cm"> * The * stands for Brems(-strahlung), IC and pp (i.e. pi^0 decay) components.</span>
<span class="cm"> * These quantities are private members.</span>
<span class="cm"> *</span>
<span class="cm"> * It calls the &#39;DifferentialEmissionComponent&#39;</span>
<span class="cm"> * function for the relevant radiation mechanisms:</span>
<span class="cm"> * - protons</span>
<span class="cm"> *   + inelastic p-p scattering</span>
<span class="cm"> * - electrons</span>
<span class="cm"> *   + IC emission</span>
<span class="cm"> *   + Bremsstrahlung</span>
<span class="cm"> *   + Synchrotron radiation</span>
<span class="cm"> *</span>
<span class="cm"> * This function calculates the appropriate (depending on the particle species)</span>
<span class="cm"> * radiation mechanism and their gamma-ray flux by calling</span>
<span class="cm"> * the method &#39;CalculateLuminosityAndFlux&#39; which integrates</span>
<span class="cm"> * &#39;DifferentialEmissionComponent&#39;.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">Radiation</span><span class="o">::</span><span class="n">CalculateIntegralGammaEmission</span><span class="p">(</span><span class="kt">double</span> <span class="n">e</span><span class="p">,</span> <span class="kt">int</span> <span class="n">particletype</span><span class="p">)</span> <span class="p">{</span>

  <span class="n">lintbrems</span> <span class="o">=</span> <span class="n">fintbrems</span> <span class="o">=</span> <span class="n">lintic</span> <span class="o">=</span> <span class="n">fintic</span> <span class="o">=</span> <span class="n">lintpp</span> <span class="o">=</span> <span class="n">fintpp</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">particletype</span> <span class="o">!=</span> <span class="mf">0.</span> <span class="o">&amp;&amp;</span> <span class="n">particletype</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;### Radiation::CalculateIntegratedGammaEmission: Please provide &quot;</span>
            <span class="s">&quot;proper particle spectrum and particle type! ###&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">particletype</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ElectronVector</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="o">||</span>
      <span class="p">(</span><span class="n">particletype</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ProtonVector</span><span class="p">.</span><span class="n">size</span><span class="p">()))</span> <span class="p">{</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;### Radiation::CalculateIntegratedGammaEmission: No accelerated &quot;</span>
            <span class="s">&quot;particles! Exiting... ###&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">particletype</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ParticleVector</span> <span class="o">=</span> <span class="n">ElectronVector</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Radiation::CalculateIntegratedGammaEmission: No ambient density &quot;</span>
              <span class="s">&quot;value set for Bremsstrahlung. Returning zero value.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
      <span class="n">lintbrems</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
      <span class="n">fintbrems</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">CalculateLuminosityAndFlux</span><span class="p">(</span><span class="s">&quot;Bremsstrahlung&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">lintbrems</span><span class="p">,</span> <span class="n">fintbrems</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">CalculateLuminosityAndFlux</span><span class="p">(</span><span class="s">&quot;InverseCompton&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">lintic</span><span class="p">,</span> <span class="n">fintic</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">particletype</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ParticleVector</span> <span class="o">=</span> <span class="n">ProtonVector</span><span class="p">;</span>
    <span class="n">CalculateLuminosityAndFlux</span><span class="p">(</span><span class="s">&quot;ppEmission&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">lintpp</span><span class="p">,</span> <span class="n">fintpp</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;### Radiation::CalculateIntegratedGammaEmission: WTF?! That is &quot;</span>
            <span class="s">&quot;not possible!!&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/**</span>
<span class="cm"> * Calculates the differential photon rate [(no. of photons)/(erg*s)]</span>
<span class="cm"> * at energy &#39;e&#39; [erg] resulting from radiation mechanism</span>
<span class="cm"> * &#39;radiationMechanism&#39; that has been specified before in</span>
<span class="cm"> * &#39;CalculateDifferentialGammaEmission&#39; or &#39;CalculateIntegralGammaEmission&#39;.</span>
<span class="cm"> */</span>
<span class="kt">double</span> <span class="n">Radiation</span><span class="o">::</span><span class="n">DifferentialEmissionComponent</span><span class="p">(</span><span class="kt">double</span> <span class="n">e</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">radiationMechanism</span><span class="p">.</span><span class="n">compare</span><span class="p">(</span><span class="s">&quot;Synchrotron&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
      <span class="n">radiationMechanism</span><span class="p">.</span><span class="n">compare</span><span class="p">(</span><span class="s">&quot;Bremsstrahlung&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
      <span class="n">radiationMechanism</span><span class="p">.</span><span class="n">compare</span><span class="p">(</span><span class="s">&quot;InverseCompton&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
      <span class="n">radiationMechanism</span><span class="p">.</span><span class="n">compare</span><span class="p">(</span><span class="s">&quot;ppEmission&quot;</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;### Radiation::DifferentialEmissionComponent: no valid emission mechanism &quot;</span>
            <span class="s">&quot;specified! Returning 0 value ... ###&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ParticleVector</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;### Radiation::DifferentialEmissionComponent: No accelerated particles! &quot;</span>
            <span class="s">&quot;Exiting... ###&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">e</span> <span class="o">&gt;</span> <span class="n">ParticleVector</span><span class="p">[</span><span class="n">ParticleVector</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="k">return</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">egamma</span> <span class="o">=</span> <span class="n">e</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">emax</span> <span class="o">=</span> <span class="n">ParticleVector</span><span class="p">[</span><span class="n">ParticleVector</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">emin</span> <span class="o">=</span> <span class="n">ParticleVector</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">&lt;</span><span class="n">emin</span><span class="p">)</span> <span class="n">e</span> <span class="o">=</span> <span class="n">emin</span><span class="p">;</span>
  <span class="n">fPointer</span> <span class="n">IntFunc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">radiationMechanism</span><span class="p">.</span><span class="n">compare</span><span class="p">(</span><span class="s">&quot;Synchrotron&quot;</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">BField</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Radiation::DifferentialEmissionComponent: No BField value set for &quot;</span>
              <span class="s">&quot;Synchrotron radiation. Returning zero value.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
      <span class="k">return</span> <span class="mf">0.</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SynchModel</span><span class="p">)</span>
      <span class="n">IntFunc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Radiation</span><span class="o">::</span><span class="n">SynchEmissivity</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">SynchModel</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
      <span class="n">IntFunc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Radiation</span><span class="o">::</span><span class="n">SynchEmissivityExplicit</span><span class="p">;</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Radiation::DifferentialEmissionComponent: Specify valid Synchrotron &quot;</span>
              <span class="s">&quot;emission model. 0 - random B-Field, 1 - regular B-Field with 90 &quot;</span>
              <span class="s">&quot;degree electron-BField pitch angle. Returning zero value.&quot;</span>
           <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
      <span class="k">return</span> <span class="mf">0.</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">radiationMechanism</span><span class="p">.</span><span class="n">compare</span><span class="p">(</span><span class="s">&quot;Bremsstrahlung&quot;</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Radiation::DifferentialEmissionComponent: No ambient density value set &quot;</span>
              <span class="s">&quot;for Bremsstrahlung. Returning zero value.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
      <span class="k">return</span> <span class="mf">0.</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">IntFunc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Radiation</span><span class="o">::</span><span class="n">BremsEmissivity</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">radiationMechanism</span><span class="p">.</span><span class="n">compare</span><span class="p">(</span><span class="s">&quot;InverseCompton&quot;</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">TargetPhotonVector</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Radiation::DifferentialEmissionComponent: No radiation fields set for IC &quot;</span>
              <span class="s">&quot;emission. Returning zero value.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
      <span class="k">return</span> <span class="mf">0.</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">IntFunc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Radiation</span><span class="o">::</span><span class="n">ICEmissivityRadFieldIntegrated</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">radiationMechanism</span><span class="p">.</span><span class="n">compare</span><span class="p">(</span><span class="s">&quot;ppEmission&quot;</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Radiation::DifferentialEmissionComponent: No ambient density value set &quot;</span>
              <span class="s">&quot;for p-p scattering. Returning zero value.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
      <span class="k">return</span> <span class="mf">0.</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">IntFunc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Radiation</span><span class="o">::</span><span class="n">PPEmissivity</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span>
    <span class="k">return</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="n">gsl_interp_accel_reset</span><span class="p">(</span><span class="n">acc</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">gammas</span> <span class="o">=</span> <span class="n">Integrate</span><span class="p">(</span><span class="n">IntFunc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">egamma</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">emax</span><span class="p">,</span> <span class="n">integratorTolerance</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">isnan</span><span class="p">(</span><span class="n">gammas</span><span class="p">))</span> <span class="k">return</span> <span class="mf">0.</span><span class="p">;</span>

  <span class="k">return</span> <span class="n">gammas</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Calculates</span>
<span class="cm"> * - f: integrated flux [(no. of photons)/(s*cm^2)] and</span>
<span class="cm"> * - l: photon rate [(no. of photons)/s]</span>
<span class="cm"> *</span>
<span class="cm"> * above energy &#39;e&#39; [erg].</span>
<span class="cm"> *</span>
<span class="cm"> * This method integrates the &#39;DifferentialEmissionComponent&#39; method</span>
<span class="cm"> * for the relevant radiation mechanisms:</span>
<span class="cm"> * - protons</span>
<span class="cm"> *   + inelastic p-p scattering</span>
<span class="cm"> * - electrons</span>
<span class="cm"> *   + IC emission</span>
<span class="cm"> *   + Bremsstrahlung</span>
<span class="cm"> *   + Synchrotron radiation</span>
<span class="cm"> *</span>
<span class="cm"> * The integration boundaries are {e,maximum particle energy}, where the</span>
<span class="cm"> * maximum particle energy is automatically determined from the</span>
<span class="cm"> * &#39;ParticleVector&#39; vector.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">Radiation</span><span class="o">::</span><span class="n">CalculateLuminosityAndFlux</span><span class="p">(</span><span class="n">string</span> <span class="n">mechanism</span><span class="p">,</span> <span class="kt">double</span> <span class="n">e</span><span class="p">,</span>
                                           <span class="kt">double</span> <span class="o">&amp;</span><span class="n">l</span><span class="p">,</span> <span class="kt">double</span> <span class="o">&amp;</span><span class="n">f</span><span class="p">)</span> <span class="p">{</span>

  <span class="kt">double</span> <span class="n">lumtoflux</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">emingamma</span> <span class="o">=</span> <span class="n">e</span><span class="p">;</span>
  <span class="cm">/* if no distance is provided, Luminosity and Flux are treated as</span>
<span class="cm">   * being the same */</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">distance</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;### Radiation::CalculateLuminosityAndFlux: Distance to particles &quot;</span>
            <span class="s">&quot;not specified -&gt; Flux equals now the luminosity! ###&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">lumtoflux</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span>
    <span class="n">lumtoflux</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="mf">4.</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">distance</span> <span class="o">*</span> <span class="n">distance</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ParticleVector</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;### Radiation::CalculateLuminosityAndFlux: No accelerated &quot;</span>
            <span class="s">&quot;particles! Exiting... ###&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">l</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
    <span class="n">f</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kt">double</span> <span class="n">emax</span> <span class="o">=</span> <span class="n">ParticleVector</span><span class="p">[</span><span class="n">ParticleVector</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">e</span> <span class="o">&gt;=</span> <span class="mf">0.99999</span> <span class="o">*</span> <span class="n">emax</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">l</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
    <span class="n">f</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">radiationMechanism</span> <span class="o">=</span> <span class="n">mechanism</span><span class="p">;</span>
  <span class="n">fPointer</span> <span class="n">IntFunc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Radiation</span><span class="o">::</span><span class="n">DifferentialEmissionComponent</span><span class="p">;</span>

  <span class="n">l</span> <span class="o">=</span> <span class="n">Integrate</span><span class="p">(</span><span class="n">IntFunc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">emingamma</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">emax</span><span class="p">,</span> <span class="n">integratorTolerance</span><span class="p">);</span>
  <span class="n">f</span> <span class="o">=</span> <span class="n">lumtoflux</span> <span class="o">*</span> <span class="n">l</span><span class="p">;</span>

  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/********* RADIATION MECHANISMS ***********************************/</span>

<span class="cm">/* Inverse Compton part */</span>

<span class="cm">/**</span>
<span class="cm"> * Describes grey body with temperature &#39;temp&#39; [K] and energy density</span>
<span class="cm"> * &#39;edens&#39; [erg/cm^3] and returns differential photon</span>
<span class="cm"> * density [(no of photons)/(cm^3*erg)] at energy &#39;ephoton&#39; [erg].</span>
<span class="cm"> */</span>
<span class="kt">double</span> <span class="n">Radiation</span><span class="o">::</span><span class="n">GreyBody</span><span class="p">(</span><span class="kt">double</span> <span class="n">ephoton</span><span class="p">,</span> <span class="kt">double</span> <span class="n">temp</span><span class="p">,</span> <span class="kt">double</span> <span class="n">edens</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="mf">15.</span> <span class="o">*</span> <span class="n">edens</span> <span class="o">*</span> <span class="n">pow</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.</span><span class="p">)</span> <span class="o">*</span> <span class="n">pow</span><span class="p">(</span><span class="n">kb</span> <span class="o">*</span> <span class="n">temp</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.</span><span class="p">)</span> <span class="o">*</span>
                        <span class="n">pow</span><span class="p">(</span><span class="n">ephoton</span><span class="p">,</span> <span class="mf">2.</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">exp</span><span class="p">(</span><span class="n">ephoton</span> <span class="o">/</span> <span class="p">(</span><span class="n">kb</span> <span class="o">*</span> <span class="n">temp</span><span class="p">))</span> <span class="o">-</span> <span class="mf">1.</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * IC emission from electrons integrated over the target photon population.</span>
<span class="cm"> * This method has the switch INTEGRATEOVERGAMMAS, which determines its</span>
<span class="cm"> * output. If INTEGRATEOVERGAMMAS is set to</span>
<span class="cm"> *</span>
<span class="cm"> * - TRUE: method returns a photon production rate [(no. of photons)/s] at</span>
<span class="cm"> *         energy &#39;egamma&#39;. It is used to calculate the total loss rate due to</span>
<span class="cm"> *         IC emission for single electrons of energy &#39;eelectrons&#39; by</span>
<span class="cm"> *         integrating this production rate from a (hardcoded) minimum energy of</span>
<span class="cm"> *         1.e-10 eV  up to energy &#39;eelectrons&#39;.</span>
<span class="cm"> *         This is done in the method &#39;CreateICLossLookup&#39;.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * - FALSE: method returns a differential production rate of photons</span>
<span class="cm"> *          [(no. of photons)/(erg*s)] with energy &#39;egamma&#39; from the</span>
<span class="cm"> *          differential number of electrons at energy &#39;eelectron&#39;, which is</span>
<span class="cm"> *          then used to calculate the total IC gamma-ray emission at photon</span>
<span class="cm"> *          energy egamma from the total electron distribution. The</span>
<span class="cm"> *          corresponding integration is performed from the minimum electron</span>
<span class="cm"> *          energy to egamma and is implemented in the method</span>
<span class="cm"> *          &#39;DifferentialEmissionComponent&#39;</span>
<span class="cm"> */</span>
<span class="kt">double</span> <span class="n">Radiation</span><span class="o">::</span><span class="n">ICEmissivityRadFieldIntegrated</span><span class="p">(</span><span class="kt">double</span> <span class="n">x</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span> <span class="p">{</span>
  <span class="cm">/* energy of scattering electron */</span>
  <span class="kt">double</span> <span class="n">eelectron</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="cm">/* energy of gamma ray */</span>
  <span class="kt">double</span> <span class="n">egamma</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="cm">/* number of gamma rays @ egamma */</span>
  <span class="kt">double</span> <span class="n">icgammas</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>

  <span class="cm">/* change mode of this function by switching par and x. */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">INTEGRATEOVERGAMMAS</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">eelectron</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">double</span> <span class="o">*</span><span class="p">)</span><span class="n">par</span><span class="p">;</span>
    <span class="n">egamma</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">eelectron</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
    <span class="n">egamma</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">double</span> <span class="o">*</span><span class="p">)</span><span class="n">par</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">gsl_interp_accel_reset</span><span class="p">(</span><span class="n">acc</span><span class="p">);</span>
  <span class="n">fPointer</span> <span class="n">IntFunc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Radiation</span><span class="o">::</span><span class="n">ICEmissivity</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">xpars</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">eelectron</span><span class="p">,</span> <span class="n">egamma</span><span class="p">};</span>

  <span class="cm">/* detemine integration boundaries for the target photon energy from Eq. 2.50</span>
<span class="cm">     in Blumenthal&amp;Gould (Reviews of Modern Physics, vol. 42, no. 2, 1970) */</span>
  <span class="kt">double</span> <span class="n">lorentz</span> <span class="o">=</span> <span class="p">(</span><span class="n">eelectron</span> <span class="o">+</span> <span class="n">m_e</span><span class="p">)</span> <span class="o">/</span> <span class="n">m_e</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">edash</span> <span class="o">=</span> <span class="n">egamma</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">egamma</span> <span class="o">/</span> <span class="p">(</span><span class="n">lorentz</span> <span class="o">*</span> <span class="n">m_e</span><span class="p">));</span>
  <span class="kt">double</span> <span class="n">k</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="mf">4.</span> <span class="o">*</span> <span class="n">lorentz</span> <span class="o">*</span> <span class="n">lorentz</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">boundmin</span><span class="p">,</span> <span class="n">boundmax</span><span class="p">;</span>
  <span class="p">(</span><span class="n">edash</span> <span class="o">*</span><span class="n">k</span> <span class="o">&lt;</span> <span class="n">targetphotonenergymin</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">boundmin</span> <span class="o">=</span> <span class="n">targetphotonenergymin</span><span class="p">)</span>
                                     <span class="o">:</span> <span class="n">boundmin</span> <span class="o">=</span> <span class="n">edash</span> <span class="o">*</span> <span class="n">k</span><span class="p">;</span>
  <span class="p">(</span><span class="n">edash</span> <span class="o">&gt;</span> <span class="n">targetphotonenergymax</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">boundmax</span> <span class="o">=</span> <span class="n">targetphotonenergymax</span><span class="p">)</span>
                                  <span class="o">:</span> <span class="n">boundmax</span> <span class="o">=</span> <span class="n">edash</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">&gt;</span> <span class="mf">0.1</span> <span class="o">||</span> <span class="n">boundmin</span> <span class="o">&gt;=</span> <span class="n">boundmax</span><span class="p">)</span> <span class="k">return</span> <span class="mf">0.</span><span class="p">;</span>

  <span class="n">icgammas</span> <span class="o">=</span> <span class="n">Integrate</span><span class="p">(</span><span class="n">IntFunc</span><span class="p">,</span> <span class="n">xpars</span><span class="p">,</span> <span class="n">boundmin</span><span class="p">,</span> <span class="n">boundmax</span><span class="p">,</span> <span class="n">integratorTolerance</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">isnan</span><span class="p">(</span><span class="n">icgammas</span><span class="p">)</span> <span class="o">||</span> <span class="n">std</span><span class="o">::</span><span class="n">isinf</span><span class="p">(</span><span class="n">icgammas</span><span class="p">))</span> <span class="k">return</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">INTEGRATEOVERGAMMAS</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">icgammas</span> <span class="o">*</span> <span class="n">egamma</span><span class="p">;</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="n">gsl_interp_accel_reset</span><span class="p">(</span><span class="n">acc</span><span class="p">);</span>
    <span class="kt">double</span> <span class="n">elnumber</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">EvalSpline</span><span class="p">(</span><span class="n">log10</span><span class="p">(</span><span class="n">eelectron</span><span class="p">),</span><span class="n">ElectronLookup</span><span class="p">,</span><span class="n">acc</span>
                                  <span class="p">,</span><span class="n">__func__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">);</span>
    <span class="n">icgammas</span> <span class="o">*=</span> <span class="n">pow</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="n">elnumber</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">icgammas</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * emissivity from IC scattering. Taken from Blumenthal and Gould 1970,</span>
<span class="cm"> * Eq(2.48).</span>
<span class="cm"> */</span>
<span class="kt">double</span> <span class="n">Radiation</span><span class="o">::</span><span class="n">ICEmissivity</span><span class="p">(</span><span class="kt">double</span> <span class="n">x</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">double</span> <span class="n">ephoton</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>  <span class="c1">///&lt; energy of the target photon</span>
  <span class="kt">double</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">double</span> <span class="o">*</span><span class="p">)</span><span class="n">par</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">lorentz</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">m_e</span><span class="p">)</span> <span class="o">/</span> <span class="n">m_e</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">egamma</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>  <span class="c1">///&lt; energy of the resulting gamma photon</span>
  <span class="kt">double</span> <span class="n">e1</span> <span class="o">=</span> <span class="n">egamma</span> <span class="o">/</span> <span class="p">(</span><span class="n">lorentz</span> <span class="o">*</span> <span class="n">m_e</span><span class="p">);</span>  <span class="c1">///&lt; gamma-ray energy in units of the</span>
                                         <span class="c1">///electron energy</span>
  <span class="kt">double</span> <span class="n">gamma</span> <span class="o">=</span> <span class="mf">4.</span> <span class="o">*</span> <span class="n">ephoton</span> <span class="o">*</span> <span class="n">lorentz</span> <span class="o">/</span> <span class="n">m_e</span><span class="p">;</span>  <span class="c1">///&lt; parameter that describes</span>
                                                <span class="c1">///the regime of the scattering</span>
                                                <span class="c1">///process. Small value: Thomson</span>
                                                <span class="c1">///regime, large: KN-regime</span>
  <span class="kt">double</span> <span class="n">q</span> <span class="o">=</span> <span class="n">e1</span> <span class="o">/</span> <span class="p">(</span><span class="n">gamma</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">e1</span><span class="p">));</span>  <span class="c1">///&lt; yet another parameter telling us</span>
                                        <span class="c1">///the scattering domain</span>
  <span class="c1">/// Eq(2.48):</span>
  <span class="kt">double</span> <span class="n">bracket</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="n">log</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">q</span><span class="p">)</span>
                   <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">q</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">q</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">targetphotons</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">EvalSpline</span><span class="p">(</span><span class="n">log10</span><span class="p">(</span><span class="n">ephoton</span><span class="p">),</span><span class="n">TargetPhotonLookup</span><span class="p">,</span>
                                            <span class="n">acc</span><span class="p">,</span><span class="n">__func__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">integrand</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">pow</span><span class="p">(</span><span class="n">e_radius</span><span class="p">,</span> <span class="mf">2.</span><span class="p">)</span> <span class="o">*</span> <span class="n">m_e</span> <span class="o">*</span> <span class="n">c_speed</span> <span class="o">/</span> <span class="n">lorentz</span> <span class="o">*</span>
                     <span class="n">pow</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="n">targetphotons</span><span class="p">)</span> <span class="o">/</span> <span class="n">ephoton</span> <span class="o">*</span> <span class="n">bracket</span><span class="p">;</span>

  <span class="n">integrand</span> <span class="o">/=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="k">return</span> <span class="n">integrand</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/** return a lookup table holding the differential electron energy loss rate due</span>
<span class="cm"> * to inverse-Compton</span>
<span class="cm"> *  scattering. The format of the lookup is: { Energy(erg) - Energy Loss Rate</span>
<span class="cm"> * from IC scattering(erg/s) }</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">Radiation</span><span class="o">::</span><span class="n">CreateICLossLookup</span><span class="p">(</span><span class="kt">int</span> <span class="n">bins</span><span class="p">)</span> <span class="p">{</span>

  <span class="n">INTEGRATEOVERGAMMAS</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">Clear2DVector</span><span class="p">(</span><span class="n">ICLossLookup</span><span class="p">);</span>
  <span class="cm">/* lower integration boundary over emitted (i.e. &#39;loss-&#39;) IC photons */</span>
  <span class="kt">double</span> <span class="n">EGammaMin</span> <span class="o">=</span> <span class="mf">1.e-22</span> <span class="o">*</span> <span class="n">TeV_to_erg</span><span class="p">;</span>
  <span class="cm">/* Upper integration boundary over emitted (i.e. &#39;loss-&#39;) IC photons */</span>
  <span class="kt">double</span> <span class="n">EGammaMax</span> <span class="o">=</span> <span class="mf">1.e7</span> <span class="o">*</span> <span class="n">TeV_to_erg</span><span class="p">;</span>
  <span class="cm">/* lower integration boundary for the IC loss lookup (i.e. here simply the</span>
<span class="cm">   * electron rest mass) */</span>
  <span class="kt">double</span> <span class="n">logemin</span> <span class="o">=</span> <span class="n">log10</span><span class="p">(</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">m_e</span><span class="p">);</span>
  <span class="cm">/* upper integration boundary for the IC loss lookup */</span>
  <span class="kt">double</span> <span class="n">logemax</span> <span class="o">=</span> <span class="n">log10</span><span class="p">(</span><span class="n">EGammaMax</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">logestep</span> <span class="o">=</span> <span class="p">(</span><span class="kt">double</span><span class="p">)(</span><span class="n">logemax</span> <span class="o">-</span> <span class="n">logemin</span><span class="p">)</span> <span class="o">/</span> <span class="n">bins</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">tt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">ii</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">QUIETMODE</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;&gt;&gt; CALCULATING IC LOSS LOOKUP &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">double</span> <span class="n">loge</span> <span class="o">=</span> <span class="n">logemin</span><span class="p">;</span> <span class="n">loge</span> <span class="o">&lt;</span> <span class="n">logemax</span><span class="p">;</span> <span class="n">loge</span> <span class="o">+=</span> <span class="n">logestep</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">((</span><span class="kt">double</span><span class="p">)</span><span class="n">ii</span> <span class="o">/</span> <span class="n">bins</span> <span class="o">&gt;</span> <span class="mf">0.0001</span> <span class="o">*</span> <span class="n">tt</span> <span class="o">&amp;&amp;</span> <span class="n">QUIETMODE</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">;</span>
      <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;    &quot;</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="mf">100.</span> <span class="o">*</span> <span class="n">ii</span> <span class="o">/</span> <span class="n">bins</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;\% done&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">flush</span><span class="p">;</span>
      <span class="n">tt</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">ii</span><span class="o">++</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">LossRate</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">Emax</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="n">loge</span><span class="p">);</span>
    <span class="kt">double</span> <span class="n">Eelectron</span> <span class="o">=</span> <span class="n">Emax</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Emax</span> <span class="o">&gt;</span> <span class="mf">0.001</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">fPointer</span> <span class="n">IntFunc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Radiation</span><span class="o">::</span><span class="n">ICEmissivityRadFieldIntegrated</span><span class="p">;</span>
      <span class="n">LossRate</span> <span class="o">=</span>
          <span class="n">Integrate</span><span class="p">(</span><span class="n">IntFunc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Eelectron</span><span class="p">,</span> <span class="n">EGammaMin</span><span class="p">,</span> <span class="n">Emax</span><span class="p">,</span> <span class="n">integratorTolerance</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="kt">double</span> <span class="n">gamma</span> <span class="o">=</span> <span class="p">(</span><span class="n">Emax</span> <span class="o">+</span> <span class="n">m_e</span><span class="p">)</span> <span class="o">/</span> <span class="n">m_e</span><span class="p">;</span>
      <span class="n">LossRate</span> <span class="o">=</span>
          <span class="p">(</span><span class="mf">4.</span> <span class="o">/</span> <span class="mf">3.</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma_T</span> <span class="o">*</span> <span class="n">c_speed</span> <span class="o">*</span> <span class="n">TargetPhotonEdens</span> <span class="o">*</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">gamma</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">isnan</span><span class="p">(</span><span class="n">LossRate</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">__func__</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,l.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">__LINE__</span> <span class="o">&lt;&lt;</span><span class="s">&quot;: LossRate is nan! Exiting.&quot;</span>
           <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
      <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">TwoDVectorPushBack</span><span class="p">(</span><span class="n">Eelectron</span><span class="p">,</span><span class="n">LossRate</span><span class="p">,</span><span class="n">ICLossLookup</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">INTEGRATEOVERGAMMAS</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">QUIETMODE</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;    -&gt; DONE!   &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;&gt;&gt; CALCULATING OF IC LOSS LOOKUP COMPLETE &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* end of Inverse Compton part */</span>

<span class="cm">/* SYNCHROTRON PART */</span>
<span class="cm">/**</span>
<span class="cm"> * modified bessel functions</span>
<span class="cm"> */</span>
<span class="kt">double</span> <span class="n">Radiation</span><span class="o">::</span><span class="n">K</span><span class="p">(</span><span class="kt">double</span> <span class="n">nu</span><span class="p">,</span> <span class="kt">double</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="mf">0.</span> <span class="o">||</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mf">700.</span><span class="p">)</span>
    <span class="k">return</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="k">else</span>
    <span class="k">return</span> <span class="nf">gsl_sf_bessel_Knu</span><span class="p">(</span><span class="n">nu</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">double</span> <span class="n">Radiation</span><span class="o">::</span><span class="n">K_53</span><span class="p">(</span><span class="kt">double</span> <span class="n">x</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span> <span class="p">{</span>
<span class="c1">//  double pp = *(double *)par;</span>
  <span class="kt">double</span> <span class="n">K_4</span> <span class="o">=</span> <span class="n">K</span><span class="p">(</span><span class="mf">5.</span> <span class="o">/</span> <span class="mf">3.</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">K_4</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * emissivity of synchrotron radiation</span>
<span class="cm"> * adapted from galprop!ghisellini svensson 1988 &#39;the synchrotron boiler&#39;</span>
<span class="cm"> */</span>
<span class="kt">double</span> <span class="n">Radiation</span><span class="o">::</span><span class="n">SynchEmissivity</span><span class="p">(</span><span class="kt">double</span> <span class="n">x</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span> <span class="p">{</span>
  <span class="cm">/* frequency of emmited synchr. radiation */</span>
  <span class="kt">double</span> <span class="n">nu</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">double</span> <span class="o">*</span><span class="p">)</span><span class="n">par</span> <span class="o">/</span> <span class="n">hp</span><span class="p">;</span>
  <span class="cm">/* electron energy */</span>
  <span class="kt">double</span> <span class="n">eElectron</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
  <span class="cm">/* lorentz-factor of electrons */</span>
  <span class="kt">double</span> <span class="n">gamma</span> <span class="o">=</span> <span class="p">(</span><span class="n">eElectron</span> <span class="o">+</span> <span class="n">m_e</span><span class="p">)</span> <span class="o">/</span> <span class="n">m_e</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">nu_b</span> <span class="o">=</span> <span class="n">el_charge</span> <span class="o">*</span> <span class="n">BField</span> <span class="o">*</span> <span class="n">c_speed</span> <span class="o">*</span> <span class="n">pow</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">m_e</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">j</span> <span class="o">=</span> <span class="n">nu</span> <span class="o">/</span> <span class="p">(</span><span class="mf">3.</span> <span class="o">*</span> <span class="n">nu_b</span> <span class="o">*</span> <span class="n">pow</span><span class="p">(</span><span class="n">gamma</span><span class="p">,</span> <span class="mf">2.</span><span class="p">));</span>
  <span class="cm">/* bessel fct. K_1/3 */</span>
  <span class="kt">double</span> <span class="n">K_1</span> <span class="o">=</span> <span class="n">K</span><span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="mf">3.</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
  <span class="cm">/* bessel fct. K_4/3 */</span>
  <span class="kt">double</span> <span class="n">K_4</span> <span class="o">=</span> <span class="n">K</span><span class="p">(</span><span class="mf">4.</span> <span class="o">/</span> <span class="mf">3.</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">value</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">nu</span> <span class="o">&lt;</span> <span class="n">nu_b</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">value</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="kt">double</span> <span class="n">electrons</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">EvalSpline</span><span class="p">(</span><span class="n">log10</span><span class="p">(</span><span class="n">eElectron</span><span class="p">),</span><span class="n">ElectronLookup</span><span class="p">,</span>
                             <span class="n">acc</span><span class="p">,</span><span class="n">__func__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">);</span>
    <span class="n">value</span> <span class="o">=</span> <span class="mf">4.</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">sqrt</span><span class="p">(</span><span class="mf">3.</span><span class="p">)</span> <span class="o">*</span> <span class="n">el_charge</span> <span class="o">*</span> <span class="n">el_charge</span> <span class="o">*</span> <span class="n">nu_b</span> <span class="o">/</span>
            <span class="p">(</span><span class="n">hp</span> <span class="o">*</span> <span class="n">hp</span> <span class="o">*</span> <span class="n">nu</span> <span class="o">*</span> <span class="n">c_speed</span><span class="p">);</span>
    <span class="n">value</span> <span class="o">*=</span> <span class="n">pow</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="n">electrons</span><span class="p">)</span> <span class="o">*</span> <span class="n">pow</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="mf">2.</span><span class="p">);</span>
    <span class="n">value</span> <span class="o">*=</span> <span class="p">(</span><span class="n">K_4</span> <span class="o">*</span> <span class="n">K_1</span> <span class="o">-</span> <span class="p">(</span><span class="mf">3.</span> <span class="o">/</span> <span class="mf">5.</span><span class="p">)</span> <span class="o">*</span> <span class="n">j</span> <span class="o">*</span> <span class="p">(</span><span class="n">K_4</span> <span class="o">+</span> <span class="n">K_1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">K_4</span> <span class="o">-</span> <span class="n">K_1</span><span class="p">));</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * emissivity of synchrotron radiation</span>
<span class="cm"> * adapted from galprop!ghisellini svensson 1988 &#39;the synchrotron boiler&#39;</span>
<span class="cm"> */</span>
<span class="kt">double</span> <span class="n">Radiation</span><span class="o">::</span><span class="n">SynchEmissivityExplicit</span><span class="p">(</span><span class="kt">double</span> <span class="n">e</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span> <span class="p">{</span>

  <span class="kt">double</span> <span class="n">eElectron</span> <span class="o">=</span> <span class="n">e</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">gamma</span> <span class="o">=</span> <span class="p">(</span><span class="n">eElectron</span> <span class="o">+</span> <span class="n">m_e</span><span class="p">)</span> <span class="o">/</span> <span class="n">m_e</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">nu</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">double</span> <span class="o">*</span><span class="p">)</span><span class="n">par</span> <span class="o">/</span> <span class="n">hp</span><span class="p">;</span>

  <span class="kt">double</span> <span class="n">norm</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="mf">3.</span><span class="p">)</span> <span class="o">*</span> <span class="n">el_charge</span> <span class="o">*</span> <span class="n">el_charge</span> <span class="o">*</span> <span class="n">el_charge</span> <span class="o">*</span> <span class="n">BField</span> <span class="o">/</span> <span class="n">m_e</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">nu_c</span> <span class="o">=</span>
      <span class="mf">3.</span> <span class="o">*</span> <span class="n">el_charge</span> <span class="o">*</span> <span class="n">BField</span> <span class="o">*</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">c_speed</span> <span class="o">/</span> <span class="p">(</span><span class="mf">4.</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">m_e</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">x</span> <span class="o">=</span> <span class="n">nu</span> <span class="o">/</span> <span class="n">nu_c</span><span class="p">;</span>

  <span class="n">fPointer</span> <span class="n">IntFunc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Radiation</span><span class="o">::</span><span class="n">K_53</span><span class="p">;</span>
  <span class="kt">double</span> <span class="o">*</span><span class="n">v</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">F</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">Integrate</span><span class="p">(</span><span class="n">IntFunc</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mf">1.e2</span> <span class="o">*</span> <span class="n">x</span><span class="p">,</span> <span class="n">integratorTolerance</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">electrons</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">EvalSpline</span><span class="p">(</span><span class="n">log10</span><span class="p">(</span><span class="n">eElectron</span><span class="p">),</span><span class="n">ElectronLookup</span><span class="p">,</span>
                                        <span class="n">acc</span><span class="p">,</span><span class="n">__func__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">val</span> <span class="o">=</span> <span class="n">norm</span> <span class="o">*</span> <span class="n">F</span> <span class="o">*</span> <span class="n">pow</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="n">electrons</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">hp</span> <span class="o">*</span> <span class="n">hp</span> <span class="o">*</span> <span class="n">nu</span><span class="p">);</span>

  <span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* End of the Synchrotron part */</span>

<span class="cm">/* ---       BREMSSTRAHLUNG   --- */</span>
<span class="cm">/** emissivity of Bremsstrahlung,</span>
<span class="cm"> * proton-electron as well as electron-electron</span>
<span class="cm"> * From Baring 1999, ApJ, 513, 311-338</span>
<span class="cm"> */</span>
<span class="kt">double</span> <span class="n">Radiation</span><span class="o">::</span><span class="n">BremsEmissivity</span><span class="p">(</span><span class="kt">double</span> <span class="n">x</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span> <span class="p">{</span>
  <span class="cm">/* initial electron energy */</span>
  <span class="kt">double</span> <span class="n">EI</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
  <span class="cm">/* bremsstrahlung photon energy */</span>
  <span class="kt">double</span> <span class="n">EP</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">double</span> <span class="o">*</span><span class="p">)</span><span class="n">par</span><span class="p">;</span>
  <span class="cm">/* threshold put by hand */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">EP</span> <span class="o">&lt;</span> <span class="mf">1.e-12</span> <span class="o">*</span> <span class="n">EI</span><span class="p">)</span> <span class="k">return</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="cm">/* kinematic threshold */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">EI</span> <span class="o">-</span> <span class="n">EP</span> <span class="o">&lt;=</span> <span class="n">m_e</span><span class="p">)</span> <span class="k">return</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="cm">/* electron lorentz factor */</span>
  <span class="kt">double</span> <span class="n">g</span> <span class="o">=</span> <span class="p">(</span><span class="n">EI</span> <span class="o">+</span> <span class="n">m_e</span><span class="p">)</span> <span class="o">/</span> <span class="n">m_e</span><span class="p">;</span>
  <span class="cm">/* electron velocity */</span>
  <span class="kt">double</span> <span class="n">b</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="n">g</span> <span class="o">*</span> <span class="n">g</span><span class="p">));</span>
  <span class="cm">/* photon energy in units of electron rest mass */</span>
  <span class="kt">double</span> <span class="n">e</span> <span class="o">=</span> <span class="n">EP</span> <span class="o">/</span> <span class="n">m_e</span><span class="p">;</span>
  <span class="cm">/* equation (A1) */</span>
  <span class="kt">double</span> <span class="n">sigma_e</span> <span class="o">=</span> <span class="p">(</span><span class="n">sigma1</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="o">+</span> <span class="n">sigma2</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span> <span class="o">*</span> <span class="n">A</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
  <span class="cm">/* 1.4 correction factor for 10% Helium */</span>
  <span class="kt">double</span> <span class="n">S</span> <span class="o">=</span> <span class="n">n</span> <span class="o">*</span> <span class="mf">1.4</span><span class="p">;</span>
  <span class="cm">/* emissivity assuming a fully ionised plasma (n_e = S), Eq. (27) */</span>
  <span class="kt">double</span> <span class="n">N</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">EI</span> <span class="o">&lt;</span> <span class="mf">2.e-3</span> <span class="o">*</span> <span class="n">GeV_to_erg</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">c_speed</span> <span class="o">*</span> <span class="n">b</span> <span class="o">*</span> <span class="n">S</span> <span class="o">*</span> <span class="p">(</span><span class="n">sigma1</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="o">+</span> <span class="n">sigmaNR</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">e</span><span class="p">));</span>
  <span class="k">else</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">c_speed</span> <span class="o">*</span> <span class="n">b</span> <span class="o">*</span> <span class="n">S</span> <span class="o">*</span> <span class="p">(</span><span class="n">sigma1</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="o">+</span> <span class="n">sigma_e</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">electrons</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">EvalSpline</span><span class="p">(</span><span class="n">log10</span><span class="p">(</span><span class="n">EI</span><span class="p">),</span><span class="n">ElectronLookup</span><span class="p">,</span>
                                        <span class="n">acc</span><span class="p">,</span><span class="n">__func__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">N</span> <span class="o">*</span> <span class="n">pow</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="n">electrons</span><span class="p">)</span> <span class="o">/</span> <span class="n">m_e</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/** equation (A4)</span>
<span class="cm">  */</span>
<span class="kt">double</span> <span class="n">Radiation</span><span class="o">::</span><span class="n">A</span><span class="p">(</span><span class="kt">double</span> <span class="n">g</span><span class="p">,</span> <span class="kt">double</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="mf">1.</span> <span class="o">-</span> <span class="p">(</span><span class="mf">8.</span> <span class="o">/</span> <span class="mf">3.</span><span class="p">)</span> <span class="o">*</span> <span class="n">pow</span><span class="p">(</span><span class="n">g</span> <span class="o">-</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">g</span> <span class="o">+</span> <span class="mf">1.</span><span class="p">)</span> <span class="o">*</span> <span class="n">pow</span><span class="p">(</span><span class="n">e</span> <span class="o">/</span> <span class="n">g</span><span class="p">,</span> <span class="mf">0.3333</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/** equation (A2)</span>
<span class="cm"> */</span>
<span class="kt">double</span> <span class="n">Radiation</span><span class="o">::</span><span class="n">sigma1</span><span class="p">(</span><span class="kt">double</span> <span class="n">g</span><span class="p">,</span> <span class="kt">double</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span><span class="mf">4.</span> <span class="o">*</span> <span class="n">e_radius</span> <span class="o">*</span> <span class="n">e_radius</span> <span class="o">*</span> <span class="n">fineStructConst</span> <span class="o">/</span> <span class="n">e</span><span class="p">)</span> <span class="o">*</span>
         <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.3333</span> <span class="o">*</span> <span class="o">-</span><span class="n">e</span> <span class="o">/</span> <span class="n">g</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">e</span> <span class="o">/</span> <span class="n">g</span><span class="p">))</span> <span class="o">*</span>
         <span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">g</span> <span class="o">*</span> <span class="p">(</span><span class="n">g</span> <span class="o">-</span> <span class="n">e</span><span class="p">)</span> <span class="o">/</span> <span class="n">e</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/** equation (A3)</span>
<span class="cm"> */</span>
<span class="kt">double</span> <span class="n">Radiation</span><span class="o">::</span><span class="n">sigma2</span><span class="p">(</span><span class="kt">double</span> <span class="n">g</span><span class="p">,</span> <span class="kt">double</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">double</span> <span class="n">k</span> <span class="o">=</span> <span class="n">e_radius</span> <span class="o">*</span> <span class="n">e_radius</span> <span class="o">*</span> <span class="n">fineStructConst</span> <span class="o">/</span> <span class="p">(</span><span class="mf">3.</span> <span class="o">*</span> <span class="n">e</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">e</span> <span class="o">&lt;=</span> <span class="mf">.5</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">k</span> <span class="o">*</span> <span class="p">(</span><span class="mf">16.</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">e</span> <span class="o">+</span> <span class="n">e</span> <span class="o">*</span> <span class="n">e</span><span class="p">)</span> <span class="o">*</span> <span class="n">log</span><span class="p">(</span><span class="n">g</span> <span class="o">/</span> <span class="n">e</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="n">e</span> <span class="o">*</span> <span class="n">e</span><span class="p">)</span> <span class="o">+</span> <span class="mf">3.</span> <span class="o">/</span> <span class="n">e</span> <span class="o">-</span>
                <span class="mf">4.</span> <span class="o">+</span> <span class="mf">4.</span> <span class="o">*</span> <span class="n">e</span> <span class="o">-</span> <span class="mf">8.</span> <span class="o">*</span> <span class="n">e</span> <span class="o">*</span> <span class="n">e</span> <span class="o">-</span>
                <span class="mf">2.</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">e</span><span class="p">)</span> <span class="o">*</span> <span class="n">log</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">e</span><span class="p">)</span> <span class="o">*</span>
                    <span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="mf">4.</span> <span class="o">*</span> <span class="n">e</span> <span class="o">*</span> <span class="n">e</span> <span class="o">*</span> <span class="n">e</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">e</span> <span class="o">*</span> <span class="n">e</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">/</span> <span class="n">e</span> <span class="o">-</span> <span class="mf">2.</span> <span class="o">+</span>
                     <span class="mf">4.</span> <span class="o">*</span> <span class="n">e</span><span class="p">));</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">k</span> <span class="o">*</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">/</span> <span class="n">e</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="mf">4.</span> <span class="o">-</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">e</span> <span class="o">+</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="mf">4.</span> <span class="o">*</span> <span class="n">e</span> <span class="o">*</span> <span class="n">e</span><span class="p">))</span> <span class="o">*</span> <span class="n">log</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">g</span><span class="p">)</span> <span class="o">-</span>
                           <span class="mf">2.</span> <span class="o">+</span> <span class="mf">2.</span> <span class="o">/</span> <span class="n">e</span> <span class="o">-</span> <span class="mf">5.</span> <span class="o">/</span> <span class="p">(</span><span class="mf">8.</span> <span class="o">*</span> <span class="n">e</span> <span class="o">*</span> <span class="n">e</span><span class="p">));</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/** equation (A5), non-relativistic Bremsstrahlung</span>
<span class="cm"> */</span>
<span class="kt">double</span> <span class="n">Radiation</span><span class="o">::</span><span class="n">sigmaNR</span><span class="p">(</span><span class="kt">double</span> <span class="n">g</span><span class="p">,</span> <span class="kt">double</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">e</span> <span class="o">&lt;=</span> <span class="mf">0.</span> <span class="o">||</span> <span class="n">e</span> <span class="o">&gt;=</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="p">(</span><span class="n">g</span> <span class="o">*</span> <span class="n">g</span> <span class="o">-</span> <span class="mf">1.</span><span class="p">))</span> <span class="k">return</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">sig</span> <span class="o">=</span> <span class="p">(</span><span class="mf">4.</span> <span class="o">*</span> <span class="n">e_radius</span> <span class="o">*</span> <span class="n">e_radius</span> <span class="o">*</span> <span class="n">fineStructConst</span> <span class="o">/</span> <span class="p">(</span><span class="mf">15.</span> <span class="o">*</span> <span class="n">e</span><span class="p">))</span> <span class="o">*</span>
               <span class="n">Fbr</span><span class="p">(</span><span class="mf">4.</span> <span class="o">*</span> <span class="n">e</span> <span class="o">/</span> <span class="p">(</span><span class="n">g</span> <span class="o">*</span> <span class="n">g</span> <span class="o">-</span> <span class="mf">1.</span><span class="p">),</span> <span class="n">g</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">sig</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/** equations (A6,A7)</span>
<span class="cm"> */</span>
<span class="kt">double</span> <span class="n">Radiation</span><span class="o">::</span><span class="n">Fbr</span><span class="p">(</span><span class="kt">double</span> <span class="n">x</span><span class="p">,</span> <span class="kt">double</span> <span class="n">g</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">double</span> <span class="n">B</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">g</span> <span class="o">*</span> <span class="n">g</span> <span class="o">-</span> <span class="mf">1.</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">b</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="n">g</span> <span class="o">*</span> <span class="n">g</span><span class="p">));</span>
  <span class="kt">double</span> <span class="n">C</span> <span class="o">=</span> <span class="mf">10.</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="n">g</span> <span class="o">*</span> <span class="n">b</span> <span class="o">*</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">+</span> <span class="n">g</span> <span class="o">*</span> <span class="n">b</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="p">(</span><span class="n">g</span> <span class="o">*</span> <span class="n">g</span> <span class="o">-</span> <span class="mf">1.</span><span class="p">));</span>
  <span class="kt">double</span> <span class="n">F</span> <span class="o">=</span> <span class="n">B</span> <span class="o">*</span> <span class="p">(</span><span class="mf">17.</span> <span class="o">-</span> <span class="mf">3.</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span> <span class="o">/</span> <span class="p">((</span><span class="mf">2.</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">-</span> <span class="n">x</span><span class="p">))</span> <span class="o">-</span> <span class="n">C</span><span class="p">)</span> <span class="o">*</span> <span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">x</span><span class="p">);</span>
  <span class="n">F</span> <span class="o">+=</span> <span class="p">(</span><span class="mf">12.</span> <span class="o">*</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mf">7.</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span> <span class="o">-</span>
        <span class="mf">3.</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span> <span class="o">/</span> <span class="p">((</span><span class="mf">2.</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">-</span> <span class="n">x</span><span class="p">)))</span> <span class="o">*</span>
       <span class="n">log</span><span class="p">((</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">x</span><span class="p">))</span> <span class="o">/</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="p">));</span>
  <span class="k">return</span> <span class="n">F</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* end Bremsstrahlung part */</span>

<span class="cm">/* ---      pi0 decay     --- */</span>

<span class="kt">double</span> <span class="n">Radiation</span><span class="o">::</span><span class="n">PPEmissivity</span><span class="p">(</span><span class="kt">double</span> <span class="n">x</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span> <span class="p">{</span>
  <span class="cm">/* proton energy */</span>
  <span class="kt">double</span> <span class="n">EP</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
  <span class="cm">/* pi0 decay photon energy */</span>
  <span class="kt">double</span> <span class="n">Eg</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">double</span> <span class="o">*</span><span class="p">)</span><span class="n">par</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">EP</span> <span class="o">&lt;=</span> <span class="n">m_p</span><span class="p">)</span> <span class="k">return</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">Tp</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">EP</span> <span class="o">*</span> <span class="n">EP</span> <span class="o">-</span> <span class="n">m_p</span> <span class="o">*</span> <span class="n">m_p</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">Tpth</span> <span class="o">=</span> <span class="mf">0.2797</span> <span class="o">*</span> <span class="n">GeV_to_erg</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Tp</span> <span class="o">&lt;=</span> <span class="n">Tpth</span><span class="p">)</span> <span class="k">return</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Eg</span> <span class="o">&lt;=</span> <span class="n">GetMinimumGammaEnergy</span><span class="p">(</span><span class="n">Tp</span><span class="p">))</span> <span class="k">return</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Eg</span> <span class="o">&gt;=</span> <span class="n">GetMaximumGammaEnergy</span><span class="p">(</span><span class="n">Tp</span><span class="p">))</span> <span class="k">return</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">N</span> <span class="o">=</span> <span class="n">DiffPPXSection</span><span class="p">(</span><span class="n">Tp</span><span class="p">,</span> <span class="n">Eg</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">logprotons</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">EvalSpline</span><span class="p">(</span><span class="n">log10</span><span class="p">(</span><span class="n">EP</span><span class="p">),</span><span class="n">ProtonLookup</span><span class="p">,</span>
                                      <span class="n">acc</span><span class="p">,</span><span class="n">__func__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">c_speed</span> <span class="o">*</span> <span class="n">n</span> <span class="o">*</span> <span class="n">N</span> <span class="o">*</span> <span class="nf">pow</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="n">logprotons</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/** differential cross section following Kafexhiu 2014</span>
<span class="cm"> *  (Eq. 8)</span>
<span class="cm"> */</span>
<span class="kt">double</span> <span class="n">Radiation</span><span class="o">::</span><span class="n">DiffPPXSection</span><span class="p">(</span><span class="kt">double</span> <span class="n">Tp</span><span class="p">,</span> <span class="kt">double</span> <span class="n">Eg</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">double</span> <span class="n">dsigmadE</span> <span class="o">=</span>
      <span class="n">NuclearEnhancementFactor</span><span class="p">(</span><span class="n">Tp</span><span class="p">)</span> <span class="o">*</span> <span class="n">Amax</span><span class="p">(</span><span class="n">Tp</span><span class="p">)</span> <span class="o">*</span> <span class="n">F</span><span class="p">(</span><span class="n">Tp</span><span class="p">,</span> <span class="n">Eg</span><span class="p">)</span> <span class="o">/</span> <span class="n">GeV_to_erg</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">dsigmadE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/** inclusive pi0 production cross section over the full energy range.</span>
<span class="cm"> *  following Kafexhiu 2014, Paragragh II B 4</span>
<span class="cm"> */</span>
<span class="kt">double</span> <span class="n">Radiation</span><span class="o">::</span><span class="n">InclusivePPXSection</span><span class="p">(</span><span class="kt">double</span> <span class="n">Tp</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">double</span> <span class="n">InclusiveXSection</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Tp</span> <span class="o">&lt;</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">GeV_to_erg</span><span class="p">)</span>
    <span class="n">InclusiveXSection</span> <span class="o">=</span> <span class="n">SigmaOnePi</span><span class="p">(</span><span class="n">Tp</span><span class="p">)</span> <span class="o">+</span> <span class="n">SigmaTwoPi</span><span class="p">(</span><span class="n">Tp</span><span class="p">);</span>
  <span class="k">else</span>
    <span class="n">InclusiveXSection</span> <span class="o">=</span> <span class="n">InelasticPPXSectionKaf</span><span class="p">(</span><span class="n">Tp</span><span class="p">)</span> <span class="o">*</span> <span class="n">MeanMultiplicity</span><span class="p">(</span><span class="n">Tp</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">InclusiveXSection</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/** inelastic proton-proton cross-section following</span>
<span class="cm"> *  Kafexhiu 2014 (Eq. 1)</span>
<span class="cm"> */</span>
<span class="kt">double</span> <span class="n">Radiation</span><span class="o">::</span><span class="n">InelasticPPXSectionKaf</span><span class="p">(</span><span class="kt">double</span> <span class="n">Tp</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">double</span> <span class="n">Tpth</span> <span class="o">=</span> <span class="mf">0.2797</span> <span class="o">*</span> <span class="n">GeV_to_erg</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">L</span> <span class="o">=</span> <span class="n">Tp</span> <span class="o">/</span> <span class="n">Tpth</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">logL</span> <span class="o">=</span> <span class="n">log</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">sigma</span> <span class="o">=</span>
      <span class="p">(</span><span class="mf">30.7</span> <span class="o">-</span> <span class="mf">0.96</span> <span class="o">*</span> <span class="n">logL</span> <span class="o">+</span> <span class="mf">0.18</span> <span class="o">*</span> <span class="n">logL</span> <span class="o">*</span> <span class="n">logL</span><span class="p">)</span> <span class="o">*</span> <span class="n">pow</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">pow</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.9</span><span class="p">),</span> <span class="mf">3.</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">sigma</span> <span class="o">*</span> <span class="mf">1.e-27</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/** mean multiplicity, Eqs.6&amp;7 in Kafexhiu 2014</span>
<span class="cm"> */</span>
<span class="kt">double</span> <span class="n">Radiation</span><span class="o">::</span><span class="n">MeanMultiplicity</span><span class="p">(</span><span class="kt">double</span> <span class="n">Tp</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Tp</span> <span class="o">/=</span> <span class="n">GeV_to_erg</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">meanMult</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a4</span><span class="p">,</span> <span class="n">a5</span><span class="p">,</span> <span class="n">TpTrans</span><span class="p">;</span>
  <span class="n">meanMult</span> <span class="o">=</span> <span class="n">a1</span> <span class="o">=</span> <span class="n">a2</span> <span class="o">=</span> <span class="n">a3</span> <span class="o">=</span> <span class="n">a4</span> <span class="o">=</span> <span class="n">a5</span> <span class="o">=</span> <span class="n">TpTrans</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">PiModel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">TpTrans</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">PiModel</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">TpTrans</span> <span class="o">=</span> <span class="mf">50.</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">PiModel</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">PiModel</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">TpTrans</span> <span class="o">=</span> <span class="mf">100.</span><span class="p">;</span>
  <span class="k">else</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Radiation::MeanMultiplicity: WTF, specify supported &quot;</span>
            <span class="s">&quot;parameterisation!&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="cm">/* Eq. 6 */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Tp</span> <span class="o">&lt;</span> <span class="mf">5.</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">double</span> <span class="n">Tpth</span> <span class="o">=</span> <span class="mf">0.2797</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">Q</span> <span class="o">=</span> <span class="p">(</span><span class="n">Tp</span> <span class="o">-</span> <span class="n">Tpth</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">m_p</span> <span class="o">/</span> <span class="n">GeV_to_erg</span><span class="p">);</span>
    <span class="n">meanMult</span> <span class="o">=</span> <span class="o">-</span><span class="mf">6.e-3</span> <span class="o">+</span> <span class="mf">0.237</span> <span class="o">*</span> <span class="n">Q</span> <span class="o">-</span> <span class="mf">0.023</span> <span class="o">*</span> <span class="n">Q</span> <span class="o">*</span> <span class="n">Q</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="kt">double</span> <span class="n">Xi</span> <span class="o">=</span> <span class="p">(</span><span class="n">Tp</span> <span class="o">-</span> <span class="mf">3.</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">m_p</span> <span class="o">/</span> <span class="n">GeV_to_erg</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Tp</span> <span class="o">&lt;</span> <span class="n">TpTrans</span><span class="p">)</span> <span class="p">{</span>
      <span class="kt">double</span> <span class="n">PiModelprev</span> <span class="o">=</span> <span class="n">PiModel</span><span class="p">;</span>
      <span class="n">PiModel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">GetAParams</span><span class="p">(</span><span class="n">Tp</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a4</span><span class="p">,</span> <span class="n">a5</span><span class="p">);</span>
      <span class="n">PiModel</span> <span class="o">=</span> <span class="n">PiModelprev</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span>
      <span class="n">GetAParams</span><span class="p">(</span><span class="n">Tp</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a4</span><span class="p">,</span> <span class="n">a5</span><span class="p">);</span>
    <span class="n">meanMult</span> <span class="o">=</span> <span class="n">a1</span> <span class="o">*</span> <span class="n">pow</span><span class="p">(</span><span class="n">Xi</span><span class="p">,</span> <span class="n">a4</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">a2</span> <span class="o">*</span> <span class="n">pow</span><span class="p">(</span><span class="n">Xi</span><span class="p">,</span> <span class="n">a5</span><span class="p">)))</span> <span class="o">*</span>
               <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">a3</span> <span class="o">*</span> <span class="n">pow</span><span class="p">(</span><span class="n">Xi</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">)));</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">meanMult</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/** Eq. 2 Kafexhiu 2014, needed for lowest energies</span>
<span class="cm"> */</span>
<span class="kt">double</span> <span class="n">Radiation</span><span class="o">::</span><span class="n">SigmaOnePi</span><span class="p">(</span><span class="kt">double</span> <span class="n">Tp</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">double</span> <span class="n">sigma0</span> <span class="o">=</span> <span class="mf">7.66e-3</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">s</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">m_p</span> <span class="o">*</span> <span class="p">(</span><span class="n">Tp</span> <span class="o">+</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">m_p</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">Mres</span> <span class="o">=</span> <span class="mf">1.1883</span> <span class="o">*</span> <span class="n">GeV_to_erg</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">Gres</span> <span class="o">=</span> <span class="mf">0.2264</span> <span class="o">*</span> <span class="n">GeV_to_erg</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">g</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">Mres</span> <span class="o">*</span> <span class="n">Mres</span> <span class="o">*</span> <span class="p">(</span><span class="n">Mres</span> <span class="o">*</span> <span class="n">Mres</span> <span class="o">+</span> <span class="n">Gres</span> <span class="o">*</span> <span class="n">Gres</span><span class="p">));</span>
  <span class="kt">double</span> <span class="n">kk</span> <span class="o">=</span> <span class="n">s</span> <span class="o">-</span> <span class="n">m_pi</span> <span class="o">*</span> <span class="n">m_pi</span> <span class="o">-</span> <span class="mf">4.</span> <span class="o">*</span> <span class="n">m_p</span> <span class="o">*</span> <span class="n">m_p</span><span class="p">;</span>
  <span class="cm">/* Eq. 3 */</span>
  <span class="kt">double</span> <span class="n">eta</span> <span class="o">=</span>
      <span class="n">sqrt</span><span class="p">(</span><span class="n">kk</span> <span class="o">*</span> <span class="n">kk</span> <span class="o">-</span> <span class="mf">16.</span> <span class="o">*</span> <span class="n">m_pi</span> <span class="o">*</span> <span class="n">m_pi</span> <span class="o">*</span> <span class="n">m_p</span> <span class="o">*</span> <span class="n">m_p</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">m_pi</span> <span class="o">*</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>
  <span class="kt">double</span> <span class="n">K</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="mf">8.</span><span class="p">)</span> <span class="o">*</span> <span class="n">Mres</span> <span class="o">*</span> <span class="n">Gres</span> <span class="o">*</span> <span class="n">g</span> <span class="o">/</span> <span class="p">(</span><span class="n">pi</span> <span class="o">*</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">Mres</span> <span class="o">*</span> <span class="n">Mres</span> <span class="o">+</span> <span class="n">g</span><span class="p">));</span>
  <span class="kt">double</span> <span class="n">ll</span> <span class="o">=</span> <span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">-</span> <span class="n">m_p</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">-</span> <span class="n">m_p</span><span class="p">)</span> <span class="o">-</span> <span class="n">Mres</span> <span class="o">*</span> <span class="n">Mres</span><span class="p">;</span>
  <span class="cm">/* Eq. 4 */</span>
  <span class="kt">double</span> <span class="n">fBW</span> <span class="o">=</span> <span class="n">m_p</span> <span class="o">*</span> <span class="n">K</span> <span class="o">/</span> <span class="p">(</span><span class="n">ll</span> <span class="o">*</span> <span class="n">ll</span> <span class="o">+</span> <span class="n">Mres</span> <span class="o">*</span> <span class="n">Mres</span> <span class="o">*</span> <span class="n">Gres</span> <span class="o">*</span> <span class="n">Gres</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">SigmaOnePi</span> <span class="o">=</span> <span class="n">sigma0</span> <span class="o">*</span> <span class="n">pow</span><span class="p">(</span><span class="n">eta</span><span class="p">,</span> <span class="mf">1.95</span><span class="p">)</span> <span class="o">*</span>
                      <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">eta</span> <span class="o">+</span> <span class="n">eta</span> <span class="o">*</span> <span class="n">eta</span> <span class="o">*</span> <span class="n">eta</span> <span class="o">*</span> <span class="n">eta</span> <span class="o">*</span> <span class="n">eta</span><span class="p">)</span> <span class="o">*</span> <span class="n">pow</span><span class="p">(</span><span class="n">fBW</span><span class="p">,</span> <span class="mf">1.86</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">SigmaOnePi</span> <span class="o">*</span> <span class="mf">1.e-27</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/** Eq. 2 Kafexhiu 2014, needed for lowest energies</span>
<span class="cm"> */</span>
<span class="kt">double</span> <span class="n">Radiation</span><span class="o">::</span><span class="n">SigmaTwoPi</span><span class="p">(</span><span class="kt">double</span> <span class="n">Tp</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">double</span> <span class="n">SigmaTwoPi</span> <span class="o">=</span> <span class="mf">5.7</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">9.3</span> <span class="o">*</span> <span class="p">(</span><span class="n">Tp</span> <span class="o">/</span> <span class="n">GeV_to_erg</span> <span class="o">-</span> <span class="mf">1.4</span><span class="p">)));</span>
  <span class="k">return</span> <span class="n">SigmaTwoPi</span> <span class="o">*</span> <span class="mf">1.e-27</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/** X-section normalisation following Eq. 12 in Kafexhiu 2014</span>
<span class="cm"> */</span>
<span class="kt">double</span> <span class="n">Radiation</span><span class="o">::</span><span class="n">Amax</span><span class="p">(</span><span class="kt">double</span> <span class="n">Tp</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">double</span> <span class="n">b0</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">b3</span><span class="p">,</span> <span class="n">thetap</span><span class="p">,</span> <span class="n">logthetap</span><span class="p">,</span> <span class="n">amax</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Tp</span> <span class="o">&lt;</span> <span class="mf">1.</span> <span class="o">*</span> <span class="n">GeV_to_erg</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">b0</span> <span class="o">=</span> <span class="mf">5.9</span><span class="p">;</span>
    <span class="n">amax</span> <span class="o">=</span> <span class="n">b0</span> <span class="o">*</span> <span class="n">InclusivePPXSection</span><span class="p">(</span><span class="n">Tp</span><span class="p">)</span> <span class="o">/</span> <span class="n">Epilabmax</span><span class="p">(</span><span class="n">Tp</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">GetBParams</span><span class="p">(</span><span class="n">Tp</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">b3</span><span class="p">);</span>
    <span class="n">thetap</span> <span class="o">=</span> <span class="n">Tp</span> <span class="o">/</span> <span class="n">m_p</span><span class="p">;</span>
    <span class="n">logthetap</span> <span class="o">=</span> <span class="n">log</span><span class="p">(</span><span class="n">thetap</span><span class="p">);</span>
    <span class="n">amax</span> <span class="o">=</span> <span class="n">b1</span> <span class="o">*</span> <span class="n">pow</span><span class="p">(</span><span class="n">thetap</span><span class="p">,</span> <span class="o">-</span><span class="n">b2</span><span class="p">)</span> <span class="o">*</span> <span class="n">exp</span><span class="p">(</span><span class="n">b3</span> <span class="o">*</span> <span class="n">logthetap</span> <span class="o">*</span> <span class="n">logthetap</span><span class="p">)</span> <span class="o">*</span>
           <span class="n">InclusivePPXSection</span><span class="p">(</span><span class="n">Tp</span><span class="p">)</span> <span class="o">/</span> <span class="n">m_p</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">amax</span> <span class="o">*=</span> <span class="n">GeV_to_erg</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">amax</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/** shape of the gamma spectrum per pion decay from Kafexhiu 2014 Eq. 11</span>
<span class="cm"> */</span>
<span class="kt">double</span> <span class="n">Radiation</span><span class="o">::</span><span class="n">F</span><span class="p">(</span><span class="kt">double</span> <span class="n">Tp</span><span class="p">,</span> <span class="kt">double</span> <span class="n">Eg</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">double</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">lambda</span><span class="p">;</span>
  <span class="n">GetABGParams</span><span class="p">(</span><span class="n">Tp</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">lambda</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">Egmax</span> <span class="o">=</span> <span class="n">GetMaximumGammaEnergy</span><span class="p">(</span><span class="n">Tp</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">Yg</span> <span class="o">=</span> <span class="n">Eg</span> <span class="o">+</span> <span class="n">m_pi</span> <span class="o">*</span> <span class="n">m_pi</span> <span class="o">/</span> <span class="p">(</span><span class="mf">4.</span> <span class="o">*</span> <span class="n">Eg</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">Ygmax</span> <span class="o">=</span> <span class="n">Egmax</span> <span class="o">+</span> <span class="n">m_pi</span> <span class="o">*</span> <span class="n">m_pi</span> <span class="o">/</span> <span class="p">(</span><span class="mf">4.</span> <span class="o">*</span> <span class="n">Egmax</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">Xg</span> <span class="o">=</span> <span class="p">(</span><span class="n">Yg</span> <span class="o">-</span> <span class="n">m_pi</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">Ygmax</span> <span class="o">-</span> <span class="n">m_pi</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">C</span> <span class="o">=</span> <span class="n">lambda</span> <span class="o">*</span> <span class="n">m_pi</span> <span class="o">/</span> <span class="n">Ygmax</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">f</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">pow</span><span class="p">(</span><span class="n">Xg</span><span class="p">,</span> <span class="n">alpha</span><span class="p">),</span> <span class="n">beta</span><span class="p">)</span> <span class="o">/</span> <span class="n">pow</span><span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">Xg</span> <span class="o">/</span> <span class="n">C</span><span class="p">,</span> <span class="n">gamma</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">f</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/** maximum gamma energy from decay of pion with kinetic energy Tp.</span>
<span class="cm"> *  from Kafexhiu 2014, Eq. 10</span>
<span class="cm"> */</span>
<span class="kt">double</span> <span class="n">Radiation</span><span class="o">::</span><span class="n">GetMaximumGammaEnergy</span><span class="p">(</span><span class="kt">double</span> <span class="n">Tp</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">double</span> <span class="n">gammapilab</span> <span class="o">=</span> <span class="n">Epilabmax</span><span class="p">(</span><span class="n">Tp</span><span class="p">)</span> <span class="o">/</span> <span class="n">m_pi</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">betapilab</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="n">gammapilab</span> <span class="o">*</span> <span class="n">gammapilab</span><span class="p">));</span>
  <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">m_pi</span> <span class="o">*</span> <span class="n">gammapilab</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">betapilab</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/** minimum gamma energy from decay of pion with kinetic energy Tp.</span>
<span class="cm"> *  from Kafexhiu 2014, Eq. 10</span>
<span class="cm"> */</span>
<span class="kt">double</span> <span class="n">Radiation</span><span class="o">::</span><span class="n">GetMinimumGammaEnergy</span><span class="p">(</span><span class="kt">double</span> <span class="n">Tp</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">double</span> <span class="n">gammapilab</span> <span class="o">=</span> <span class="n">Epilabmax</span><span class="p">(</span><span class="n">Tp</span><span class="p">)</span> <span class="o">/</span> <span class="n">m_pi</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">betapilab</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="n">gammapilab</span> <span class="o">*</span> <span class="n">gammapilab</span><span class="p">));</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">m_pi</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span> <span class="o">*</span> <span class="n">gammapilab</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">betapilab</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/** maximum pion energy in the lab frame (Kafexhiu 2014, Eq. 10)</span>
<span class="cm"> */</span>
<span class="kt">double</span> <span class="n">Radiation</span><span class="o">::</span><span class="n">Epilabmax</span><span class="p">(</span><span class="kt">double</span> <span class="n">Tp</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">double</span> <span class="n">s</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">m_p</span> <span class="o">*</span> <span class="p">(</span><span class="n">Tp</span> <span class="o">+</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">m_p</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">EpiCM</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span> <span class="o">-</span> <span class="mf">4.</span> <span class="o">*</span> <span class="n">m_p</span> <span class="o">*</span> <span class="n">m_p</span> <span class="o">+</span> <span class="n">m_pi</span> <span class="o">*</span> <span class="n">m_pi</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>
  <span class="kt">double</span> <span class="n">gammaCM</span> <span class="o">=</span> <span class="p">(</span><span class="n">Tp</span> <span class="o">+</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">m_p</span><span class="p">)</span> <span class="o">/</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">PpiCM</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">EpiCM</span> <span class="o">*</span> <span class="n">EpiCM</span> <span class="o">-</span> <span class="n">m_pi</span> <span class="o">*</span> <span class="n">m_pi</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">betaCM</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="n">gammaCM</span> <span class="o">*</span> <span class="n">gammaCM</span><span class="p">));</span>
  <span class="kt">double</span> <span class="n">Epilabmax</span> <span class="o">=</span> <span class="n">gammaCM</span> <span class="o">*</span> <span class="p">(</span><span class="n">EpiCM</span> <span class="o">+</span> <span class="n">PpiCM</span> <span class="o">*</span> <span class="n">betaCM</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">Epilabmax</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/** correction factor that accounts for the abundance of heavier nuclei in</span>
<span class="cm"> *  the medium.</span>
<span class="cm"> */</span>
<span class="kt">double</span> <span class="n">Radiation</span><span class="o">::</span><span class="n">NuclearEnhancementFactor</span><span class="p">(</span><span class="kt">double</span> <span class="n">Tp</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">double</span> <span class="n">Tp0</span> <span class="o">=</span> <span class="mf">1.e3</span> <span class="o">*</span> <span class="n">GeV_to_erg</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">G</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">sigmaTp</span> <span class="o">=</span> <span class="n">InelasticPPXSectionKaf</span><span class="p">(</span><span class="n">Tp</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">sigmaTp0</span> <span class="o">=</span> <span class="n">InelasticPPXSectionKaf</span><span class="p">(</span><span class="n">Tp0</span><span class="p">);</span>
  <span class="cm">/* Eq. 19 */</span>
  <span class="p">(</span><span class="n">sigmaTp</span> <span class="o">/</span> <span class="n">sigmaTp0</span> <span class="o">&gt;</span> <span class="mf">1.</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">G</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">+</span> <span class="n">log</span><span class="p">(</span><span class="n">sigmaTp</span> <span class="o">/</span> <span class="n">sigmaTp0</span><span class="p">))</span> <span class="o">:</span> <span class="n">G</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">sigmaRpp</span> <span class="o">=</span> <span class="mf">31.4e-27</span><span class="p">;</span>
  <span class="cm">/* these values are derived from local galactic ISM values, see Kafexhiu paper</span>
<span class="cm">   * p.13*/</span>
  <span class="kt">double</span> <span class="n">epsilonc</span> <span class="o">=</span> <span class="mf">1.37</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">epsilon1</span> <span class="o">=</span> <span class="mf">0.29</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">epsilon2</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">epsilon</span> <span class="o">=</span> <span class="n">epsilonc</span> <span class="o">+</span> <span class="p">(</span><span class="n">epsilon1</span> <span class="o">+</span> <span class="n">epsilon2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">sigmaRpp</span> <span class="o">*</span> <span class="n">G</span><span class="p">)</span> <span class="o">/</span> <span class="n">sigmaTp</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">epsilon</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/** get the alpha beta and gamma parameters used in Eq. 11, Kafexhiu 2014</span>
<span class="cm"> *  this is basically an implementation of Table V in the paper.</span>
<span class="cm"> *  is lambda right for Tp&lt;1GeV? in the paper, a dash is listed...</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">Radiation</span><span class="o">::</span><span class="n">GetABGParams</span><span class="p">(</span><span class="kt">double</span> <span class="n">Tp</span><span class="p">,</span> <span class="kt">double</span> <span class="o">&amp;</span><span class="n">alpha</span><span class="p">,</span> <span class="kt">double</span> <span class="o">&amp;</span><span class="n">beta</span><span class="p">,</span>
                             <span class="kt">double</span> <span class="o">&amp;</span><span class="n">gamma</span><span class="p">,</span> <span class="kt">double</span> <span class="o">&amp;</span><span class="n">lambda</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Tp</span> <span class="o">/=</span> <span class="n">GeV_to_erg</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">q</span> <span class="o">=</span> <span class="p">(</span><span class="n">Tp</span> <span class="o">-</span> <span class="mf">1.</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">m_p</span> <span class="o">/</span> <span class="n">GeV_to_erg</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">mu</span> <span class="o">=</span> <span class="mf">1.25</span> <span class="o">*</span> <span class="n">pow</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mf">1.25</span><span class="p">)</span> <span class="o">*</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">1.25</span> <span class="o">*</span> <span class="n">q</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">kappa</span> <span class="o">=</span> <span class="mf">3.29</span> <span class="o">-</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="n">pow</span><span class="p">(</span><span class="n">Tp</span> <span class="o">/</span> <span class="p">(</span><span class="n">m_p</span> <span class="o">/</span> <span class="n">GeV_to_erg</span><span class="p">),</span> <span class="o">-</span><span class="mf">1.5</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Tp</span> <span class="o">&lt;</span> <span class="mf">1.</span><span class="p">)</span>
    <span class="n">lambda</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">beta</span> <span class="o">=</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">gamma</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Tp</span> <span class="o">&lt;</span> <span class="mf">4.</span><span class="p">)</span>
    <span class="n">lambda</span> <span class="o">=</span> <span class="mf">3.</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">beta</span> <span class="o">=</span> <span class="n">mu</span> <span class="o">+</span> <span class="mf">2.45</span><span class="p">,</span> <span class="n">gamma</span> <span class="o">=</span> <span class="n">mu</span> <span class="o">+</span> <span class="mf">1.45</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Tp</span> <span class="o">&lt;</span> <span class="mf">20.</span><span class="p">)</span>
    <span class="n">lambda</span> <span class="o">=</span> <span class="mf">3.</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">beta</span> <span class="o">=</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">mu</span> <span class="o">+</span> <span class="mf">4.95</span><span class="p">,</span> <span class="n">gamma</span> <span class="o">=</span> <span class="n">mu</span> <span class="o">+</span> <span class="mf">1.5</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Tp</span> <span class="o">&lt;</span> <span class="mf">100.</span><span class="p">)</span>
    <span class="n">lambda</span> <span class="o">=</span> <span class="mf">3.</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">beta</span> <span class="o">=</span> <span class="mf">4.2</span><span class="p">,</span> <span class="n">gamma</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">PiModel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">lambda</span> <span class="o">=</span> <span class="mf">3.</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">beta</span> <span class="o">=</span> <span class="mf">4.9</span><span class="p">,</span> <span class="n">gamma</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">PiModel</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">lambda</span> <span class="o">=</span> <span class="mf">3.55</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">beta</span> <span class="o">=</span> <span class="mf">3.6</span><span class="p">,</span> <span class="n">gamma</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">PiModel</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">lambda</span> <span class="o">=</span> <span class="mf">3.55</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">beta</span> <span class="o">=</span> <span class="mf">4.5</span><span class="p">,</span> <span class="n">gamma</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Tp</span> <span class="o">&gt;</span> <span class="mf">50.</span> <span class="o">&amp;&amp;</span> <span class="n">PiModel</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">lambda</span> <span class="o">=</span> <span class="mf">3.5</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">beta</span> <span class="o">=</span> <span class="mf">4.</span><span class="p">,</span> <span class="n">gamma</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">;</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/** get the a parameters used in Eq. 7, Kafexhiu 2014</span>
<span class="cm"> *  this is basically an implementation of Table IV in the paper.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">Radiation</span><span class="o">::</span><span class="n">GetAParams</span><span class="p">(</span><span class="kt">double</span> <span class="n">Tp</span><span class="p">,</span> <span class="kt">double</span> <span class="o">&amp;</span><span class="n">a1</span><span class="p">,</span> <span class="kt">double</span> <span class="o">&amp;</span><span class="n">a2</span><span class="p">,</span> <span class="kt">double</span> <span class="o">&amp;</span><span class="n">a3</span><span class="p">,</span>
                           <span class="kt">double</span> <span class="o">&amp;</span><span class="n">a4</span><span class="p">,</span> <span class="kt">double</span> <span class="o">&amp;</span><span class="n">a5</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Tp</span> <span class="o">/=</span> <span class="n">GeV_to_erg</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Tp</span> <span class="o">&lt;</span> <span class="mf">100.</span><span class="p">)</span>
    <span class="n">a1</span> <span class="o">=</span> <span class="mf">0.728</span><span class="p">,</span> <span class="n">a2</span> <span class="o">=</span> <span class="mf">0.596</span><span class="p">,</span> <span class="n">a3</span> <span class="o">=</span> <span class="mf">0.491</span><span class="p">,</span> <span class="n">a4</span> <span class="o">=</span> <span class="mf">0.2503</span><span class="p">,</span> <span class="n">a5</span> <span class="o">=</span> <span class="mf">0.117</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">PiModel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">a1</span> <span class="o">=</span> <span class="mf">0.728</span><span class="p">,</span> <span class="n">a2</span> <span class="o">=</span> <span class="mf">0.596</span><span class="p">,</span> <span class="n">a3</span> <span class="o">=</span> <span class="mf">0.491</span><span class="p">,</span> <span class="n">a4</span> <span class="o">=</span> <span class="mf">0.2503</span><span class="p">,</span> <span class="n">a5</span> <span class="o">=</span> <span class="mf">0.117</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">PiModel</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">a1</span> <span class="o">=</span> <span class="mf">5.436</span><span class="p">,</span> <span class="n">a2</span> <span class="o">=</span> <span class="mf">0.254</span><span class="p">,</span> <span class="n">a3</span> <span class="o">=</span> <span class="mf">0.072</span><span class="p">,</span> <span class="n">a4</span> <span class="o">=</span> <span class="mf">0.075</span><span class="p">,</span> <span class="n">a5</span> <span class="o">=</span> <span class="mf">0.166</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">PiModel</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">a1</span> <span class="o">=</span> <span class="mf">0.908</span><span class="p">,</span> <span class="n">a2</span> <span class="o">=</span> <span class="mf">9.e-4</span><span class="p">,</span> <span class="n">a3</span> <span class="o">=</span> <span class="mf">6.089</span><span class="p">,</span> <span class="n">a4</span> <span class="o">=</span> <span class="mf">0.176</span><span class="p">,</span> <span class="n">a5</span> <span class="o">=</span> <span class="mf">0.448</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Tp</span> <span class="o">&gt;</span> <span class="mf">50.</span> <span class="o">&amp;&amp;</span> <span class="n">PiModel</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">a1</span> <span class="o">=</span> <span class="mf">0.652</span><span class="p">,</span> <span class="n">a2</span> <span class="o">=</span> <span class="mf">1.6e-3</span><span class="p">,</span> <span class="n">a3</span> <span class="o">=</span> <span class="mf">0.488</span><span class="p">,</span> <span class="n">a4</span> <span class="o">=</span> <span class="mf">0.1928</span><span class="p">,</span> <span class="n">a5</span> <span class="o">=</span> <span class="mf">0.483</span><span class="p">;</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/** get the b parameters used in Eq. 12, Kafexhiu 2014</span>
<span class="cm"> *  this is basically an implementation of Table VII in the paper.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">Radiation</span><span class="o">::</span><span class="n">GetBParams</span><span class="p">(</span><span class="kt">double</span> <span class="n">Tp</span><span class="p">,</span> <span class="kt">double</span> <span class="o">&amp;</span><span class="n">b1</span><span class="p">,</span> <span class="kt">double</span> <span class="o">&amp;</span><span class="n">b2</span><span class="p">,</span> <span class="kt">double</span> <span class="o">&amp;</span><span class="n">b3</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Tp</span> <span class="o">/=</span> <span class="n">GeV_to_erg</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Tp</span> <span class="o">&lt;</span> <span class="mf">5.</span><span class="p">)</span>
    <span class="n">b1</span> <span class="o">=</span> <span class="mf">9.53</span><span class="p">,</span> <span class="n">b2</span> <span class="o">=</span> <span class="mf">0.52</span><span class="p">,</span> <span class="n">b3</span> <span class="o">=</span> <span class="mf">0.054</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Tp</span> <span class="o">&lt;</span> <span class="mf">100.</span><span class="p">)</span>
    <span class="n">b1</span> <span class="o">=</span> <span class="mf">9.13</span><span class="p">,</span> <span class="n">b2</span> <span class="o">=</span> <span class="mf">0.35</span><span class="p">,</span> <span class="n">b3</span> <span class="o">=</span> <span class="mf">9.7e-3</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">PiModel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">b1</span> <span class="o">=</span> <span class="mf">9.13</span><span class="p">,</span> <span class="n">b2</span> <span class="o">=</span> <span class="mf">0.35</span><span class="p">,</span> <span class="n">b3</span> <span class="o">=</span> <span class="mf">9.7e-3</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">PiModel</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">b1</span> <span class="o">=</span> <span class="mf">10.77</span><span class="p">,</span> <span class="n">b2</span> <span class="o">=</span> <span class="mf">0.412</span><span class="p">,</span> <span class="n">b3</span> <span class="o">=</span> <span class="mf">1.264e-2</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">PiModel</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">b1</span> <span class="o">=</span> <span class="mf">13.16</span><span class="p">,</span> <span class="n">b2</span> <span class="o">=</span> <span class="mf">0.4419</span><span class="p">,</span> <span class="n">b3</span> <span class="o">=</span> <span class="mf">1.439e-2</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Tp</span> <span class="o">&gt;</span> <span class="mf">50.</span> <span class="o">&amp;&amp;</span> <span class="n">PiModel</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="n">b1</span> <span class="o">=</span> <span class="mf">9.06</span><span class="p">,</span> <span class="n">b2</span> <span class="o">=</span> <span class="mf">0.3795</span><span class="p">,</span> <span class="n">b3</span> <span class="o">=</span> <span class="mf">1.105e-2</span><span class="p">;</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ----         END OF RADIATION MODELS        ----  */</span>

<span class="cm">/**</span>
<span class="cm"> * Set a gsl interpolation object for fast reading of the proton</span>
<span class="cm"> * spectrum. x = energy, y = differential number. x has to be strictly</span>
<span class="cm"> * ordered ascending in energy!</span>
<span class="cm"> * Units: [x]=erg, [y]=1/erg</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">Radiation</span><span class="o">::</span><span class="n">SetParticles</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">PARTICLES</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;&amp;</span> <span class="n">type</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Radiation::SetParticles: particle type unknown! Either &quot;</span>
            <span class="s">&quot;electrons(type=0) or protons(type=1). Exiting!&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PARTICLES</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">type</span><span class="p">)</span>
      <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Radiation::SetParticles: electron vector empty. Exiting.&quot;</span>
           <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="k">else</span>
      <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Radiation::SetParticles: proton vector empty. Exiting.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">PARTICLES</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
  <span class="kt">double</span> <span class="n">x</span><span class="p">[</span><span class="n">PARTICLES</span><span class="p">.</span><span class="n">size</span><span class="p">()];</span>
  <span class="kt">double</span> <span class="n">y</span><span class="p">[</span><span class="n">PARTICLES</span><span class="p">.</span><span class="n">size</span><span class="p">()];</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PARTICLES</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">log10</span><span class="p">(</span><span class="n">PARTICLES</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
    <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">log10</span><span class="p">(</span><span class="n">PARTICLES</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ElectronLookup</span> <span class="o">=</span> <span class="n">gsl_spline_alloc</span><span class="p">(</span><span class="n">gsl_interp_linear</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
    <span class="n">gsl_spline_init</span><span class="p">(</span><span class="n">ElectronLookup</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">ProtonLookup</span> <span class="o">=</span> <span class="n">gsl_spline_alloc</span><span class="p">(</span><span class="n">gsl_interp_linear</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
    <span class="n">gsl_spline_init</span><span class="p">(</span><span class="n">ProtonLookup</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Radiation</span><span class="o">::</span><span class="n">SetElectrons</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">ELECTRONS</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="o">*</span><span class="n">eladr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ElectronVector</span><span class="p">;</span>
  <span class="o">*</span><span class="n">eladr</span> <span class="o">=</span> <span class="n">ELECTRONS</span><span class="p">;</span>
  <span class="n">SetParticles</span><span class="p">(</span><span class="n">ElectronVector</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Radiation</span><span class="o">::</span><span class="n">SetProtons</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">PROTONS</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="o">*</span><span class="n">pradr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ProtonVector</span><span class="p">;</span>
  <span class="o">*</span><span class="n">pradr</span> <span class="o">=</span> <span class="n">PROTONS</span><span class="p">;</span>
  <span class="n">SetParticles</span><span class="p">(</span><span class="n">ProtonVector</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Here comes code that defines the spectral distributions of target photons in</span>
<span class="cm"> * the IC process.</span>
<span class="cm"> * The general idea is that you can add different components to the</span>
<span class="cm"> * &quot;TargetPhotonGraphs&quot; vector</span>
<span class="cm"> * storing TGraphs, which are then in the end added up to</span>
<span class="cm"> * &quot;TotalTargetPhotonGraph&quot;, which is the</span>
<span class="cm"> * final, total radiation field in the IC process.</span>
<span class="cm"> */</span>

<span class="cm">/** Add a greybody distribution of target photons to TotalTargetPhotonGraph,</span>
<span class="cm"> * which is used in the</span>
<span class="cm"> * IC emission process in this class, but which can also be used &#39;Particles&#39;</span>
<span class="cm"> * class to calculate</span>
<span class="cm"> * IC cooling losses</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">Radiation</span><span class="o">::</span><span class="n">AddThermalTargetPhotons</span><span class="p">(</span><span class="kt">double</span> <span class="n">T</span><span class="p">,</span> <span class="kt">double</span> <span class="n">edens</span><span class="p">,</span> <span class="kt">int</span> <span class="n">steps</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">edens</span> <span class="o">&gt;</span> <span class="mf">1.e-8</span><span class="p">)</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Radiation::AddThermalTargetPhotons: energy density of radiation &quot;</span>
            <span class="s">&quot;field insane. Are you sure of this?&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="n">edens</span><span class="o">&lt;=</span><span class="mf">0.</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Radiation::AddThermalTargetPhotons: energy density of target &quot;</span>
            <span class="s">&quot;radiation field negative or zero? Exiting.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kt">double</span> <span class="n">logemin</span><span class="p">,</span> <span class="n">logemax</span><span class="p">,</span> <span class="n">low_boundary</span><span class="p">,</span> <span class="n">high_boundary</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">lowtp</span><span class="p">,</span>
      <span class="n">hightp</span><span class="p">;</span>
  <span class="n">low_boundary</span> <span class="o">=</span> <span class="mf">1.e-5</span><span class="p">;</span>
  <span class="n">high_boundary</span> <span class="o">=</span> <span class="mf">1.e6</span><span class="p">;</span>
  <span class="n">low</span> <span class="o">=</span> <span class="n">log10</span><span class="p">(</span><span class="n">low_boundary</span> <span class="o">*</span> <span class="n">kb</span> <span class="o">*</span> <span class="n">T</span><span class="p">);</span>
  <span class="n">high</span> <span class="o">=</span> <span class="n">log10</span><span class="p">(</span><span class="n">high_boundary</span> <span class="o">*</span> <span class="n">kb</span> <span class="o">*</span> <span class="n">T</span><span class="p">);</span>
  <span class="n">lowtp</span> <span class="o">=</span> <span class="n">log10</span><span class="p">(</span><span class="n">targetphotonenergymin</span><span class="p">);</span>
  <span class="n">hightp</span> <span class="o">=</span> <span class="n">log10</span><span class="p">(</span><span class="n">targetphotonenergymax</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">TargetPhotonVector</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">logemin</span> <span class="o">=</span> <span class="n">low</span><span class="p">;</span>
    <span class="n">logemax</span> <span class="o">=</span> <span class="n">high</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="p">(</span><span class="n">lowtp</span> <span class="o">&lt;</span> <span class="n">low</span><span class="p">)</span> <span class="o">?</span> <span class="n">logemin</span> <span class="o">=</span> <span class="nl">lowtp</span> <span class="p">:</span> <span class="n">logemin</span> <span class="o">=</span> <span class="n">low</span><span class="p">;</span>
    <span class="p">(</span><span class="n">hightp</span> <span class="o">&gt;</span> <span class="n">high</span><span class="p">)</span> <span class="o">?</span> <span class="n">logemax</span> <span class="o">=</span> <span class="nl">hightp</span> <span class="p">:</span> <span class="n">logemax</span> <span class="o">=</span> <span class="n">high</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kt">double</span> <span class="n">estep</span> <span class="o">=</span> <span class="p">(</span><span class="n">logemax</span> <span class="o">-</span> <span class="n">logemin</span><span class="p">)</span> <span class="o">/</span> <span class="n">steps</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">ePhoton</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">nPhoton</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="n">vector</span><span class="o">&lt;</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">vint</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">loge</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">loge</span> <span class="o">=</span> <span class="n">logemin</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loge</span> <span class="o">&lt;</span> <span class="n">logemax</span><span class="p">;</span> <span class="n">loge</span> <span class="o">+=</span> <span class="n">estep</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ePhoton</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="n">loge</span><span class="p">);</span>
    <span class="n">nPhoton</span> <span class="o">=</span> <span class="n">GreyBody</span><span class="p">(</span><span class="n">ePhoton</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">edens</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">nPhoton</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
    <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">TwoDVectorPushBack</span><span class="p">(</span><span class="n">loge</span><span class="p">,</span><span class="n">log10</span><span class="p">(</span><span class="n">nPhoton</span><span class="p">),</span><span class="n">vint</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">AddToTargetPhotonVector</span><span class="p">(</span><span class="n">vint</span><span class="p">);</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/** Add an arbitray distribution of target photons to TotalTargetPhotonGraph,</span>
<span class="cm"> * which is used in the</span>
<span class="cm"> * IC emission process in this class, but which can also be used &#39;Particles&#39;</span>
<span class="cm"> * class to calculate</span>
<span class="cm"> * IC cooling losses. This requires as input a 2D vector of format:</span>
<span class="cm"> *              ~~~    energy[erg] number_density   ~~~</span>
<span class="cm"> * The photons will be added to TotalTargetPhotonGraph</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">Radiation</span><span class="o">::</span><span class="n">AddArbitraryTargetPhotons</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">PhotonArray</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">vector</span><span class="o">&lt;</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">vint</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PhotonArray</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">double</span> <span class="n">E</span> <span class="o">=</span> <span class="n">PhotonArray</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
    <span class="kt">double</span> <span class="n">N</span> <span class="o">=</span> <span class="n">PhotonArray</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span><span class="n">E</span> <span class="o">&lt;=</span><span class="mf">0.</span> <span class="o">||</span> <span class="n">N</span> <span class="o">&lt;=</span><span class="mf">0.</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
    <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">TwoDVectorPushBack</span><span class="p">(</span><span class="n">log10</span><span class="p">(</span><span class="n">E</span><span class="p">),</span><span class="n">log10</span><span class="p">(</span><span class="n">N</span><span class="p">),</span><span class="n">vint</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">AddToTargetPhotonVector</span><span class="p">(</span><span class="n">vint</span><span class="p">);</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/** Import target photons from file. File has to be in ASCII format, namely:</span>
<span class="cm"> *              ~~~    energy[eV] number_density   ~~~</span>
<span class="cm"> * The photons will be added to TotalTargetPhotonGraph</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">Radiation</span><span class="o">::</span><span class="n">ImportTargetPhotonsFromFile</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">phFile</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">ifstream</span> <span class="n">PHfile</span><span class="p">(</span><span class="n">phFile</span><span class="p">);</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">v</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">PHfile</span><span class="p">.</span><span class="n">eof</span><span class="p">())</span> <span class="k">break</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">e</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">n</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
    <span class="n">PHfile</span> <span class="o">&gt;&gt;</span> <span class="n">e</span> <span class="o">&gt;&gt;</span> <span class="n">n</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">e</span> <span class="o">&lt;=</span> <span class="mf">0.</span> <span class="o">||</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mf">0.</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
    <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">TwoDVectorPushBack</span><span class="p">(</span><span class="n">log10</span><span class="p">(</span><span class="n">TeV_to_erg</span> <span class="o">*</span> <span class="n">e</span> <span class="o">*</span> <span class="mf">1.e-12</span><span class="p">),</span>
                               <span class="n">log10</span><span class="p">(</span><span class="mf">1.e12</span> <span class="o">*</span> <span class="n">n</span> <span class="o">/</span> <span class="n">TeV_to_erg</span><span class="p">),</span><span class="n">v</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">vector</span><span class="o">&lt;</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">vint</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">v</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">TwoDVectorPushBack</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">vint</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">AddToTargetPhotonVector</span><span class="p">(</span><span class="n">vint</span><span class="p">);</span>
  <span class="n">PHfile</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/** Add SSC target photons.</span>
<span class="cm"> * This function calls the Synchrotron code in this class.</span>
<span class="cm"> * The photons will be added to TotalTargetPhotonGraph</span>
<span class="cm"> * If &#39;UPDATE&#39; is &#39;true&#39;</span>
<span class="cm"> * then recalculate the synchroton target field and</span>
<span class="cm"> * replace the previous one by this updated field.</span>
<span class="cm"> * DANGER: for the &#39;UPDATE&#39; option to work, the SSC field</span>
<span class="cm"> * must be the last entry in the &#39;TargetPhotonGraphs&#39; vector!</span>
<span class="cm"> * It uses Atoyan&amp;Aharonian1996: MNRAS, Volume 278, Issue 2, pp. 525-541</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">Radiation</span><span class="o">::</span><span class="n">AddSSCTargetPhotons</span><span class="p">(</span><span class="kt">double</span> <span class="n">R</span><span class="p">,</span> <span class="kt">int</span> <span class="n">steps</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">R</span> <span class="o">&lt;=</span> <span class="mf">0.</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cout</span>
        <span class="o">&lt;&lt;</span> <span class="s">&quot;Radiation::SetSSCTargetPhotons: Souce extension is &lt;= 0... exiting!&quot;</span>
        <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">ParticleVector</span> <span class="o">=</span> <span class="n">ElectronVector</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ParticleVector</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Radiation::SetSSCTargetPhotons: No particles in spectrum... &quot;</span>
            <span class="s">&quot;exiting!&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">eminxray</span> <span class="o">=</span> <span class="mf">1.e-19</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">logeminxray</span> <span class="o">=</span> <span class="n">log10</span><span class="p">(</span><span class="n">eminxray</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">logemaxxray</span> <span class="o">=</span>
      <span class="n">log10</span><span class="p">(</span><span class="mf">1.e-3</span> <span class="o">*</span> <span class="n">ParticleVector</span><span class="p">[</span><span class="n">ParticleVector</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
  <span class="kt">double</span> <span class="n">estep</span> <span class="o">=</span> <span class="p">(</span><span class="n">logemaxxray</span> <span class="o">-</span> <span class="n">logeminxray</span><span class="p">)</span> <span class="o">/</span> <span class="n">steps</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">E</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">N</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="n">radiationMechanism</span> <span class="o">=</span> <span class="s">&quot;Synchrotron&quot;</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">U</span> <span class="o">=</span> <span class="mf">2.24</span><span class="p">;</span>
  <span class="n">vector</span><span class="o">&lt;</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">vint</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">double</span> <span class="n">loge</span> <span class="o">=</span> <span class="n">logeminxray</span><span class="p">;</span> <span class="n">loge</span> <span class="o">&lt;</span> <span class="n">logemaxxray</span><span class="p">;</span> <span class="n">loge</span> <span class="o">+=</span> <span class="n">estep</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">E</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="n">loge</span><span class="p">);</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">DifferentialEmissionComponent</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">*</span> <span class="n">U</span> <span class="o">/</span> <span class="p">(</span><span class="mf">4.</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">R</span> <span class="o">*</span> <span class="n">R</span> <span class="o">*</span> <span class="n">c_speed</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">N</span> <span class="o">&lt;=</span> <span class="mf">0.</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
    <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">TwoDVectorPushBack</span><span class="p">(</span><span class="n">loge</span><span class="p">,</span><span class="n">log10</span><span class="p">(</span><span class="n">N</span><span class="p">),</span><span class="n">vint</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">AddToTargetPhotonVector</span><span class="p">(</span><span class="n">vint</span><span class="p">);</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Radiation</span><span class="o">::</span><span class="n">AddToTargetPhotonVector</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">vint</span><span class="p">)</span> <span class="p">{</span>

  <span class="n">gsl_interp_accel</span> <span class="o">*</span><span class="n">accT1</span> <span class="o">=</span> <span class="n">gsl_interp_accel_alloc</span><span class="p">();</span>
  <span class="n">gsl_interp_accel</span> <span class="o">*</span><span class="n">accT2</span> <span class="o">=</span> <span class="n">gsl_interp_accel_alloc</span><span class="p">();</span>
  <span class="n">gsl_spline</span> <span class="o">*</span><span class="n">Spl</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">GSLsplineFromTwoDVector</span><span class="p">(</span><span class="n">vint</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">logEminSpl</span> <span class="o">=</span> <span class="n">vint</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">logEmaxSpl</span> <span class="o">=</span> <span class="n">vint</span><span class="p">[</span><span class="n">vint</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">stepsSpl</span> <span class="o">=</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">vint</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">TargetPhotonVector</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">gsl_interp_accel_reset</span><span class="p">(</span><span class="n">accT1</span><span class="p">);</span>
    <span class="kt">double</span> <span class="n">logdE</span> <span class="o">=</span> <span class="p">(</span><span class="n">logEmaxSpl</span> <span class="o">-</span> <span class="n">logEminSpl</span><span class="p">)</span> <span class="o">/</span> <span class="n">stepsSpl</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">double</span> <span class="n">logE</span> <span class="o">=</span> <span class="n">logEminSpl</span><span class="p">;</span> <span class="n">logE</span> <span class="o">&lt;</span> <span class="n">logEmaxSpl</span><span class="p">;</span> <span class="n">logE</span> <span class="o">+=</span> <span class="n">logdE</span><span class="p">)</span> <span class="p">{</span>
      <span class="kt">double</span> <span class="n">val</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">EvalSpline</span><span class="p">(</span><span class="n">logE</span><span class="p">,</span><span class="n">Spl</span><span class="p">,</span><span class="n">accT1</span><span class="p">,</span><span class="n">__func__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">);</span>
      <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">TwoDVectorPushBack</span><span class="p">(</span><span class="n">logE</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">TargetPhotonVector</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">gsl_interp_accel_reset</span><span class="p">(</span><span class="n">accT1</span><span class="p">);</span>
    <span class="n">gsl_interp_accel_reset</span><span class="p">(</span><span class="n">accT2</span><span class="p">);</span>
    <span class="cm">/* safe the old vector */</span>
    <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">Clear2DVector</span><span class="p">(</span><span class="n">TargetPhotonVectorOld</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TargetPhotonVector</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
      <span class="n">TargetPhotonVectorOld</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">TargetPhotonVector</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

    <span class="kt">double</span> <span class="n">logEmin</span><span class="p">,</span> <span class="n">logEmax</span><span class="p">,</span> <span class="n">logEminOld</span><span class="p">,</span> <span class="n">logEmaxOld</span><span class="p">;</span>
    <span class="n">logEminOld</span> <span class="o">=</span> <span class="n">TargetPhotonVector</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">logEmaxOld</span> <span class="o">=</span> <span class="n">TargetPhotonVector</span><span class="p">[</span><span class="n">TargetPhotonVector</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">stepsOld</span> <span class="o">=</span> <span class="n">TargetPhotonVector</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
    <span class="p">(</span><span class="n">logEminOld</span> <span class="o">&lt;=</span> <span class="n">logEminSpl</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">logEmin</span> <span class="o">=</span> <span class="n">logEminOld</span><span class="p">)</span> <span class="o">:</span> <span class="n">logEmin</span> <span class="o">=</span> <span class="n">logEminSpl</span><span class="p">;</span>
    <span class="p">(</span><span class="n">logEmaxOld</span> <span class="o">&gt;=</span> <span class="n">logEmaxSpl</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">logEmax</span> <span class="o">=</span> <span class="n">logEmaxOld</span><span class="p">)</span> <span class="o">:</span> <span class="n">logEmax</span> <span class="o">=</span> <span class="n">logEmaxSpl</span><span class="p">;</span>

    <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">Clear2DVector</span><span class="p">(</span><span class="n">TargetPhotonVector</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">steps</span> <span class="o">=</span>
        <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">stepsOld</span> <span class="o">*</span> <span class="p">(</span><span class="n">logEmax</span> <span class="o">-</span> <span class="n">logEmin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">logEmaxOld</span> <span class="o">-</span> <span class="n">logEminOld</span><span class="p">));</span>
    <span class="kt">double</span> <span class="n">logdE</span> <span class="o">=</span> <span class="p">(</span><span class="n">logEmax</span> <span class="o">-</span> <span class="n">logEmin</span><span class="p">)</span> <span class="o">/</span> <span class="n">steps</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">double</span> <span class="n">logE</span> <span class="o">=</span> <span class="n">logEmin</span><span class="p">;</span> <span class="n">logE</span> <span class="o">&lt;</span> <span class="n">logEmax</span><span class="p">;</span> <span class="n">logE</span> <span class="o">+=</span> <span class="n">logdE</span><span class="p">)</span> <span class="p">{</span>
      <span class="kt">double</span> <span class="n">val</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
      <span class="kt">double</span> <span class="n">valOld</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
      <span class="kt">double</span> <span class="n">valSpl</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">logE</span> <span class="o">&gt;</span> <span class="n">logEminOld</span> <span class="o">&amp;&amp;</span> <span class="n">logE</span> <span class="o">&lt;</span> <span class="n">logEmaxOld</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">valOld</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">EvalSpline</span><span class="p">(</span><span class="n">logE</span><span class="p">,</span><span class="n">TargetPhotonLookup</span><span class="p">,</span>
                                         <span class="n">accT1</span><span class="p">,</span><span class="n">__func__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">);</span>
        <span class="n">valOld</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="n">valOld</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">logE</span> <span class="o">&gt;</span> <span class="n">logEminSpl</span> <span class="o">&amp;&amp;</span> <span class="n">logE</span> <span class="o">&lt;</span> <span class="n">logEmaxSpl</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">valSpl</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">EvalSpline</span><span class="p">(</span><span class="n">logE</span><span class="p">,</span><span class="n">Spl</span><span class="p">,</span>
                                         <span class="n">accT2</span><span class="p">,</span><span class="n">__func__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">);</span>
        <span class="n">valSpl</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="n">valSpl</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">val</span> <span class="o">=</span> <span class="n">valOld</span> <span class="o">+</span> <span class="n">valSpl</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">val</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
      <span class="n">val</span> <span class="o">=</span> <span class="n">log10</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
      <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">TwoDVectorPushBack</span><span class="p">(</span><span class="n">logE</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">TargetPhotonVector</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">SetTargetPhotonVectorLookup</span><span class="p">();</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/** Function that adds up all individual target photon contributions into</span>
<span class="cm"> * TotalTargetPhotonGraph,</span>
<span class="cm"> * which is what is then used by the code in the end.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">Radiation</span><span class="o">::</span><span class="n">SetTargetPhotonVectorLookup</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">TargetPhotonVector</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
  <span class="kt">double</span> <span class="n">e</span><span class="p">[</span><span class="n">size</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">n</span><span class="p">[</span><span class="n">size</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">elin</span><span class="p">[</span><span class="n">size</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">en</span><span class="p">[</span><span class="n">size</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">logEOld</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TargetPhotonVector</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">double</span> <span class="n">logE</span> <span class="o">=</span> <span class="n">TargetPhotonVector</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">logE</span> <span class="o">&lt;</span> <span class="n">logEOld</span> <span class="o">&amp;&amp;</span> <span class="n">logEOld</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Radiation::SetTargetPhotonVectorLookup: Target field not &quot;</span>
              <span class="s">&quot;ordered ascending in energy! Exiting!&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kt">double</span> <span class="n">logN</span> <span class="o">=</span> <span class="n">TargetPhotonVector</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
    <span class="n">e</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">logE</span><span class="p">;</span>
    <span class="n">n</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">logN</span><span class="p">;</span>
    <span class="n">elin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="n">e</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="n">en</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="n">e</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="n">pow</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="n">n</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="n">logE</span> <span class="o">=</span> <span class="n">logEOld</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">targetphotonenergymin</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="n">targetphotonenergymax</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="n">e</span><span class="p">[</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>
  <span class="n">TargetPhotonLookup</span> <span class="o">=</span> <span class="n">gsl_spline_alloc</span><span class="p">(</span><span class="n">gsl_interp_linear</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
  <span class="n">TargetPhotonLookupEdens</span> <span class="o">=</span> <span class="n">gsl_spline_alloc</span><span class="p">(</span><span class="n">gsl_interp_linear</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
  <span class="n">gsl_spline_init</span><span class="p">(</span><span class="n">TargetPhotonLookup</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
  <span class="n">gsl_spline_init</span><span class="p">(</span><span class="n">TargetPhotonLookupEdens</span><span class="p">,</span> <span class="n">elin</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
  <span class="n">gsl_interp_accel_reset</span><span class="p">(</span><span class="n">acc</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">gsl_spline_eval_integ_e</span><span class="p">(</span><span class="n">TargetPhotonLookupEdens</span><span class="p">,</span> <span class="n">targetphotonenergymin</span><span class="p">,</span>
                              <span class="n">targetphotonenergymax</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">TargetPhotonEdens</span><span class="p">))</span>
    <span class="n">TargetPhotonEdens</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/** remove the latest component in</span>
<span class="cm"> * TotalTargetPhotonVector and recompute</span>
<span class="cm"> * the total target photon spectrum</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">Radiation</span><span class="o">::</span><span class="n">RemoveLastICTargetPhotonComponent</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">TargetPhotonVector</span> <span class="o">=</span> <span class="n">TargetPhotonVectorOld</span><span class="p">;</span>
  <span class="n">SetTargetPhotonVectorLookup</span><span class="p">();</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/** Calculate differential photon spectra for the different radiation processes.</span>
<span class="cm"> *  They are stored in the 2D &#39;diffspec&#39; vector and can be accessed via the</span>
<span class="cm"> *  Radiation::ReturnDifferentialSpectrum() member function.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">Radiation</span><span class="o">::</span><span class="n">CalculateDifferentialPhotonSpectrum</span><span class="p">(</span><span class="kt">int</span> <span class="n">steps</span><span class="p">,</span> <span class="kt">double</span> <span class="n">emin</span><span class="p">,</span>
                                                    <span class="kt">double</span> <span class="n">emax</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">emin</span> <span class="o">&gt;</span> <span class="n">emax</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Radiation::ReturnDifferentialSpectrum: Emin&gt;Emax! Check your &quot;</span>
            <span class="s">&quot;boundaries. Exiting...&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">steps</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Radiation::ReturnDifferentialSpectrum: Requested 0 steps! &quot;</span>
            <span class="s">&quot;Exiting...&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">Clear2DVector</span><span class="p">(</span><span class="n">diffSpec</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ElectronVector</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ProtonVector</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Radiation::ReturnDifferentialSpectrum: No particle spectra filled &quot;</span>
            <span class="s">&quot;-&gt; No gamma spectra to calculate. Exiting...&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">QUIETMODE</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;_________________________________________&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;&gt;&gt; CALCULATING SED FROM PARENT PARTICLES &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kt">int</span> <span class="n">tt</span><span class="p">,</span> <span class="n">jj</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">ICVal</span><span class="p">,</span> <span class="n">SynchVal</span><span class="p">,</span> <span class="n">BremsVal</span><span class="p">,</span> <span class="n">ppVal</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">loge</span><span class="p">,</span> <span class="n">Emin</span><span class="p">,</span> <span class="n">Emax</span><span class="p">,</span> <span class="n">estep</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ProtonVector</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">Emax</span> <span class="o">=</span> <span class="n">ElectronVector</span><span class="p">[</span><span class="n">ElectronVector</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">Emin</span> <span class="o">=</span> <span class="n">ElectronVector</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.e-6</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">BField</span><span class="p">)</span>
      <span class="n">Emin</span> <span class="o">*=</span> <span class="mf">1.e-10</span><span class="p">;</span>  <span class="c1">// because in this case we have to go to radio energies</span>
                       <span class="c1">// (synchrotron)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ElectronVector</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">Emax</span> <span class="o">=</span> <span class="n">ProtonVector</span><span class="p">[</span><span class="n">ProtonVector</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">Emin</span> <span class="o">=</span> <span class="n">ProtonVector</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.e-6</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="p">(</span><span class="n">ElectronVector</span><span class="p">[</span><span class="n">ElectronVector</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span>
     <span class="n">ProtonVector</span><span class="p">[</span><span class="n">ProtonVector</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="o">?</span> <span class="p">(</span><span class="n">Emax</span> <span class="o">=</span> <span class="n">ElectronVector</span><span class="p">[</span><span class="n">ElectronVector</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="o">:</span> <span class="p">(</span><span class="n">Emax</span> <span class="o">=</span> <span class="n">ProtonVector</span><span class="p">[</span><span class="n">ProtonVector</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
    <span class="n">Emin</span> <span class="o">=</span> <span class="n">ElectronVector</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.e-6</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">BField</span><span class="p">)</span>
      <span class="n">Emin</span> <span class="o">*=</span> <span class="mf">1.e-10</span><span class="p">;</span>  <span class="c1">// because in this case we have to go to radio energies</span>
                       <span class="c1">// (synchrotron)</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">emin</span><span class="p">)</span> <span class="n">Emin</span> <span class="o">=</span> <span class="n">emin</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">emax</span><span class="p">)</span> <span class="n">Emax</span> <span class="o">=</span> <span class="n">emax</span><span class="p">;</span>

  <span class="n">estep</span> <span class="o">=</span> <span class="p">(</span><span class="n">log10</span><span class="p">(</span><span class="n">Emax</span><span class="p">)</span> <span class="o">-</span> <span class="n">log10</span><span class="p">(</span><span class="n">Emin</span><span class="p">))</span> <span class="o">/</span> <span class="n">steps</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">QUIETMODE</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;** Calculating differential gamma-ray emission:&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">loge</span> <span class="o">=</span> <span class="n">log10</span><span class="p">(</span><span class="n">Emin</span><span class="p">),</span> <span class="n">jj</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">loge</span> <span class="o">&lt;</span> <span class="n">log10</span><span class="p">(</span><span class="n">Emax</span><span class="p">);</span>
       <span class="n">loge</span> <span class="o">+=</span> <span class="n">estep</span><span class="p">,</span> <span class="n">jj</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">((</span><span class="kt">double</span><span class="p">)</span><span class="n">jj</span> <span class="o">/</span> <span class="n">steps</span> <span class="o">&gt;</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">tt</span> <span class="o">&amp;&amp;</span> <span class="n">QUIETMODE</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">;</span>
      <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;    &quot;</span>
           <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="mf">100.</span> <span class="o">*</span> <span class="p">(</span><span class="n">loge</span> <span class="o">-</span> <span class="n">log10</span><span class="p">(</span><span class="n">Emin</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">log10</span><span class="p">(</span><span class="n">Emax</span><span class="p">)</span> <span class="o">-</span> <span class="n">log10</span><span class="p">(</span><span class="n">Emin</span><span class="p">)))</span>
           <span class="o">&lt;&lt;</span> <span class="s">&quot;\% done&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">flush</span><span class="p">;</span>
      <span class="n">tt</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">E</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="n">loge</span><span class="p">);</span>

    <span class="n">ICVal</span> <span class="o">=</span> <span class="n">SynchVal</span> <span class="o">=</span> <span class="n">BremsVal</span> <span class="o">=</span> <span class="n">ppVal</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ElectronVector</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">CalculateDifferentialGammaEmission</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
      <span class="n">ICVal</span> <span class="o">=</span> <span class="n">GetDifferentialICFlux</span><span class="p">();</span>
      <span class="n">SynchVal</span> <span class="o">=</span> <span class="n">GetDifferentialSynchFlux</span><span class="p">();</span>
      <span class="n">BremsVal</span> <span class="o">=</span> <span class="n">GetDifferentialBremsFlux</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span>
      <span class="n">ICVal</span> <span class="o">=</span> <span class="n">SynchVal</span> <span class="o">=</span> <span class="n">BremsVal</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ProtonVector</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">CalculateDifferentialGammaEmission</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="n">ppVal</span> <span class="o">=</span> <span class="n">GetDifferentialPPFlux</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span>
      <span class="n">ppVal</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
    <span class="n">diffSpec</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">());</span>
    <span class="n">diffSpec</span><span class="p">[</span><span class="n">diffSpec</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">push_back</span><span class="p">(</span><span class="n">E</span><span class="p">);</span>
    <span class="n">diffSpec</span><span class="p">[</span><span class="n">diffSpec</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">ppVal</span> <span class="o">+</span> <span class="n">ICVal</span> <span class="o">+</span> <span class="n">BremsVal</span> <span class="o">+</span> <span class="n">SynchVal</span><span class="p">);</span>
    <span class="n">diffSpec</span><span class="p">[</span><span class="n">diffSpec</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">push_back</span><span class="p">(</span><span class="n">ppVal</span><span class="p">);</span>
    <span class="n">diffSpec</span><span class="p">[</span><span class="n">diffSpec</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">push_back</span><span class="p">(</span><span class="n">ICVal</span><span class="p">);</span>
    <span class="n">diffSpec</span><span class="p">[</span><span class="n">diffSpec</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">push_back</span><span class="p">(</span><span class="n">BremsVal</span><span class="p">);</span>
    <span class="n">diffSpec</span><span class="p">[</span><span class="n">diffSpec</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">push_back</span><span class="p">(</span><span class="n">SynchVal</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">QUIETMODE</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;    -&gt; DONE!   &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;&gt;&gt; SED CALCULATION DONE. EXITING.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Return the differential photon spectra dN/dE [number of photons/(erg*s*cm^2)]</span>
<span class="cm"> * vs E [erg] in a 2D-Vector</span>
<span class="cm"> * between the energies #emin and #emax. The argument #i determines the spectral</span>
<span class="cm"> * component to return:</span>
<span class="cm"> * - i = 1 : total spectrum</span>
<span class="cm"> * - i = 2 : pi0 decay</span>
<span class="cm"> * - i = 3 : IC scattering</span>
<span class="cm"> * - i = 4 : Bremsstrahlung</span>
<span class="cm"> * - i = 5 : Synchrotron radiation</span>
<span class="cm"> */</span>
<span class="n">vector</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">Radiation</span><span class="o">::</span><span class="n">ReturnDifferentialPhotonSpectrum</span><span class="p">(</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="kt">double</span> <span class="n">emin</span><span class="p">,</span> <span class="kt">double</span> <span class="n">emax</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">tempVec</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">diffSpec</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Radiation::ReturnDifferentialSpectrum: Differential spectrum &quot;</span>
            <span class="s">&quot;vector empty. Fill it via &quot;</span>
            <span class="s">&quot;Radiation::CalculateDifferentialSpectrum() first! Returning empty &quot;</span>
            <span class="s">&quot;vector.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">tempVec</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kt">double</span> <span class="n">e</span><span class="p">,</span> <span class="n">dNdE</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">diffSpec</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">diffSpec</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">dNdE</span> <span class="o">=</span> <span class="n">diffSpec</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">e</span> <span class="o">&lt;</span> <span class="n">emin</span> <span class="o">&amp;&amp;</span> <span class="n">emin</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">e</span> <span class="o">&gt;</span> <span class="n">emax</span> <span class="o">&amp;&amp;</span> <span class="n">emax</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dNdE</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">)</span> <span class="n">dNdE</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dNdE</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
    <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">TwoDVectorPushBack</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="n">dNdE</span><span class="p">,</span><span class="n">tempVec</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">tempVec</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/** Return the photon SED (EdN/dE (erg/s/cm^2) vs E (TeV) in a 2D-Vector of</span>
<span class="cm"> *  i = 1 : total spectrum</span>
<span class="cm"> *  i = 2 : pi0 decay</span>
<span class="cm"> *  i = 3 : IC scattering</span>
<span class="cm"> *  i = 4 : Bremsstrahlung</span>
<span class="cm"> *  i = 5 : Synchrotron radiation</span>
<span class="cm"> */</span>
<span class="n">vector</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">Radiation</span><span class="o">::</span><span class="n">ReturnSED</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="kt">double</span> <span class="n">emin</span><span class="p">,</span> <span class="kt">double</span> <span class="n">emax</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">tempVec</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">diffSpec</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Radiation::ReturnSED: Differential spectrum vector empty. Fill it &quot;</span>
            <span class="s">&quot;via Radiation::CalculateDifferentialSpectrum() first! Returning &quot;</span>
            <span class="s">&quot;empty vector.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">tempVec</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kt">double</span> <span class="n">e</span><span class="p">,</span> <span class="n">eTeV</span><span class="p">,</span> <span class="n">dNdE</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">diffSpec</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">diffSpec</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">eTeV</span> <span class="o">=</span> <span class="n">e</span> <span class="o">/</span> <span class="n">TeV_to_erg</span><span class="p">;</span>
    <span class="n">dNdE</span> <span class="o">=</span> <span class="n">diffSpec</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">eTeV</span> <span class="o">&lt;</span> <span class="n">emin</span> <span class="o">&amp;&amp;</span> <span class="n">emin</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">eTeV</span> <span class="o">&gt;</span> <span class="n">emax</span> <span class="o">&amp;&amp;</span> <span class="n">emax</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dNdE</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">)</span> <span class="n">dNdE</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dNdE</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
    <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">TwoDVectorPushBack</span><span class="p">(</span><span class="n">eTeV</span><span class="p">,</span><span class="n">e</span> <span class="o">*</span> <span class="n">e</span> <span class="o">*</span> <span class="n">dNdE</span><span class="p">,</span><span class="n">tempVec</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">tempVec</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * Return a particle SED dN/dE vs E (erg vs TeV)</span>
<span class="cm"> */</span>
<span class="n">vector</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">Radiation</span><span class="o">::</span><span class="n">GetParticleSED</span><span class="p">(</span><span class="n">string</span> <span class="n">type</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">v</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">type</span><span class="p">.</span><span class="n">compare</span><span class="p">(</span><span class="s">&quot;electrons&quot;</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">ElectronVector</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&quot;Radiation::GetParticleSED: electron vector empty! Returning &quot;</span>
                  <span class="s">&quot;empty vector!&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
      <span class="k">return</span> <span class="n">v</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="n">v</span> <span class="o">=</span> <span class="n">ElectronVector</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">type</span><span class="p">.</span><span class="n">compare</span><span class="p">(</span><span class="s">&quot;protons&quot;</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">ProtonVector</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&quot;Radiation::GetParticleSED: proton vector empty! Returning &quot;</span>
                  <span class="s">&quot;empty vector!&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
      <span class="k">return</span> <span class="n">v</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="n">v</span> <span class="o">=</span> <span class="n">ProtonVector</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Radiation::GetParticleSED: unknown particle type &gt;&quot;</span><span class="o">&lt;&lt;</span> <span class="n">type</span> <span class="o">&lt;&lt;</span><span class="s">&quot;&lt;. &quot;</span>
            <span class="s">&quot;Supported are &#39;electrons&#39; and &#39;protons&#39;. Returning empty vector&quot;</span>
         <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">v</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">v</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">double</span> <span class="n">E</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
    <span class="kt">double</span> <span class="n">E_in_TeV</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="n">TeV_to_erg</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">N</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>

    <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">E_in_TeV</span><span class="p">;</span>
    <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">E</span><span class="o">*</span><span class="n">E</span><span class="o">*</span><span class="n">N</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">v</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/**</span>
<span class="cm"> * Integration function using the GSL QAG functionality</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">double</span> <span class="n">Radiation</span><span class="o">::</span><span class="n">Integrate</span><span class="p">(</span><span class="n">fPointer</span> <span class="n">f</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">double</span> <span class="n">emin</span><span class="p">,</span> <span class="kt">double</span> <span class="n">emax</span><span class="p">,</span>
                            <span class="kt">double</span> <span class="n">tolerance</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">double</span> <span class="n">integral</span><span class="p">,</span> <span class="n">error</span><span class="p">;</span>
  <span class="k">auto</span> <span class="n">ptr</span> <span class="o">=</span> <span class="p">[</span><span class="o">=</span><span class="p">](</span><span class="kt">double</span> <span class="n">xx</span><span class="p">)</span><span class="o">-&gt;</span><span class="kt">double</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;*</span><span class="n">f</span><span class="p">)(</span><span class="n">xx</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">x</span><span class="p">);</span>
  <span class="p">};</span>
  <span class="n">gsl_integration_workspace</span> <span class="o">*</span><span class="n">w</span> <span class="o">=</span> <span class="n">gsl_integration_workspace_alloc</span><span class="p">(</span><span class="mi">10000</span><span class="p">);</span>
  <span class="n">GSLfuncRad</span><span class="o">&lt;</span><span class="k">decltype</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">Fp</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
  <span class="n">gsl_function</span> <span class="n">F</span> <span class="o">=</span> <span class="o">*</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">gsl_function</span> <span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Fp</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">gsl_integration_qag</span><span class="p">(</span><span class="o">&amp;</span><span class="n">F</span><span class="p">,</span> <span class="n">emin</span><span class="p">,</span> <span class="n">emax</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tolerance</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">integral</span><span class="p">,</span>
                          <span class="o">&amp;</span><span class="n">error</span><span class="p">))</span>
    <span class="k">return</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="n">gsl_integration_workspace_free</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">integral</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">vector</span><span class="o">&lt;</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">Radiation</span><span class="o">::</span><span class="n">GetTargetPhotons</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">vector</span><span class="o">&lt;</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="o">&gt;</span>  <span class="n">vint</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">TargetPhotonVector</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
  <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">double</span> <span class="n">e</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span><span class="n">TargetPhotonVector</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
    <span class="kt">double</span> <span class="n">n</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span><span class="n">TargetPhotonVector</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
    <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">TwoDVectorPushBack</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">vint</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">vint</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="radiation_header.html" class="btn btn-neutral float-right" title="Radiation: header" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="radiation_members.html" class="btn btn-neutral" title="Radiation: public members" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Joachim Hahn.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.9',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>