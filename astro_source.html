

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Astro: source &mdash; GAMERA 0.9 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="GAMERA 0.9 documentation" href="index.html"/>
        <link rel="up" title="Astro" href="astro.html"/>
        <link rel="next" title="Astro: header" href="astro_header.html"/>
        <link rel="prev" title="Astro" href="astro.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> GAMERA
          

          
          </a>

          
            
            
              <div class="version">
                0.9
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation and Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">Tutorial</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="classes.html">Class Documentation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="radiation.html">Radiation</a></li>
<li class="toctree-l2"><a class="reference internal" href="particles.html">Particles</a></li>
<li class="toctree-l2"><a class="reference internal" href="utils.html">Utils</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="astro.html">Astro</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="">Astro: source</a></li>
<li class="toctree-l3"><a class="reference internal" href="astro_header.html">Astro: header</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">GAMERA</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
          <li><a href="classes.html">Class Documentation</a> &raquo;</li>
      
          <li><a href="astro.html">Astro</a> &raquo;</li>
      
    <li>Astro: source</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/astro_source.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="astro-source">
<h1>Astro: source<a class="headerlink" href="#astro-source" title="Permalink to this headline">Â¶</a></h1>
<div class="highlight-C++"><div class="highlight"><pre><span class="cp">#include &quot;Astro.h&quot;</span>

<span class="n">Astro</span><span class="o">::</span><span class="n">Astro</span><span class="p">()</span> <span class="p">{</span>

  <span class="n">fUtils</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Utils</span><span class="p">();</span>
  <span class="n">QUIETMODE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="cm">/* Standard assumption of 4 spiral arms */</span>
  <span class="n">ArmsVector</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="n">ArmsVector</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
  <span class="n">ArmsVector</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
  <span class="n">ArmsVector</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>

  <span class="n">accArm1</span> <span class="o">=</span> <span class="n">gsl_interp_accel_alloc</span><span class="p">();</span>
  <span class="n">accArm2</span> <span class="o">=</span> <span class="n">gsl_interp_accel_alloc</span><span class="p">();</span>
  <span class="n">accArm3</span> <span class="o">=</span> <span class="n">gsl_interp_accel_alloc</span><span class="p">();</span>
  <span class="n">accArm4</span> <span class="o">=</span> <span class="n">gsl_interp_accel_alloc</span><span class="p">();</span>

  <span class="n">TaylorCordesArm1</span> <span class="o">=</span> <span class="n">gsl_spline_alloc</span><span class="p">(</span><span class="n">gsl_interp_linear</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
  <span class="n">TaylorCordesArm2</span> <span class="o">=</span> <span class="n">gsl_spline_alloc</span><span class="p">(</span><span class="n">gsl_interp_linear</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
  <span class="n">TaylorCordesArm3</span> <span class="o">=</span> <span class="n">gsl_spline_alloc</span><span class="p">(</span><span class="n">gsl_interp_linear</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
  <span class="n">TaylorCordesArm4</span> <span class="o">=</span> <span class="n">gsl_spline_alloc</span><span class="p">(</span><span class="n">gsl_interp_linear</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>

  <span class="n">TaylorCordesArm1Inv</span> <span class="o">=</span> <span class="n">gsl_spline_alloc</span><span class="p">(</span><span class="n">gsl_interp_linear</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
  <span class="n">TaylorCordesArm2Inv</span> <span class="o">=</span> <span class="n">gsl_spline_alloc</span><span class="p">(</span><span class="n">gsl_interp_linear</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
  <span class="n">TaylorCordesArm3Inv</span> <span class="o">=</span> <span class="n">gsl_spline_alloc</span><span class="p">(</span><span class="n">gsl_interp_linear</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
  <span class="n">TaylorCordesArm4Inv</span> <span class="o">=</span> <span class="n">gsl_spline_alloc</span><span class="p">(</span><span class="n">gsl_interp_linear</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>

  <span class="cm">/*  Spline implementation of the Taylor &amp; Cordes arms */</span>
  <span class="n">x_a1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mf">3.53</span><span class="p">;</span>   <span class="n">y_a1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mf">164.</span><span class="o">-</span><span class="mf">90.</span><span class="p">;</span>
  <span class="n">x_a1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="mf">3.76</span><span class="p">;</span>   <span class="n">y_a1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="mf">200.</span><span class="o">-</span><span class="mf">90.</span><span class="p">;</span>
  <span class="n">x_a1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="mf">4.44</span><span class="p">;</span>   <span class="n">y_a1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="mf">240.</span><span class="o">-</span><span class="mf">90.</span><span class="p">;</span>
  <span class="n">x_a1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="mf">5.24</span><span class="p">;</span>   <span class="n">y_a1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="mf">280.</span><span class="o">-</span><span class="mf">90.</span><span class="p">;</span>
  <span class="n">x_a1</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="mf">5.36</span><span class="p">;</span>   <span class="n">y_a1</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="mf">290.</span><span class="o">-</span><span class="mf">90.</span><span class="p">;</span>
  <span class="n">x_a1</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">=</span><span class="mf">5.81</span><span class="p">;</span>   <span class="n">y_a1</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">=</span><span class="mf">315.</span><span class="o">-</span><span class="mf">90.</span><span class="p">;</span>
  <span class="c1">//x_a1[6]=5.8101; y_a1[6]=330.-90.; FIXME this last point breaks interoplation</span>

  <span class="n">gsl_spline_init</span><span class="p">(</span><span class="n">TaylorCordesArm1</span><span class="p">,</span> <span class="n">x_a1</span><span class="p">,</span> <span class="n">y_a1</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
  <span class="n">gsl_spline_init</span><span class="p">(</span><span class="n">TaylorCordesArm1Inv</span><span class="p">,</span> <span class="n">y_a1</span><span class="p">,</span> <span class="n">x_a1</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

  <span class="n">x_a2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mf">3.76</span><span class="p">;</span>  <span class="n">y_a2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mf">63.</span><span class="o">-</span><span class="mf">90.</span><span class="p">;</span>
  <span class="n">x_a2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="mf">4.56</span><span class="p">;</span>  <span class="n">y_a2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="mf">120.</span><span class="o">-</span><span class="mf">90.</span><span class="p">;</span>
  <span class="n">x_a2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="mf">4.79</span><span class="p">;</span>  <span class="n">y_a2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="mf">160.</span><span class="o">-</span><span class="mf">90.</span><span class="p">;</span>
  <span class="n">x_a2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="mf">5.70</span><span class="p">;</span>  <span class="n">y_a2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="mf">200.</span><span class="o">-</span><span class="mf">90.</span><span class="p">;</span>
  <span class="n">x_a2</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="mf">6.49</span><span class="p">;</span>  <span class="n">y_a2</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="mf">220.</span><span class="o">-</span><span class="mf">90.</span><span class="p">;</span>
  <span class="n">x_a2</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">=</span><span class="mf">7.29</span><span class="p">;</span>  <span class="n">y_a2</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">=</span><span class="mf">250.</span><span class="o">-</span><span class="mf">90.</span><span class="p">;</span>
  <span class="n">x_a2</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">=</span><span class="mf">8.20</span><span class="p">;</span>  <span class="n">y_a2</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">=</span><span class="mf">288.</span><span class="o">-</span><span class="mf">90.</span><span class="p">;</span>

  <span class="n">gsl_spline_init</span><span class="p">(</span><span class="n">TaylorCordesArm2</span><span class="p">,</span> <span class="n">x_a2</span><span class="p">,</span> <span class="n">y_a2</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
  <span class="n">gsl_spline_init</span><span class="p">(</span><span class="n">TaylorCordesArm2Inv</span><span class="p">,</span> <span class="n">y_a2</span><span class="p">,</span> <span class="n">x_a2</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>

  <span class="n">x_a3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mf">4.90</span><span class="p">;</span>  <span class="n">y_a3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mf">52.</span><span class="o">-</span><span class="mf">90.</span><span class="p">;</span>
  <span class="n">x_a3</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="mf">6.27</span><span class="p">;</span>  <span class="n">y_a3</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="mf">120.</span><span class="o">-</span><span class="mf">90.</span><span class="p">;</span>
  <span class="n">x_a3</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="mf">6.49</span><span class="p">;</span>  <span class="n">y_a3</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="mf">170.</span><span class="o">-</span><span class="mf">90.</span><span class="p">;</span>
  <span class="n">x_a3</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="mf">6.95</span><span class="p">;</span>  <span class="n">y_a3</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="mf">180.</span><span class="o">-</span><span class="mf">90.</span><span class="p">;</span>
  <span class="n">x_a3</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="mf">8.20</span><span class="p">;</span>  <span class="n">y_a3</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="mf">200.</span><span class="o">-</span><span class="mf">90.</span><span class="p">;</span>
  <span class="n">x_a3</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">=</span><span class="mf">8.89</span><span class="p">;</span>  <span class="n">y_a3</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">=</span><span class="mf">220.</span><span class="o">-</span><span class="mf">90.</span><span class="p">;</span>
  <span class="n">x_a3</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">=</span><span class="mf">9.57</span><span class="p">;</span>  <span class="n">y_a3</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">=</span><span class="mf">252.</span><span class="o">-</span><span class="mf">90.</span><span class="p">;</span>

  <span class="n">gsl_spline_init</span><span class="p">(</span><span class="n">TaylorCordesArm3</span><span class="p">,</span> <span class="n">x_a3</span><span class="p">,</span> <span class="n">y_a3</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
  <span class="n">gsl_spline_init</span><span class="p">(</span><span class="n">TaylorCordesArm3Inv</span><span class="p">,</span> <span class="n">y_a3</span><span class="p">,</span> <span class="n">x_a3</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>

  <span class="n">x_a4</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mf">5.92</span><span class="p">;</span>  <span class="n">y_a4</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mf">20.</span><span class="o">-</span><span class="mf">90.</span><span class="p">;</span>
  <span class="n">x_a4</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="mf">7.06</span><span class="p">;</span>  <span class="n">y_a4</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="mf">70.</span><span class="o">-</span><span class="mf">90.</span><span class="p">;</span>
  <span class="n">x_a4</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="mf">7.86</span><span class="p">;</span>  <span class="n">y_a4</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="mf">100.</span><span class="o">-</span><span class="mf">90.</span><span class="p">;</span>
  <span class="n">x_a4</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="mf">9.68</span><span class="p">;</span>  <span class="n">y_a4</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="mf">160.</span><span class="o">-</span><span class="mf">90.</span><span class="p">;</span>
  <span class="n">x_a4</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="mf">10.37</span><span class="p">;</span>  <span class="n">y_a4</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="mf">180.</span><span class="o">-</span><span class="mf">90.</span><span class="p">;</span>
  <span class="n">x_a4</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">=</span><span class="mf">11.39</span><span class="p">;</span>  <span class="n">y_a4</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">=</span><span class="mf">200.</span><span class="o">-</span><span class="mf">90.</span><span class="p">;</span>
  <span class="n">x_a4</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">=</span><span class="mf">12.08</span><span class="p">;</span>  <span class="n">y_a4</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">=</span><span class="mf">223.</span><span class="o">-</span><span class="mf">90.</span><span class="p">;</span>

  <span class="n">gsl_spline_init</span><span class="p">(</span><span class="n">TaylorCordesArm4</span><span class="p">,</span> <span class="n">x_a4</span><span class="p">,</span> <span class="n">y_a4</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
  <span class="n">gsl_spline_init</span><span class="p">(</span><span class="n">TaylorCordesArm4Inv</span><span class="p">,</span> <span class="n">y_a4</span><span class="p">,</span> <span class="n">x_a4</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>

  <span class="n">TaylorCordesArms</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">TaylorCordesArm1</span><span class="p">);</span>
  <span class="n">TaylorCordesArms</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">TaylorCordesArm2</span><span class="p">);</span>
  <span class="n">TaylorCordesArms</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">TaylorCordesArm3</span><span class="p">);</span>
  <span class="n">TaylorCordesArms</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">TaylorCordesArm4</span><span class="p">);</span>

  <span class="n">TaylorCordesArmsInv</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">TaylorCordesArm1Inv</span><span class="p">);</span>
  <span class="n">TaylorCordesArmsInv</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">TaylorCordesArm2Inv</span><span class="p">);</span>
  <span class="n">TaylorCordesArmsInv</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">TaylorCordesArm3Inv</span><span class="p">);</span>
  <span class="n">TaylorCordesArmsInv</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">TaylorCordesArm4Inv</span><span class="p">);</span>

  <span class="cm">/* Vallee Spiral parameters */</span>
  <span class="n">psi0V</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mf">12.</span><span class="p">);</span>
  <span class="n">psi0V</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mf">12.</span><span class="p">);</span>
  <span class="n">psi0V</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mf">12.</span><span class="p">);</span>
  <span class="n">psi0V</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mf">12.</span><span class="p">);</span>
  <span class="n">theta0V</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mf">0.</span><span class="p">);</span>
  <span class="n">theta0V</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="o">-</span><span class="mf">90.</span><span class="p">);</span>
  <span class="n">theta0V</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="o">-</span><span class="mf">180.</span><span class="p">);</span>
  <span class="n">theta0V</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="o">-</span><span class="mf">270.</span><span class="p">);</span>
  <span class="n">r0V</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mf">2.72</span><span class="p">);</span>
  <span class="n">r0V</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mf">2.72</span><span class="p">);</span>
  <span class="n">r0V</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mf">2.72</span><span class="p">);</span>
  <span class="n">r0V</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mf">2.72</span><span class="p">);</span>

  <span class="n">barRadius</span> <span class="o">=</span> <span class="mf">3.6</span><span class="p">;</span>
  <span class="n">barAngle</span> <span class="o">=</span> <span class="mf">14.</span><span class="p">;</span>

  <span class="n">armWidth</span> <span class="o">=</span> <span class="mf">0.56</span><span class="p">;</span>

  <span class="n">rMax</span> <span class="o">=</span> <span class="mf">16.</span><span class="p">;</span>

  <span class="n">SPIRALARMMODEL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">SURFACEDENSITYMODEL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">CENTRALSTRUCTUREMODEL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">MSBUBBLEMODEL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="n">rMinInternalBoundary</span> <span class="o">=</span> <span class="mf">1.e-5</span><span class="o">*</span><span class="n">pc_to_cm</span><span class="p">;</span>
  <span class="n">rMaxInternalBoundary</span> <span class="o">=</span> <span class="mf">100.</span><span class="o">*</span><span class="n">pc_to_cm</span><span class="p">;</span>
  <span class="n">tMinInternalBoundary</span> <span class="o">=</span> <span class="mf">0.01</span><span class="o">*</span><span class="n">yr_to_sec</span><span class="p">;</span>
  <span class="n">tMaxInternalBoundary</span> <span class="o">=</span> <span class="mf">1.e7</span><span class="o">*</span><span class="n">yr_to_sec</span><span class="p">;</span>

  <span class="n">thinshellsolutiontmin</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="n">thinshellsolutiontmax</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>

  <span class="n">atsrad</span> <span class="o">=</span> <span class="n">gsl_interp_accel_alloc</span><span class="p">();</span>
  <span class="n">atsvel</span> <span class="o">=</span> <span class="n">gsl_interp_accel_alloc</span><span class="p">();</span>
  <span class="n">aredr</span> <span class="o">=</span> <span class="n">gsl_interp_accel_alloc</span><span class="p">();</span>
  <span class="n">avedr</span> <span class="o">=</span> <span class="n">gsl_interp_accel_alloc</span><span class="p">();</span>
  <span class="n">aredf</span> <span class="o">=</span> <span class="n">gsl_interp_accel_alloc</span><span class="p">();</span>
  <span class="n">avedf</span> <span class="o">=</span> <span class="n">gsl_interp_accel_alloc</span><span class="p">();</span>
  <span class="n">arstr</span> <span class="o">=</span> <span class="n">gsl_interp_accel_alloc</span><span class="p">();</span>
  <span class="n">avstr</span> <span class="o">=</span> <span class="n">gsl_interp_accel_alloc</span><span class="p">();</span>
  <span class="n">arstf</span> <span class="o">=</span> <span class="n">gsl_interp_accel_alloc</span><span class="p">();</span>
  <span class="n">avstf</span> <span class="o">=</span> <span class="n">gsl_interp_accel_alloc</span><span class="p">();</span>

<span class="p">}</span>

<span class="n">Astro</span><span class="o">::~</span><span class="n">Astro</span><span class="p">()</span> <span class="p">{}</span>


<span class="cm">/*    ------        SNR PROGENITOR STUFF       ------    */</span>

<span class="cm">/* Dice an initial star mass following the Salpeter law */</span>
<span class="kt">double</span> <span class="n">Astro</span><span class="o">::</span><span class="n">RandomSalpeterInitialMass</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">double</span> <span class="n">initialMass</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">PowerLawRandom</span><span class="p">(</span><span class="mf">2.35</span><span class="p">,</span><span class="mf">8.</span><span class="p">,</span><span class="mf">100.</span><span class="p">,</span><span class="mf">1.</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
  <span class="k">return</span> <span class="n">initialMass</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * calculate the radius created by the main sequence wind of a star.</span>
<span class="cm"> * Implemented at the moment are the classical Weaver model (1977) and</span>
<span class="cm"> * the empirical relation found by Chen et al. 2013</span>
<span class="cm"> */</span>
<span class="kt">double</span> <span class="n">Astro</span><span class="o">::</span><span class="n">MainSequenceBubbleRadius</span><span class="p">(</span><span class="kt">double</span> <span class="n">mDotMS</span><span class="p">,</span> <span class="kt">double</span> <span class="n">vMSWind</span><span class="p">,</span> <span class="kt">double</span> <span class="n">timeMS</span><span class="p">,</span> <span class="kt">double</span> <span class="n">n</span><span class="p">,</span> <span class="kt">double</span> <span class="n">initialMass</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">double</span> <span class="n">bubbleRadius</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">MSBUBBLEMODEL</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* bubble radius</span>
<span class="cm">     * Astrophysical Journal, Part 1, vol. 218, Dec. 1, 1977, p. 377-395, Eq. 51</span>
<span class="cm">     */</span>
    <span class="kt">double</span> <span class="n">L36</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">mDotMS</span><span class="o">*</span><span class="p">(</span><span class="n">mSol</span><span class="o">/</span><span class="n">yr_to_sec</span><span class="p">)</span><span class="o">*</span><span class="n">vMSWind</span><span class="o">*</span><span class="n">vMSWind</span><span class="o">/</span><span class="mf">1.e36</span><span class="p">;</span>
    <span class="n">bubbleRadius</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="n">L36</span><span class="o">/</span><span class="n">n</span><span class="p">,</span><span class="mf">0.2</span><span class="p">);</span>
    <span class="n">bubbleRadius</span> <span class="o">*=</span> <span class="mf">27.</span><span class="o">*</span><span class="n">pow</span><span class="p">(</span><span class="n">timeMS</span><span class="o">/</span><span class="mf">1.e6</span><span class="p">,</span><span class="mf">0.6</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">MSBUBBLEMODEL</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* Chen et al., ApJL, 769:L16 (5pp), 2013 May 20</span>
<span class="cm">     * I have my doubts about</span>
<span class="cm">     * this because quoted interclump pressures don&#39;t</span>
<span class="cm">     * fit to the average values I use in my model but</span>
<span class="cm">     * rather dense molecular clouds. (i.e. p_5 = 1)</span>
<span class="cm">     */</span>
    <span class="n">bubbleRadius</span> <span class="o">=</span> <span class="o">-</span><span class="mf">9.15402</span><span class="o">+</span><span class="mf">1.21532</span><span class="o">*</span><span class="n">initialMass</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">randomfactor</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">GaussianRandom</span><span class="p">(</span><span class="mf">0.2</span><span class="o">*</span><span class="n">bubbleRadius</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
    <span class="k">while</span><span class="p">(</span><span class="n">randomfactor</span><span class="o">&lt;-</span><span class="n">bubbleRadius</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">randomfactor</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">GaussianRandom</span><span class="p">(</span><span class="mf">0.2</span><span class="o">*</span><span class="n">bubbleRadius</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="n">bubbleRadius</span> <span class="o">+=</span> <span class="n">randomfactor</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&quot;Astro::MainSequenceBubbleRadius: Specify valid model (at the moment either &#39;Weaver&#39; or &#39;Chen&#39;! Returning 0 value.&quot;</span><span class="o">&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
  <span class="n">bubbleRadius</span> <span class="o">*=</span> <span class="n">pc_to_cm</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">bubbleRadius</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * Density inside the main-sequence wind blown bubble.</span>
<span class="cm"> */</span>
<span class="kt">double</span> <span class="n">Astro</span><span class="o">::</span><span class="n">CalculateMSBubbleDensity</span><span class="p">(</span><span class="kt">double</span> <span class="n">mDotMS</span><span class="p">,</span> <span class="kt">double</span> <span class="n">vMSWind</span><span class="p">,</span> <span class="kt">double</span> <span class="n">timeMS</span><span class="p">,</span> <span class="kt">double</span> <span class="n">n</span><span class="p">,</span> <span class="kt">double</span> <span class="n">bubbleRadius</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">double</span> <span class="n">bubbleDensity</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">MSBUBBLEMODEL</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* Castor, McCray, Weaver 1975</span>
<span class="cm">     *(Astrophysical Journal, vol. 200, Sept. 1, 1975, pt. 2, p. L107-L110),</span>
<span class="cm">     * Eq. 8</span>
<span class="cm">     */</span>
    <span class="kt">double</span> <span class="n">L</span> <span class="o">=</span> <span class="p">(</span><span class="n">mDotMS</span><span class="o">/</span><span class="mf">1.e-6</span><span class="p">)</span><span class="o">*</span><span class="n">pow</span><span class="p">(</span><span class="n">vMSWind</span><span class="o">/</span><span class="mf">2.e8</span><span class="p">,</span><span class="mf">2.</span><span class="p">);</span>
    <span class="n">bubbleDensity</span> <span class="o">=</span> <span class="mf">0.01</span><span class="o">*</span><span class="n">pow</span><span class="p">(</span><span class="n">pow</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="mf">6.</span><span class="p">)</span><span class="o">*</span><span class="n">pow</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mf">19.</span><span class="p">)</span><span class="o">*</span><span class="n">pow</span><span class="p">(</span><span class="n">timeMS</span><span class="o">/</span><span class="mf">1.e6</span><span class="p">,</span><span class="o">-</span><span class="mf">22.</span><span class="p">),</span><span class="mf">1.</span><span class="o">/</span><span class="mf">35.</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">else</span> <span class="p">{</span>
    <span class="cm">/* Chevalier et al 1989</span>
<span class="cm">     * (ApJ, vol. 344, Sept. 1, 1989, p. 332-340)</span>
<span class="cm">     * Eq 2.5</span>
<span class="cm">     */</span>
    <span class="kt">double</span> <span class="n">totalMassLoss</span> <span class="o">=</span> <span class="n">mDotMS</span><span class="o">*</span><span class="n">timeMS</span><span class="p">;</span>
    <span class="n">bubbleDensity</span> <span class="o">=</span> <span class="mf">2.e-27</span><span class="o">*</span><span class="n">totalMassLoss</span><span class="o">*</span><span class="n">pow</span><span class="p">(</span><span class="n">bubbleRadius</span><span class="o">/</span><span class="n">pc_to_cm</span><span class="o">/</span><span class="mf">20.</span><span class="p">,</span><span class="o">-</span><span class="mf">3.</span><span class="p">)</span><span class="o">/</span><span class="n">m_p_g</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">bubbleDensity</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Time on the main sequence in years as a function of initial star mass.</span>
<span class="cm"> * This is empirical from my own fit to data compiled by</span>
<span class="cm"> * Chen et al., ApJL, 769:L16 (5pp), 2013 May 20</span>
<span class="cm"> * his time estimates are based on Schaller1992</span>
<span class="cm"> */</span>
<span class="kt">double</span> <span class="n">Astro</span><span class="o">::</span><span class="n">CalculateTimeOnMainSequence</span><span class="p">(</span><span class="kt">double</span> <span class="n">initialMass</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">double</span> <span class="n">timeMS</span> <span class="o">=</span> <span class="mf">1.29098e+06</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="mf">1.11877e+01</span><span class="o">*</span><span class="n">pow</span><span class="p">(</span><span class="n">initialMass</span><span class="p">,</span><span class="o">-</span><span class="mf">0.6</span><span class="p">));</span>
  <span class="k">return</span> <span class="n">timeMS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Main sequence wind mass luminosity as a function of initial star mass.</span>
<span class="cm"> * This is empirical from my own fit to data compiled by</span>
<span class="cm"> * Chen et al., ApJL, 769:L16 (5pp), 2013 May 20</span>
<span class="cm"> */</span>
<span class="kt">double</span> <span class="n">Astro</span><span class="o">::</span><span class="n">CalculateMSMassLuminosity</span><span class="p">(</span><span class="kt">double</span> <span class="n">initialMass</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">double</span> <span class="n">mDotMS</span> <span class="o">=</span> <span class="mf">1.e-29</span><span class="o">*</span><span class="n">pow</span><span class="p">(</span><span class="n">initialMass</span><span class="p">,</span><span class="mf">20.</span><span class="p">);</span>
  <span class="n">mDotMS</span> <span class="o">*=</span> <span class="n">pow</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">pow</span><span class="p">(</span><span class="n">initialMass</span><span class="o">/</span><span class="mf">11.</span><span class="p">,</span><span class="mf">1.</span><span class="o">/</span><span class="mf">0.1</span><span class="p">),(</span><span class="mf">3.3</span><span class="o">-</span><span class="mf">20.</span><span class="p">)</span><span class="o">*</span><span class="mf">0.1</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">mDotMS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Main sequence wind speed as a function of initial star mass.</span>
<span class="cm"> * This is empirical from my own fit to data compiled by</span>
<span class="cm"> * Chen et al., ApJL, 769:L16 (5pp), 2013 May 20</span>
<span class="cm"> */</span>
<span class="kt">double</span> <span class="n">Astro</span><span class="o">::</span><span class="n">CalculateMSWindSpeed</span><span class="p">(</span><span class="kt">double</span> <span class="n">initialMass</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">double</span> <span class="n">vMSWind</span> <span class="o">=</span> <span class="mf">1.e7</span> <span class="o">+</span> <span class="mf">6.0e6</span><span class="o">*</span><span class="n">initialMass</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">vMSWind</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Radius of the red giant wind zone (Chevalier2004) //TODO find paper again!</span>
<span class="cm"> */</span>
<span class="kt">double</span> <span class="n">Astro</span><span class="o">::</span><span class="n">CalculateRGWRadius</span><span class="p">(</span><span class="kt">double</span> <span class="n">pBubble</span><span class="p">,</span> <span class="kt">double</span> <span class="n">mDotRGW</span><span class="p">,</span> <span class="kt">double</span> <span class="n">vRGWind</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">pBubble</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* Typical bubble pressure (Chevalier) with 30% Gaussian scatter */</span>
    <span class="n">pBubble</span> <span class="o">=</span> <span class="mf">1.36e-16</span><span class="o">*</span><span class="mf">1.e4</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">randomfactor</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">GaussianRandom</span><span class="p">(</span><span class="mf">0.3</span><span class="o">*</span><span class="n">pBubble</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
    <span class="k">while</span><span class="p">(</span><span class="n">randomfactor</span><span class="o">&lt;=-</span><span class="n">pBubble</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">randomfactor</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">GaussianRandom</span><span class="p">(</span><span class="mf">0.3</span><span class="o">*</span><span class="n">pBubble</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="n">pBubble</span> <span class="o">+=</span> <span class="n">randomfactor</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kt">double</span> <span class="n">RGWRadius</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="mf">0.881</span><span class="o">*</span><span class="n">mDotRGW</span><span class="o">*</span><span class="p">(</span><span class="n">mSol</span><span class="o">/</span><span class="n">yr_to_sec</span><span class="p">)</span><span class="o">*</span><span class="n">vRGWind</span><span class="o">/</span><span class="p">(</span><span class="mf">4.</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">pBubble</span><span class="p">));</span>
  <span class="k">return</span> <span class="n">RGWRadius</span><span class="p">;</span>
<span class="p">}</span>


<span class="n">vector</span><span class="o">&lt;</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">Astro</span><span class="o">::</span><span class="n">CreateDensityProfile</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">pars</span><span class="p">,</span>
                                                    <span class="kt">double</span> <span class="n">rmin</span><span class="p">,</span> <span class="kt">double</span> <span class="n">rmax</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">vector</span><span class="o">&lt;</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">dProfile</span><span class="p">;</span>

  <span class="k">if</span><span class="p">(</span><span class="n">pars</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">!=</span><span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Astro::CreateDensityProfile: wrong number of parameters (&quot;</span>
         <span class="o">&lt;&lt;</span> <span class="n">pars</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;). Parameter list takes exactly 8 &quot;</span>
            <span class="s">&quot;parameters: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; - [0] red giant wind radius (pc) &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; - [1] mass loss rate of progenitor red giant (mSol/yr) &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; - [2] red giant wind speed (cm/s) &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; - [3] radius of main-seqence wind bubble (MSWB) (pc) &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; - [4] density inside MSWB (cm^-3) &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; - [5] density of the ISM (cm^-3) &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; - [6] width of the shell at RGW-&gt;MSWB transition (pc) &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; - [7] width of the shell at MSWB-&gt;ISM transition (pc) &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Returning empty vector!&quot;</span> <span class="o">&lt;&lt;</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">dProfile</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="n">rmin</span> <span class="o">&gt;=</span> <span class="n">rmax</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Astro::CreateDensityProfile: lower radius boundary larger than &quot;</span>
            <span class="s">&quot;upper boundary (&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">rmin</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &gt; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">rmax</span> <span class="o">&lt;&lt;</span><span class="s">&quot;). Returning &quot;</span>
            <span class="s">&quot;empty vector. &quot;</span> <span class="o">&lt;&lt;</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">dProfile</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kt">double</span> <span class="n">RGWRadius</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">pc_to_cm</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">mDotRGWind</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">mSol</span><span class="o">/</span><span class="n">yr_to_sec</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">vRGWind</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">MSBubbleRadius</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">pc_to_cm</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">MSBubbleDensity</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">ISMDensity</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">rSWRGW</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">pc_to_cm</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">rSWMS</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">*</span><span class="n">pc_to_cm</span><span class="p">;</span>
  <span class="n">rmin</span> <span class="o">*=</span> <span class="n">pc_to_cm</span><span class="p">;</span>
  <span class="n">rmax</span> <span class="o">*=</span> <span class="n">pc_to_cm</span><span class="p">;</span>
  <span class="cm">/* calculate the mass that has been swept up by either the RGW or the wind bubble material moving backwards into the RGW */</span>
  <span class="kt">double</span> <span class="n">mSWRGW</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">rTransRGWMS</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">mDotRGWind</span><span class="o">/</span><span class="p">(</span><span class="mf">4.</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">MSBubbleDensity</span><span class="o">*</span><span class="n">vRGWind</span><span class="p">));</span>
  <span class="k">if</span><span class="p">(</span><span class="n">RGWRadius</span><span class="o">&gt;</span><span class="n">rTransRGWMS</span><span class="p">)</span> <span class="n">mSWRGW</span><span class="o">=</span><span class="n">mDotRGWind</span><span class="o">*</span><span class="p">(</span><span class="n">RGWRadius</span><span class="o">-</span><span class="n">rTransRGWMS</span><span class="p">)</span><span class="o">/</span><span class="n">vRGWind</span><span class="o">/</span><span class="n">m_p_g</span><span class="p">;</span>
  <span class="k">else</span> <span class="n">mSWRGW</span><span class="o">=</span><span class="mf">4.</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">MSBubbleDensity</span><span class="o">*</span><span class="p">(</span><span class="n">pow</span><span class="p">(</span><span class="n">rTransRGWMS</span><span class="p">,</span><span class="mf">3.</span><span class="p">)</span><span class="o">-</span><span class="n">pow</span><span class="p">(</span><span class="n">RGWRadius</span><span class="p">,</span><span class="mf">3.</span><span class="p">));</span>
  <span class="cm">/* calculate the mass that has been swept by the main sequence wind */</span>
  <span class="kt">double</span> <span class="n">mSWMS</span> <span class="o">=</span> <span class="mf">4.</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">ISMDensity</span><span class="o">*</span><span class="n">pow</span><span class="p">(</span><span class="n">MSBubbleRadius</span><span class="p">,</span><span class="mf">3.</span><span class="p">);</span>
  <span class="cm">/* calcutate densities in the shells */</span>
  <span class="kt">double</span> <span class="n">nSWRGW</span> <span class="o">=</span> <span class="mf">3.</span><span class="o">*</span><span class="n">mSWRGW</span><span class="o">/</span><span class="p">(</span><span class="mf">4.</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">pow</span><span class="p">(</span><span class="n">RGWRadius</span><span class="o">+</span><span class="n">rSWRGW</span><span class="p">,</span><span class="mf">3.</span><span class="p">)</span><span class="o">-</span><span class="n">pow</span><span class="p">(</span><span class="n">RGWRadius</span><span class="p">,</span><span class="mf">3.</span><span class="p">)));</span>
  <span class="kt">double</span> <span class="n">nSWMS</span> <span class="o">=</span> <span class="mf">3.</span><span class="o">*</span><span class="n">mSWMS</span><span class="o">/</span><span class="p">(</span><span class="mf">4.</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">pow</span><span class="p">(</span><span class="n">MSBubbleRadius</span><span class="o">+</span><span class="n">rSWMS</span><span class="p">,</span><span class="mf">3.</span><span class="p">)</span><span class="o">-</span><span class="n">pow</span><span class="p">(</span><span class="n">MSBubbleRadius</span><span class="p">,</span><span class="mf">3.</span><span class="p">)));</span>

  <span class="kt">double</span> <span class="n">stepSizeNormal</span><span class="o">=</span><span class="n">log</span><span class="p">(</span><span class="n">rmax</span><span class="o">/</span><span class="n">rmin</span><span class="p">)</span><span class="o">/</span><span class="mf">1000.</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">stepSizeFine</span><span class="o">=</span><span class="n">stepSizeNormal</span><span class="o">/</span><span class="mf">10.</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">stepSize</span><span class="o">=</span><span class="n">stepSizeNormal</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">n</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="k">for</span><span class="p">(</span><span class="kt">double</span> <span class="n">r</span><span class="o">=</span><span class="n">rmin</span><span class="p">;</span><span class="n">r</span><span class="o">&lt;</span><span class="n">rmax</span><span class="p">;</span><span class="n">r</span><span class="o">=</span><span class="n">pow</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span><span class="n">log10</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">+</span><span class="n">stepSize</span><span class="p">))</span> <span class="p">{</span>
    <span class="cm">/* adapt step size in regions of transition */</span>
    <span class="k">if</span><span class="p">(</span><span class="n">r</span><span class="o">&lt;</span><span class="mf">0.9</span><span class="o">*</span><span class="n">RGWRadius</span><span class="p">)</span> <span class="n">stepSize</span><span class="o">=</span><span class="n">stepSizeNormal</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">r</span><span class="o">&gt;=</span><span class="mf">0.9</span><span class="o">*</span><span class="n">RGWRadius</span> <span class="o">&amp;&amp;</span> <span class="n">r</span><span class="o">&lt;</span><span class="mf">1.1</span><span class="o">*</span><span class="p">(</span><span class="n">RGWRadius</span><span class="o">+</span><span class="n">rSWRGW</span><span class="p">))</span> <span class="n">stepSize</span><span class="o">=</span><span class="n">stepSizeFine</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">r</span><span class="o">&gt;=</span><span class="mf">1.1</span><span class="o">*</span><span class="p">(</span><span class="n">RGWRadius</span><span class="o">+</span><span class="n">rSWRGW</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">r</span><span class="o">&lt;</span><span class="mf">0.9</span><span class="o">*</span><span class="n">MSBubbleRadius</span><span class="p">)</span> <span class="n">stepSize</span><span class="o">=</span><span class="n">stepSizeNormal</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">r</span><span class="o">&gt;=</span><span class="mf">0.9</span><span class="o">*</span><span class="n">MSBubbleRadius</span> <span class="o">&amp;&amp;</span> <span class="n">r</span><span class="o">&lt;</span><span class="mf">1.1</span><span class="o">*</span><span class="p">(</span><span class="n">MSBubbleRadius</span><span class="o">+</span><span class="n">rSWMS</span><span class="p">))</span> <span class="n">stepSize</span><span class="o">=</span><span class="n">stepSizeFine</span><span class="p">;</span>
    <span class="k">else</span> <span class="n">stepSize</span><span class="o">=</span><span class="n">stepSizeNormal</span><span class="p">;</span>

    <span class="cm">/* calculate density */</span>
    <span class="k">if</span><span class="p">(</span><span class="n">r</span><span class="o">&lt;</span><span class="n">MSBubbleRadius</span><span class="p">){</span>
      <span class="k">if</span><span class="p">(</span><span class="n">r</span><span class="o">&lt;</span><span class="n">RGWRadius</span><span class="p">)</span> <span class="n">n</span> <span class="o">=</span> <span class="n">mDotRGWind</span><span class="o">/</span><span class="p">(</span><span class="mf">4.</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">vRGWind</span><span class="o">*</span><span class="n">r</span><span class="o">*</span><span class="n">r</span><span class="p">)</span><span class="o">/</span><span class="n">m_p_g</span><span class="p">;</span>
      <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">r</span><span class="o">&gt;=</span><span class="n">RGWRadius</span> <span class="o">&amp;&amp;</span> <span class="n">r</span><span class="o">&lt;</span><span class="n">RGWRadius</span><span class="o">+</span><span class="n">rSWRGW</span><span class="p">)</span> <span class="n">n</span> <span class="o">=</span> <span class="n">nSWRGW</span><span class="p">;</span>
      <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">r</span><span class="o">&gt;=</span><span class="n">RGWRadius</span><span class="o">+</span><span class="n">rSWRGW</span> <span class="o">&amp;&amp;</span> <span class="n">r</span><span class="o">&lt;</span><span class="n">MSBubbleRadius</span><span class="p">)</span> <span class="n">n</span> <span class="o">=</span> <span class="n">MSBubbleDensity</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">r</span><span class="o">&gt;=</span><span class="n">MSBubbleRadius</span> <span class="o">&amp;&amp;</span> <span class="n">r</span><span class="o">&lt;</span><span class="n">MSBubbleRadius</span><span class="o">+</span><span class="n">rSWMS</span><span class="p">)</span> <span class="n">n</span> <span class="o">=</span> <span class="n">nSWMS</span><span class="p">;</span>
    <span class="k">else</span> <span class="n">n</span> <span class="o">=</span> <span class="n">ISMDensity</span><span class="p">;</span>
    <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">TwoDVectorPushBack</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">dProfile</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">dProfile</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*    ------      B-Field stuff      ------ */</span>

<span class="cm">/**</span>
<span class="cm"> * 2D-Model of the large-scale galactic magnetic field structure</span>
<span class="cm"> * by Jaffe et al, 2010.</span>
<span class="cm"> * MNRAS, Volume 401, Issue 2, pp. 1013-1028</span>
<span class="cm"> * Input x and y coordinate, returns</span>
<span class="cm"> * -total B-Field at this position in the plane (B_tot)</span>
<span class="cm"> * -large-scale coherent field (B_coh)</span>
<span class="cm"> * -irregular field component along the large-scale component (B_ord)</span>
<span class="cm"> * -random field component (B_iso)</span>
<span class="cm"> * -Direction in the x-y plane of the large scale coherent field (regFieldDirection)</span>
<span class="cm"> * Note: it is only in the x-y plane at the moment, thus the z variable doesn&#39;t</span>
<span class="cm"> * do anything!</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">Astro</span><span class="o">::</span><span class="n">CalculateBField</span><span class="p">(</span><span class="kt">double</span> <span class="n">x</span><span class="p">,</span> <span class="kt">double</span> <span class="n">y</span><span class="p">,</span> <span class="kt">double</span> <span class="n">z</span><span class="p">,</span> <span class="kt">double</span> <span class="o">&amp;</span><span class="n">B_tot</span><span class="p">,</span> <span class="kt">double</span> <span class="o">&amp;</span><span class="n">B_coh</span><span class="p">,</span> <span class="kt">double</span> <span class="o">&amp;</span><span class="n">B_ord</span><span class="p">,</span> <span class="kt">double</span> <span class="o">&amp;</span><span class="n">B_iso</span><span class="p">,</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">regFieldDirection</span><span class="p">,</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">isoFieldDirection</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">regFieldDirection</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
  <span class="n">isoFieldDirection</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
  <span class="kt">double</span> <span class="n">DistanceToClosestArm</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">ClosestArm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">GetDistanceToNearestSpiralArm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">DistanceToClosestArm</span><span class="p">,</span><span class="n">ClosestArm</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">r</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">pow</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="mf">2.</span><span class="p">)</span><span class="o">+</span><span class="n">pow</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="mf">2.</span><span class="p">));</span>
  <span class="kt">double</span> <span class="n">R0</span> <span class="o">=</span> <span class="mf">20.</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">R1</span> <span class="o">=</span> <span class="mf">3.</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">R2</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">Rarms</span> <span class="o">=</span> <span class="mf">15.</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">RmolRing</span> <span class="o">=</span> <span class="mf">5.</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">Rmin</span> <span class="o">=</span> <span class="mf">3.</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">C0</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">an</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">an1</span> <span class="o">=</span> <span class="mf">1.26</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">an2</span> <span class="o">=</span> <span class="mf">1.04</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">an3</span> <span class="o">=</span> <span class="mf">0.61</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">an4</span> <span class="o">=</span> <span class="mf">1.65</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">anMolRing</span>  <span class="o">=</span> <span class="mf">1.</span><span class="p">;</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">ClosestArm</span><span class="p">){</span>
    <span class="k">case</span> <span class="mi">4</span><span class="o">:</span>
      <span class="n">an</span> <span class="o">=</span> <span class="n">an4</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
      <span class="n">an</span> <span class="o">=</span> <span class="n">an3</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
      <span class="n">an</span> <span class="o">=</span> <span class="n">an2</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
      <span class="n">an</span> <span class="o">=</span> <span class="n">an1</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kt">double</span> <span class="n">B_0</span> <span class="o">=</span> <span class="mf">1.e-6</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">d0</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">;</span> <span class="c1">//could be replaced by arm-width</span>
  <span class="kt">double</span> <span class="n">B_rms</span> <span class="o">=</span> <span class="mf">2.1e-6</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">ford</span> <span class="o">=</span> <span class="mf">1.9</span><span class="p">;</span>
  <span class="n">regFieldDirection</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mf">0.</span><span class="p">);</span>
  <span class="n">regFieldDirection</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mf">0.</span><span class="p">);</span>
  <span class="n">regFieldDirection</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mf">0.</span><span class="p">);</span>

  <span class="n">isoFieldDirection</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mf">0.</span><span class="p">);</span>
  <span class="n">isoFieldDirection</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mf">0.</span><span class="p">);</span>
  <span class="n">isoFieldDirection</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mf">0.</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="n">r</span><span class="o">&lt;</span><span class="n">Rmin</span><span class="o">||</span><span class="n">r</span><span class="o">&gt;</span><span class="n">R0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">B_coh</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
    <span class="n">B_iso</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
    <span class="n">B_ord</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
    <span class="n">B_tot</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>

    <span class="k">return</span><span class="p">;</span>

  <span class="p">}</span>
  <span class="kt">double</span> <span class="n">rhoc</span> <span class="o">=</span> <span class="n">C0</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">DistanceToClosestArm</span><span class="o">*</span><span class="n">DistanceToClosestArm</span><span class="o">/</span><span class="p">(</span><span class="n">d0</span><span class="o">*</span><span class="n">d0</span><span class="p">))</span><span class="o">+</span><span class="mf">1.</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="n">r</span><span class="o">&gt;</span><span class="n">Rarms</span><span class="p">)</span> <span class="n">rhoc</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="n">r</span><span class="o">&gt;</span><span class="n">Rmin</span> <span class="o">&amp;&amp;</span> <span class="n">r</span><span class="o">&lt;</span><span class="n">RmolRing</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">rhoc</span>  <span class="o">=</span>  <span class="n">C0</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">pow</span><span class="p">(</span><span class="n">r</span><span class="o">-</span><span class="n">RmolRing</span><span class="p">,</span><span class="mf">2.</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">d0</span><span class="o">*</span><span class="n">d0</span><span class="p">))</span><span class="o">+</span><span class="mf">1.</span><span class="p">;</span><span class="c1">///&lt; own description, since exact profile is not described in paper</span>
    <span class="n">an</span> <span class="o">=</span> <span class="n">anMolRing</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="cm">/* coherent, large scale B-field along spiral arms */</span>
  <span class="n">B_coh</span> <span class="o">=</span> <span class="n">B_0</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">r</span><span class="o">*</span><span class="n">r</span><span class="o">/</span><span class="p">(</span><span class="n">R2</span><span class="o">*</span><span class="n">R2</span><span class="p">)));</span>
  <span class="n">B_coh</span> <span class="o">*=</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">r</span><span class="o">*</span><span class="n">r</span><span class="o">/</span><span class="p">(</span><span class="n">R0</span><span class="o">*</span><span class="n">R0</span><span class="p">))</span><span class="o">+</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">r</span><span class="o">*</span><span class="n">r</span><span class="o">*</span><span class="n">r</span><span class="o">*</span><span class="n">r</span><span class="o">/</span><span class="p">(</span><span class="n">R1</span><span class="o">*</span><span class="n">R1</span><span class="o">*</span><span class="n">R1</span><span class="o">*</span><span class="n">R1</span><span class="p">));</span>
  <span class="n">B_coh</span> <span class="o">*=</span> <span class="n">rhoc</span><span class="o">*</span><span class="n">an</span><span class="p">;</span>
  <span class="cm">/* small-scale irregular component of B-field */</span> <span class="c1">//NOTE: This is only random in 2D! If 3D (incl. scatter perpendicular to the plane), the component along the arms would smaller)</span>
  <span class="n">B_iso</span> <span class="o">=</span> <span class="n">rhoc</span><span class="o">*</span><span class="n">B_rms</span><span class="p">;</span>
  <span class="cm">/* irregular component along spiral arms */</span>
  <span class="n">B_ord</span> <span class="o">=</span> <span class="n">ford</span><span class="o">*</span><span class="p">(</span><span class="n">rhoc</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span><span class="o">*</span><span class="n">B_rms</span><span class="p">;</span>
  <span class="cm">/* dice relative orientation of irregular components to coherent one */</span>
  <span class="kt">double</span> <span class="n">phi_iso</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">Random</span><span class="p">();</span>
  <span class="cm">/* Component along the coherent field lines */</span>
  <span class="kt">double</span> <span class="n">B_sumx</span> <span class="o">=</span> <span class="n">B_coh</span><span class="o">+</span><span class="n">B_iso</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">phi_iso</span><span class="p">)</span><span class="o">+</span><span class="n">B_ord</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">phi_iso</span><span class="p">);</span>
  <span class="cm">/* Component perpendicular to the coherent field lines (only isotropic field) */</span>
  <span class="kt">double</span> <span class="n">B_sumy</span> <span class="o">=</span> <span class="n">B_iso</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">phi_iso</span><span class="p">);</span>

  <span class="n">B_tot</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">B_sumx</span><span class="o">*</span><span class="n">B_sumx</span><span class="o">+</span><span class="n">B_sumy</span><span class="o">*</span><span class="n">B_sumy</span><span class="p">);</span>

  <span class="kt">double</span> <span class="n">e_B_coh</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">theta</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="mf">180.</span><span class="o">/</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="n">atan2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span><span class="o">+</span><span class="mi">90</span><span class="p">;</span>
<span class="c1">//  std::cout&lt;&lt;&quot;(x,y)=&quot;&lt;&lt;x&lt;&lt;&quot;,&quot;&lt;&lt;y&lt;&lt;&quot; &quot;&lt;&lt;theta&lt;&lt;std::endl;</span>
  <span class="kt">double</span> <span class="n">xarmclose</span><span class="p">,</span><span class="n">yarmclose</span><span class="p">,</span><span class="n">rarmclose</span><span class="p">,</span><span class="n">xarmfar</span><span class="p">,</span><span class="n">yarmfar</span><span class="p">,</span><span class="n">rarmfar</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="n">y0</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="n">y1</span><span class="p">,</span><span class="n">rtest</span><span class="p">;</span>
  <span class="n">PositionOnSpiralArmAngular</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">ClosestArm</span><span class="p">,</span> <span class="n">xarmclose</span><span class="p">,</span> <span class="n">yarmclose</span><span class="p">);</span>
  <span class="n">rarmclose</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">xarmclose</span><span class="o">*</span><span class="n">xarmclose</span><span class="o">+</span><span class="n">yarmclose</span><span class="o">*</span><span class="n">yarmclose</span><span class="p">);</span>
  <span class="n">PositionOnSpiralArmAngular</span><span class="p">(</span><span class="n">theta</span><span class="o">+</span><span class="mf">360.</span><span class="p">,</span> <span class="n">ClosestArm</span><span class="p">,</span> <span class="n">xarmfar</span><span class="p">,</span> <span class="n">yarmfar</span><span class="p">);</span>
  <span class="n">rarmfar</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">xarmfar</span><span class="o">*</span><span class="n">xarmfar</span><span class="o">+</span><span class="n">yarmfar</span><span class="o">*</span><span class="n">yarmfar</span><span class="p">);</span>
  <span class="p">(</span><span class="n">fabs</span><span class="p">(</span><span class="n">r</span><span class="o">-</span><span class="n">rarmfar</span><span class="p">)</span><span class="o">&gt;</span><span class="n">fabs</span><span class="p">(</span><span class="n">r</span><span class="o">-</span><span class="n">rarmclose</span><span class="p">))</span><span class="o">?</span><span class="p">(</span><span class="n">rtest</span><span class="o">=</span><span class="n">rarmclose</span><span class="p">)</span><span class="o">:</span>
    <span class="n">rtest</span><span class="o">=</span><span class="n">rarmfar</span><span class="p">;</span>
  <span class="n">GalacticPositionXY</span><span class="p">(</span><span class="mf">0.999</span><span class="o">*</span><span class="n">rtest</span><span class="p">,</span><span class="n">ClosestArm</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="n">y0</span><span class="p">);</span>
  <span class="n">GalacticPositionXY</span><span class="p">(</span><span class="mf">1.001</span><span class="o">*</span><span class="n">rtest</span><span class="p">,</span><span class="n">ClosestArm</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="n">y1</span><span class="p">);</span>
<span class="c1">//  std::cout&lt;&lt;r&lt;&lt;&quot; -&gt; (&quot;&lt;&lt;x0&lt;&lt;&quot;,&quot;&lt;&lt;y0&lt;&lt;&quot;)&quot;&lt;&lt;&quot; (&quot;&lt;&lt;x1&lt;&lt;&quot;,&quot;&lt;&lt;y1&lt;&lt;&quot;)&quot;&lt;&lt;std::endl;</span>
  <span class="kt">double</span> <span class="n">l</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">x1</span><span class="o">-</span><span class="n">x0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">x1</span><span class="o">-</span><span class="n">x0</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">y1</span><span class="o">-</span><span class="n">y0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">y1</span><span class="o">-</span><span class="n">y0</span><span class="p">));</span>
  <span class="n">e_B_coh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span><span class="o">-</span><span class="n">x0</span><span class="p">)</span><span class="o">/</span><span class="n">l</span><span class="p">;</span>
  <span class="n">e_B_coh</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">y1</span><span class="o">-</span><span class="n">y0</span><span class="p">)</span><span class="o">/</span><span class="n">l</span><span class="p">;</span>
  <span class="n">e_B_coh</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="n">r</span><span class="o">&gt;</span><span class="n">Rarms</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">double</span> <span class="n">weight</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="o">-</span><span class="n">Rarms</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">R0</span><span class="o">-</span><span class="n">Rarms</span><span class="p">);</span>
    <span class="kt">double</span> <span class="n">xrand</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">-</span><span class="mf">2.</span><span class="o">*</span><span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">Random</span><span class="p">();</span>
    <span class="kt">double</span> <span class="n">yrand</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">-</span><span class="mf">2.</span><span class="o">*</span><span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">Random</span><span class="p">();</span>
    <span class="kt">double</span> <span class="n">zrand</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">-</span><span class="mf">2.</span><span class="o">*</span><span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">Random</span><span class="p">();</span>

    <span class="kt">double</span> <span class="n">rrand</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">xrand</span><span class="o">*</span><span class="n">xrand</span><span class="o">+</span><span class="n">yrand</span><span class="o">*</span><span class="n">yrand</span><span class="o">+</span><span class="n">zrand</span><span class="o">*</span><span class="n">zrand</span><span class="p">);</span>
    <span class="n">xrand</span> <span class="o">/=</span> <span class="n">rrand</span><span class="p">;</span>
    <span class="n">yrand</span> <span class="o">/=</span> <span class="n">rrand</span><span class="p">;</span>
    <span class="n">zrand</span> <span class="o">/=</span> <span class="n">rrand</span><span class="p">;</span>

    <span class="n">e_B_coh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">weight</span><span class="o">*</span><span class="n">xrand</span><span class="p">;</span>
    <span class="n">e_B_coh</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">weight</span><span class="o">*</span><span class="n">yrand</span><span class="p">;</span>
    <span class="n">e_B_coh</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">weight</span><span class="o">*</span><span class="n">zrand</span><span class="p">;</span>

    <span class="kt">double</span> <span class="n">r_coh</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">e_B_coh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">e_B_coh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">e_B_coh</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">e_B_coh</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">e_B_coh</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">e_B_coh</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

    <span class="n">e_B_coh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/=</span> <span class="n">r_coh</span><span class="p">;</span>
    <span class="n">e_B_coh</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/=</span> <span class="n">r_coh</span><span class="p">;</span>
    <span class="n">e_B_coh</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/=</span> <span class="n">r_coh</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="n">r</span><span class="o">&gt;</span><span class="n">RmolRing</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">regFieldDirection</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">e_B_coh</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">regFieldDirection</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">e_B_coh</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="n">regFieldDirection</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">e_B_coh</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
  <span class="p">}</span>
<span class="c1">//  std::cout&lt;&lt;&quot;  -&gt; &quot;&lt;&lt;regFieldDirection[0]&lt;&lt;&quot;,&quot;&lt;&lt;regFieldDirection[1]&lt;&lt;&quot;,&quot;&lt;&lt;regFieldDirection[2]&lt;&lt;std::endl;</span>

  <span class="kt">double</span> <span class="n">e_B_iso</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
  <span class="n">e_B_iso</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">e_B_coh</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="n">e_B_iso</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">e_B_coh</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
  <span class="n">e_B_iso</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">e_B_coh</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
  <span class="n">RotateCoordinates</span><span class="p">(</span><span class="n">e_B_iso</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">e_B_iso</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">e_B_iso</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="n">phi_iso</span><span class="p">);</span>
  <span class="n">isoFieldDirection</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">e_B_iso</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="n">isoFieldDirection</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">e_B_iso</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
  <span class="n">isoFieldDirection</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">e_B_iso</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*  -----     AMBIENT DENSITY STUFF     ----- */</span>

<span class="cm">/**</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">double</span> <span class="n">Astro</span><span class="o">::</span><span class="n">HIDensity</span><span class="p">(</span><span class="kt">double</span> <span class="n">x</span><span class="p">,</span> <span class="kt">double</span> <span class="n">y</span><span class="p">,</span> <span class="kt">double</span> <span class="n">z</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">double</span> <span class="n">R</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">pow</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="mf">2.</span><span class="p">)</span><span class="o">+</span><span class="n">pow</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="mf">2.</span><span class="p">));</span>
  <span class="kt">double</span> <span class="n">h1density</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">norm</span> <span class="o">=</span> <span class="n">CalculateHINorm</span><span class="p">(</span><span class="n">R</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">FWHM</span> <span class="o">=</span> <span class="n">GetHIFWHM</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">/</span><span class="mf">1000.</span><span class="p">;</span>
  <span class="n">h1density</span> <span class="o">=</span> <span class="mf">0.7</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">pow</span><span class="p">(</span><span class="n">z</span><span class="o">/</span><span class="p">(</span><span class="mf">0.55</span><span class="o">*</span><span class="n">FWHM</span><span class="p">),</span><span class="mf">2.</span><span class="p">));</span>
  <span class="n">h1density</span> <span class="o">+=</span> <span class="mf">0.19</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">pow</span><span class="p">(</span><span class="n">z</span><span class="o">/</span><span class="p">(</span><span class="mf">1.38</span><span class="o">*</span><span class="n">FWHM</span><span class="p">),</span><span class="mf">2.</span><span class="p">));</span>
  <span class="n">h1density</span> <span class="o">+=</span> <span class="mf">0.11</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">fabs</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">1.75</span><span class="o">*</span><span class="n">FWHM</span><span class="p">));</span>
  <span class="n">h1density</span> <span class="o">*=</span> <span class="n">norm</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">h1density</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">double</span> <span class="n">Astro</span><span class="o">::</span><span class="n">H2Density</span><span class="p">(</span><span class="kt">double</span> <span class="n">x</span><span class="p">,</span> <span class="kt">double</span> <span class="n">y</span><span class="p">,</span> <span class="kt">double</span> <span class="n">z</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">double</span> <span class="n">R</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">pow</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="mf">2.</span><span class="p">)</span><span class="o">+</span><span class="n">pow</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="mf">2.</span><span class="p">));</span>
  <span class="kt">double</span> <span class="n">h2density</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">norm</span> <span class="o">=</span> <span class="n">CalculateH2Norm</span><span class="p">(</span><span class="n">R</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">sigma</span> <span class="o">=</span> <span class="n">GetH2FWHM</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)));</span>
  <span class="n">sigma</span> <span class="o">/=</span> <span class="mf">1000.</span><span class="p">;</span>
  <span class="n">h2density</span> <span class="o">=</span> <span class="n">norm</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">pow</span><span class="p">(</span><span class="n">z</span><span class="o">/</span><span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span><span class="o">*</span><span class="n">sigma</span><span class="p">),</span><span class="mf">2.</span><span class="p">));</span>
  <span class="k">return</span> <span class="n">h2density</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">double</span> <span class="n">Astro</span><span class="o">::</span><span class="n">CalculateHINorm</span><span class="p">(</span><span class="kt">double</span> <span class="n">R</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">double</span> <span class="n">CD</span> <span class="o">=</span> <span class="n">GetHIColumnDensity</span><span class="p">(</span><span class="n">R</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">FWHM</span> <span class="o">=</span> <span class="n">GetHIFWHM</span><span class="p">(</span><span class="n">R</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">norm</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">sigma1</span> <span class="o">=</span> <span class="mf">0.55</span><span class="o">*</span><span class="n">FWHM</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">sigma2</span> <span class="o">=</span> <span class="mf">1.38</span><span class="o">*</span><span class="n">FWHM</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">z0</span> <span class="o">=</span> <span class="mf">1.75</span><span class="o">*</span><span class="n">FWHM</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">k1</span><span class="o">=</span><span class="mf">0.7</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">k2</span><span class="o">=</span><span class="mf">0.19</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">k3</span><span class="o">=</span><span class="mf">0.11</span><span class="p">;</span>
  <span class="n">norm</span> <span class="o">=</span> <span class="n">CD</span><span class="o">/</span><span class="p">(</span><span class="mf">3.08e18</span><span class="o">*</span><span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="mf">3.1415</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">k1</span><span class="o">*</span><span class="n">sigma1</span><span class="o">+</span><span class="n">k2</span><span class="o">*</span><span class="n">sigma2</span><span class="p">)</span><span class="o">+</span><span class="mf">2.</span><span class="o">*</span><span class="n">k3</span><span class="o">*</span><span class="n">z0</span><span class="p">));</span>
  <span class="k">return</span> <span class="n">norm</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">double</span> <span class="n">Astro</span><span class="o">::</span><span class="n">CalculateH2Norm</span><span class="p">(</span><span class="kt">double</span> <span class="n">R</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">double</span> <span class="n">CD</span> <span class="o">=</span> <span class="n">GetH2ColumnDensity</span><span class="p">(</span><span class="n">R</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">FWHM</span> <span class="o">=</span> <span class="n">GetH2FWHM</span><span class="p">(</span><span class="n">R</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">norm</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">sigma</span> <span class="o">=</span> <span class="n">FWHM</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)));</span>
  <span class="k">if</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span> <span class="n">norm</span> <span class="o">=</span> <span class="n">CD</span><span class="o">/</span><span class="p">(</span><span class="mf">3.08e18</span><span class="o">*</span><span class="n">sigma</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="mf">3.1415</span><span class="p">));</span>
  <span class="k">else</span> <span class="n">norm</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">norm</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">double</span> <span class="n">Astro</span><span class="o">::</span><span class="n">GetHIColumnDensity</span><span class="p">(</span><span class="kt">double</span> <span class="n">R</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">double</span> <span class="n">CD</span><span class="o">=</span><span class="mf">0.</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="n">R</span><span class="o">&lt;</span><span class="mf">3.5</span><span class="p">)</span> <span class="n">CD</span> <span class="o">=</span> <span class="mf">1.e20</span><span class="o">*</span><span class="mf">6.2</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">pow</span><span class="p">((</span><span class="n">R</span><span class="o">-</span><span class="mf">3.5</span><span class="p">)</span><span class="o">/</span><span class="mf">0.7</span><span class="p">,</span><span class="mf">2.</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">);</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">R</span><span class="o">&lt;</span><span class="mf">13.65</span><span class="p">)</span> <span class="n">CD</span> <span class="o">=</span> <span class="mf">1.e20</span><span class="o">*</span><span class="mf">6.2</span><span class="p">;</span>
  <span class="k">else</span> <span class="n">CD</span> <span class="o">=</span> <span class="mf">1.e20</span><span class="o">*</span><span class="mf">6.2</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.28</span><span class="o">*</span><span class="p">(</span><span class="n">R</span><span class="o">-</span><span class="mf">13.65</span><span class="p">));</span>
  <span class="k">return</span> <span class="n">CD</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">double</span> <span class="n">Astro</span><span class="o">::</span><span class="n">GetH2ColumnDensity</span><span class="p">(</span><span class="kt">double</span> <span class="n">R</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">double</span> <span class="n">CD</span><span class="o">=</span><span class="mf">0.</span><span class="p">;</span>
  <span class="n">CD</span> <span class="o">=</span> <span class="mf">1.e20</span><span class="o">*</span><span class="mf">1.54269e-01</span><span class="o">*</span><span class="n">pow</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">1.69222e+00</span><span class="o">*</span><span class="n">R</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">CD</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">double</span> <span class="n">Astro</span><span class="o">::</span><span class="n">GetHIFWHM</span><span class="p">(</span><span class="kt">double</span> <span class="n">R</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">R</span> <span class="o">=</span> <span class="n">R</span><span class="o">*</span><span class="mf">1000.</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">FWHM</span><span class="o">=</span><span class="mf">0.</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="n">R</span><span class="o">&lt;</span><span class="mf">3500.</span><span class="p">)</span> <span class="n">FWHM</span> <span class="o">=</span> <span class="p">(</span><span class="mf">230.</span><span class="o">-</span><span class="mf">165.</span><span class="p">)</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">pow</span><span class="p">(</span><span class="n">R</span><span class="o">-</span><span class="mf">3500.</span><span class="p">,</span><span class="mf">2.</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">pow</span><span class="p">(</span><span class="mf">500.</span><span class="p">,</span><span class="mf">2.</span><span class="p">)))</span><span class="o">+</span><span class="mf">165.</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">R</span><span class="o">&lt;=</span><span class="mf">8500.</span><span class="p">)</span> <span class="n">FWHM</span> <span class="o">=</span> <span class="mf">230.</span><span class="p">;</span>
  <span class="k">else</span> <span class="n">FWHM</span> <span class="o">=</span> <span class="p">((</span><span class="mf">2000.</span><span class="o">-</span><span class="mf">230.</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">20000.</span><span class="o">-</span><span class="mf">8500.</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">R</span><span class="o">-</span><span class="mf">8500.</span><span class="p">)</span><span class="o">+</span><span class="mf">230.</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">FWHM</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">double</span> <span class="n">Astro</span><span class="o">::</span><span class="n">GetH2FWHM</span><span class="p">(</span><span class="kt">double</span> <span class="n">R</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">R</span> <span class="o">*=</span> <span class="mf">1000.</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">FWHM</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">))</span><span class="o">*</span><span class="n">pow</span><span class="p">(</span><span class="n">R</span><span class="o">/</span><span class="mf">7.81</span><span class="p">,</span><span class="mf">0.58</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">FWHM</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">double</span> <span class="n">Astro</span><span class="o">::</span><span class="n">ModulateGasDensityWithSpirals</span><span class="p">(</span><span class="kt">double</span> <span class="n">n</span><span class="p">,</span> <span class="kt">double</span> <span class="n">x</span><span class="p">,</span> <span class="kt">double</span> <span class="n">y</span><span class="p">,</span> <span class="kt">double</span> <span class="n">z</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">double</span> <span class="n">r</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="o">*</span><span class="n">y</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="n">r</span><span class="o">&lt;=</span><span class="n">barRadius</span><span class="p">)</span> <span class="k">return</span> <span class="n">n</span><span class="p">;</span>
  <span class="cm">/* normalisation quantity that conserves the gas mass before and after modulation. Depends on</span>
<span class="cm">   * spiral arm width; this is for the gaussian arm width of 560pc (Russeil, D. 2005, A&amp;A, 397, 133-146)</span>
<span class="cm">   */</span>
  <span class="kt">double</span> <span class="n">n1</span> <span class="o">=</span> <span class="mf">0.315</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">DistanceToClosestArm</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">ClosestArm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">GetDistanceToNearestSpiralArm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">DistanceToClosestArm</span><span class="p">,</span><span class="n">ClosestArm</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">rhoc</span> <span class="o">=</span> <span class="n">n1</span><span class="o">*</span><span class="p">(</span><span class="mf">3.</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">DistanceToClosestArm</span><span class="o">*</span><span class="n">DistanceToClosestArm</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">armWidth</span><span class="o">*</span><span class="n">armWidth</span><span class="p">))</span><span class="o">+</span><span class="mf">1.</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">rhoc</span><span class="o">*</span><span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// /**</span>
<span class="c1">//  * calculate gas column densities from the on-point given by x,y,z</span>
<span class="c1">//  * in direction l,b out to radius r</span>
<span class="c1">//  */</span>
<span class="c1">// double Astro::CalculateGasColumnDensity(vector&lt;double&gt; xyzReference,</span>
<span class="c1">//                                         vector&lt;double&gt; GLGB,</span>
<span class="c1">//                                         string gascomponent,</span>
<span class="c1">//                                         double modulate,</span>
<span class="c1">//                                         double range,</span>
<span class="c1">//                                         double steps) {</span>
<span class="c1">//</span>
<span class="c1">//   double GasSpecies = -1.;</span>
<span class="c1">//   if(!gascomponent.compare(&quot;HI&quot;)) GasSpecies = 0.;</span>
<span class="c1">//   else if(!gascomponent.compare(&quot;H2&quot;)) GasSpecies = 1.;</span>
<span class="c1">//   else {</span>
<span class="c1">//     std::cout&lt;&lt;&quot;Astro::CalculateGasColumnDensity: Specify supported Gas component (currently &#39;HI&#39; and &#39;H2&#39;)! returning 0 value.&quot;&lt;&lt;std::endl;</span>
<span class="c1">//     return 0.;</span>
<span class="c1">//   }</span>
<span class="c1">//</span>
<span class="c1">//   TF1 *cdintegrand = new TF1(&quot;cd&quot;,this,&amp;Astro::nRadial,0.,range,7,&quot;Astro&quot;,&quot;cdintegrand&quot;);</span>
<span class="c1">//   cdintegrand-&gt;SetParameter(0,GLGB[0]);</span>
<span class="c1">//   cdintegrand-&gt;SetParameter(1,GLGB[1]);</span>
<span class="c1">//   cdintegrand-&gt;SetParameter(2,xyzReference[0]);</span>
<span class="c1">//   cdintegrand-&gt;SetParameter(3,xyzReference[1]);</span>
<span class="c1">//   cdintegrand-&gt;SetParameter(4,xyzReference[2]);</span>
<span class="c1">//   cdintegrand-&gt;SetParameter(5,GasSpecies);</span>
<span class="c1">//   cdintegrand-&gt;SetParameter(6,modulate);</span>
<span class="c1">//   double cd = kpc_to_cm*Integrate(cdintegrand,0.,range,steps,false);</span>
<span class="c1">//</span>
<span class="c1">// //  std::cout&lt;&lt;GasSpecies&lt;&lt;&quot; &quot;&lt;&lt;modulate&lt;&lt;&quot; &quot;&lt;&lt;SPIRALARMMODEL&lt;&lt;&quot; &quot;&lt;&lt;cd&lt;&lt;std::endl;</span>
<span class="c1">//   return cd;</span>
<span class="c1">// }</span>


<span class="cm">/**</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">double</span> <span class="n">Astro</span><span class="o">::</span><span class="n">nRadial</span><span class="p">(</span><span class="kt">double</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span><span class="n">pars</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">double</span> <span class="n">r</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">l</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">b</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">xRef</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">yRef</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">zRef</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
  <span class="kt">int</span> <span class="n">gasspecies</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
  <span class="kt">int</span> <span class="n">modulatewitharms</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pars</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>

  <span class="kt">double</span> <span class="n">xActual</span><span class="p">,</span><span class="n">yActual</span><span class="p">,</span><span class="n">zActual</span><span class="p">;</span>
  <span class="n">GetCartesian</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">xRef</span><span class="p">,</span><span class="n">yRef</span><span class="p">,</span><span class="n">zRef</span><span class="p">,</span><span class="n">xActual</span><span class="p">,</span><span class="n">yActual</span><span class="p">,</span><span class="n">zActual</span><span class="p">);</span>

  <span class="kt">double</span> <span class="n">n</span><span class="o">=</span><span class="mf">0.</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">gasspecies</span><span class="p">)</span> <span class="n">n</span> <span class="o">=</span> <span class="n">HIDensity</span><span class="p">(</span><span class="n">xActual</span><span class="p">,</span><span class="n">yActual</span><span class="p">,</span><span class="n">zActual</span><span class="p">);</span>
  <span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">gasspecies</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="n">n</span> <span class="o">=</span> <span class="n">H2Density</span><span class="p">(</span><span class="n">xActual</span><span class="p">,</span><span class="n">yActual</span><span class="p">,</span><span class="n">zActual</span><span class="p">);</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&quot;Astro::nRadial: Specify implemented gas species! returning 0.!&quot;</span><span class="o">&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="n">modulatewitharms</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="n">n</span> <span class="o">=</span> <span class="n">ModulateGasDensityWithSpirals</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">xActual</span><span class="p">,</span><span class="n">yActual</span><span class="p">,</span><span class="n">zActual</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*    ------            Galactic Structure stuff              ------    */</span>

<span class="cm">/**</span>
<span class="cm"> * Galactic coordinates (R,GL,GB) -&gt;Cartesian</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">Astro</span><span class="o">::</span><span class="n">GetCartesian</span><span class="p">(</span><span class="kt">double</span> <span class="n">r</span><span class="p">,</span> <span class="kt">double</span> <span class="n">l</span><span class="p">,</span> <span class="kt">double</span> <span class="n">b</span><span class="p">,</span> <span class="kt">double</span> <span class="n">xref</span><span class="p">,</span> <span class="kt">double</span> <span class="n">yref</span><span class="p">,</span> <span class="kt">double</span> <span class="n">zref</span><span class="p">,</span> <span class="kt">double</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">,</span> <span class="kt">double</span> <span class="o">&amp;</span><span class="n">y</span><span class="p">,</span> <span class="kt">double</span> <span class="o">&amp;</span><span class="n">z</span><span class="p">)</span> <span class="p">{</span>

  <span class="kt">double</span> <span class="n">dl</span><span class="p">,</span> <span class="n">db</span><span class="p">;</span>
  <span class="n">dl</span> <span class="o">=</span> <span class="n">db</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="n">dl</span> <span class="o">=</span> <span class="n">atan2</span><span class="p">(</span><span class="n">yref</span><span class="p">,</span><span class="n">xref</span><span class="p">);</span>
  <span class="n">db</span> <span class="o">=</span> <span class="n">atan</span><span class="p">(</span><span class="n">zref</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xref</span><span class="o">*</span><span class="n">xref</span><span class="o">+</span><span class="n">yref</span><span class="o">*</span><span class="n">yref</span><span class="p">));</span>
  <span class="kt">double</span> <span class="n">phi</span> <span class="o">=</span> <span class="p">(</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.</span><span class="p">)</span><span class="o">*</span><span class="n">l</span><span class="o">+</span><span class="n">dl</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">theta</span> <span class="o">=</span> <span class="n">pi</span><span class="o">/</span><span class="mf">2.</span> <span class="o">-</span> <span class="p">(</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.</span><span class="p">)</span><span class="o">*</span><span class="n">b</span><span class="o">+</span><span class="n">db</span><span class="p">;</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">xref</span> <span class="o">-</span> <span class="n">r</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">);</span>
  <span class="n">y</span> <span class="o">=</span> <span class="n">yref</span> <span class="o">-</span> <span class="n">r</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">);</span>
  <span class="n">z</span> <span class="o">=</span> <span class="n">zref</span> <span class="o">+</span> <span class="n">r</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">);</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Cartesian coordinates -&gt; Galactic Coordinates(R,GL,GB)</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">Astro</span><span class="o">::</span><span class="n">GetGalactic</span><span class="p">(</span><span class="kt">double</span> <span class="n">x</span><span class="p">,</span> <span class="kt">double</span> <span class="n">y</span><span class="p">,</span> <span class="kt">double</span> <span class="n">z</span><span class="p">,</span> <span class="kt">double</span> <span class="n">xref</span><span class="p">,</span> <span class="kt">double</span> <span class="n">yref</span><span class="p">,</span> <span class="kt">double</span> <span class="n">zref</span><span class="p">,</span> <span class="kt">double</span> <span class="o">&amp;</span><span class="n">l</span><span class="p">,</span> <span class="kt">double</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">double</span> <span class="n">dx</span>  <span class="o">=</span> <span class="n">x</span><span class="o">-</span><span class="n">xref</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">dy</span>  <span class="o">=</span> <span class="n">y</span><span class="o">-</span><span class="n">yref</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">dz</span> <span class="o">=</span>  <span class="n">z</span><span class="o">-</span><span class="n">zref</span><span class="p">;</span>

  <span class="kt">double</span> <span class="n">dr</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">dx</span><span class="o">*</span><span class="n">dx</span><span class="o">+</span><span class="n">dy</span><span class="o">*</span><span class="n">dy</span><span class="o">+</span><span class="n">dz</span><span class="o">*</span><span class="n">dz</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">rrref</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">xref</span><span class="o">*</span><span class="n">xref</span><span class="o">+</span><span class="n">yref</span><span class="o">*</span><span class="n">yref</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">drr</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">dx</span><span class="o">*</span><span class="n">dx</span><span class="o">+</span><span class="n">dy</span><span class="o">*</span><span class="n">dy</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">prod</span> <span class="o">=</span> <span class="o">-</span><span class="n">dx</span><span class="o">*</span><span class="n">xref</span> <span class="o">-</span> <span class="n">dy</span><span class="o">*</span><span class="n">yref</span><span class="p">;</span>
  <span class="n">l</span> <span class="o">=</span> <span class="mf">180.</span><span class="o">*</span><span class="n">acos</span><span class="p">(</span><span class="n">prod</span><span class="o">/</span><span class="p">(</span><span class="n">drr</span><span class="o">*</span><span class="n">rrref</span><span class="p">))</span><span class="o">/</span><span class="n">pi</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="n">dx</span><span class="o">&lt;=</span><span class="mf">0.</span><span class="p">)</span> <span class="n">l</span><span class="o">*=-</span><span class="mf">1.</span><span class="p">;</span>
  <span class="n">b</span> <span class="o">=</span> <span class="mf">180.</span><span class="o">*</span><span class="n">asin</span><span class="p">(</span><span class="n">dz</span><span class="o">/</span><span class="n">dr</span><span class="p">)</span><span class="o">/</span><span class="n">pi</span><span class="p">;</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rotate coordinate around (0,0,0) by (phi,theta,psi)</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">Astro</span><span class="o">::</span><span class="n">RotateCoordinates</span><span class="p">(</span><span class="kt">double</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">,</span> <span class="kt">double</span> <span class="o">&amp;</span><span class="n">y</span><span class="p">,</span> <span class="kt">double</span> <span class="o">&amp;</span><span class="n">z</span><span class="p">,</span> <span class="kt">double</span> <span class="n">phi</span><span class="p">,</span> <span class="kt">double</span> <span class="n">theta</span><span class="p">,</span> <span class="kt">double</span> <span class="n">psi</span><span class="p">)</span> <span class="p">{</span>

  <span class="kt">double</span> <span class="n">xyz</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
  <span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
  <span class="n">xyz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">;</span>
  <span class="n">xyz</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">z</span><span class="p">;</span>

  <span class="n">phi</span> <span class="o">*=</span> <span class="n">pi</span><span class="o">/</span><span class="mf">180.</span><span class="p">;</span><span class="c1">// rotation around x</span>
  <span class="n">theta</span> <span class="o">*=</span> <span class="n">pi</span><span class="o">/</span><span class="mf">180.</span><span class="p">;</span><span class="c1">// rotation around y</span>
  <span class="n">psi</span> <span class="o">*=</span> <span class="n">pi</span><span class="o">/</span><span class="mf">180.</span><span class="p">;</span><span class="c1">// rotation around z</span>

  <span class="kt">double</span> <span class="n">rx</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">3</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">ry</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">3</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">rz</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">3</span><span class="p">];</span>

  <span class="cm">/* rotation matrices */</span>
  <span class="n">rx</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">;</span> <span class="n">rx</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>   <span class="mf">0.</span>    <span class="p">;</span> <span class="n">rx</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>  <span class="mf">0.</span>      <span class="p">;</span>
  <span class="n">rx</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span> <span class="n">rx</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">);</span> <span class="n">rx</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">);</span>
  <span class="n">rx</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span> <span class="n">rx</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">);</span> <span class="n">rx</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>  <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">);</span>

  <span class="n">ry</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">);</span> <span class="n">ry</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>   <span class="mf">0.</span>    <span class="p">;</span> <span class="n">ry</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">);</span>
  <span class="n">ry</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>     <span class="mf">0.</span>     <span class="p">;</span> <span class="n">ry</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>   <span class="mf">1.</span>    <span class="p">;</span> <span class="n">ry</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>     <span class="mf">0.</span>    <span class="p">;</span>
  <span class="n">ry</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">);</span> <span class="n">ry</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>   <span class="mf">0.</span>    <span class="p">;</span> <span class="n">ry</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">);</span>

  <span class="n">rz</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">psi</span><span class="p">);</span> <span class="n">rz</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">psi</span><span class="p">)</span> <span class="p">;</span> <span class="n">rz</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="n">rz</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">psi</span><span class="p">);</span> <span class="n">rz</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="n">cos</span><span class="p">(</span><span class="n">psi</span><span class="p">)</span> <span class="p">;</span> <span class="n">rz</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="n">rz</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>    <span class="mf">0.</span>   <span class="p">;</span> <span class="n">rz</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>    <span class="mf">0.</span>     <span class="p">;</span> <span class="n">rz</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">;</span>

  <span class="c1">//TODO: this can be compactified!</span>
  <span class="k">if</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">double</span> <span class="n">new_coord</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">};</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">k</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span><span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">new_coord</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">rx</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">xyz</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">l</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">l</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span><span class="n">l</span><span class="o">++</span><span class="p">)</span> <span class="n">xyz</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_coord</span><span class="p">[</span><span class="n">l</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">double</span> <span class="n">new_coord</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">};</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">k</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span><span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">new_coord</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">ry</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">xyz</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">l</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">l</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span><span class="n">l</span><span class="o">++</span><span class="p">)</span> <span class="n">xyz</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_coord</span><span class="p">[</span><span class="n">l</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="n">psi</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">double</span> <span class="n">new_coord</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">};</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">k</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span><span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">new_coord</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">rz</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">xyz</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">l</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">l</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span><span class="n">l</span><span class="o">++</span><span class="p">)</span> <span class="n">xyz</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_coord</span><span class="p">[</span><span class="n">l</span><span class="p">];</span>
  <span class="p">}</span>

  <span class="n">x</span> <span class="o">=</span> <span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="n">y</span> <span class="o">=</span> <span class="n">xyz</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
  <span class="n">z</span> <span class="o">=</span> <span class="n">xyz</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Switch off an individual arm in Astro spiral model</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">Astro</span><span class="o">::</span><span class="n">DisableArm</span><span class="p">(</span><span class="kt">int</span> <span class="n">arm</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">QUIETMODE</span><span class="p">)</span> <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&quot;Disabling Arm no. &quot;</span><span class="o">&lt;&lt;</span><span class="n">arm</span><span class="o">&lt;&lt;</span><span class="s">&quot;.&quot;</span><span class="o">&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="n">Set</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">ArmsVector</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">ArmsVector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="n">arm</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">ArmsVector</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">ArmsVector</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span><span class="o">+</span><span class="n">i</span><span class="p">);</span>
      <span class="n">Set</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="n">Set</span><span class="o">==</span><span class="nb">false</span><span class="p">)</span> <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&quot;Arm &quot;</span><span class="o">&lt;&lt;</span><span class="n">arm</span><span class="o">&lt;&lt;</span><span class="s">&quot; already disabled.&quot;</span>
                            <span class="s">&quot;Nothing to do! &quot;</span><span class="o">&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">QUIETMODE</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">ArmsVector</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&quot;Arm[&quot;</span><span class="o">&lt;&lt;</span><span class="n">i</span><span class="o">&lt;&lt;</span><span class="s">&quot;]=&quot;</span><span class="o">&lt;&lt;</span><span class="n">ArmsVector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Switch off an individual arm in Astro spiral model</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">Astro</span><span class="o">::</span><span class="n">EnableArm</span><span class="p">(</span><span class="kt">int</span> <span class="n">arm</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">QUIETMODE</span><span class="p">)</span> <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&quot;Enabling Arm no. &quot;</span><span class="o">&lt;&lt;</span><span class="n">arm</span><span class="o">&lt;&lt;</span><span class="s">&quot;.&quot;</span><span class="o">&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="n">AlreadyThere</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">ArmsVector</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">ArmsVector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">arm</span><span class="p">)</span> <span class="n">AlreadyThere</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="n">AlreadyThere</span><span class="o">==</span><span class="nb">true</span><span class="p">)</span>  <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&quot;Arm &quot;</span><span class="o">&lt;&lt;</span><span class="n">arm</span><span class="o">&lt;&lt;</span><span class="s">&quot; already there! Nothing to do...&quot;</span><span class="o">&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">QUIETMODE</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">ArmsVector</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&quot;Arm[&quot;</span><span class="o">&lt;&lt;</span><span class="n">i</span><span class="o">&lt;&lt;</span><span class="s">&quot;]=&quot;</span><span class="o">&lt;&lt;</span><span class="n">ArmsVector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">ArmsVector</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">arm</span><span class="p">);</span>
  <span class="n">sort</span><span class="p">(</span><span class="n">ArmsVector</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">ArmsVector</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">QUIETMODE</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">ArmsVector</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&quot;Arm[&quot;</span><span class="o">&lt;&lt;</span><span class="n">i</span><span class="o">&lt;&lt;</span><span class="s">&quot;]=&quot;</span><span class="o">&lt;&lt;</span><span class="n">ArmsVector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Astro</span><span class="o">::</span><span class="n">GetDistanceToNearestSpiralArm</span><span class="p">(</span><span class="kt">double</span> <span class="n">x</span><span class="p">,</span> <span class="kt">double</span> <span class="n">y</span><span class="p">,</span> <span class="kt">double</span> <span class="o">&amp;</span><span class="n">DistanceToClosestArm</span><span class="p">,</span> <span class="kt">int</span> <span class="o">&amp;</span><span class="n">ClosestArm</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">double</span> <span class="n">theta</span><span class="p">,</span><span class="n">drdr</span><span class="p">,</span><span class="n">xx</span><span class="p">,</span><span class="n">yy</span><span class="p">,</span><span class="n">theta0</span><span class="p">,</span><span class="n">psi0fac</span><span class="p">,</span><span class="n">r0</span><span class="p">;</span>
  <span class="n">theta</span> <span class="o">=</span> <span class="n">drdr</span> <span class="o">=</span> <span class="n">xx</span> <span class="o">=</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">theta0</span> <span class="o">=</span> <span class="n">psi0fac</span> <span class="o">=</span> <span class="n">r0</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">ddr</span><span class="o">=</span><span class="mf">1.e12</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">arm</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

  <span class="k">if</span><span class="p">(</span><span class="n">SPIRALARMMODEL</span><span class="o">==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ArmsVector</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">!=</span><span class="mi">4</span><span class="p">)</span> <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&quot;GetDistanceToNearestSpiralArm: Number of arms is wrong (n=&quot;</span><span class="o">&lt;&lt;</span><span class="n">ArmsVector</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">&lt;&lt;</span><span class="s">&quot;; Vallee model has 4 arms). Returning 0 value.&quot;</span><span class="o">&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="n">SPIRALARMMODEL</span><span class="o">==</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">ArmsVector</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">!=</span><span class="mi">4</span><span class="p">)</span> <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&quot;GetDistanceToNearestSpiralArm: Number of arms is wrong (n=&quot;</span><span class="o">&lt;&lt;</span><span class="n">ArmsVector</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">&lt;&lt;</span><span class="s">&quot;; Taylor&amp;Cordes model has 4 arms). Returning 0 value.&quot;</span><span class="o">&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

  <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">ArmsVector</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">SPIRALARMMODEL</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">theta0</span> <span class="o">=</span> <span class="p">(</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.</span><span class="p">)</span><span class="o">*</span><span class="n">theta0V</span><span class="p">[</span><span class="n">ArmsVector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
      <span class="n">psi0fac</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="n">tan</span><span class="p">((</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.</span><span class="p">)</span><span class="o">*</span><span class="n">psi0V</span><span class="p">[</span><span class="n">ArmsVector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span><span class="o">-</span><span class="mf">1.</span><span class="p">);</span>
      <span class="n">r0</span> <span class="o">=</span> <span class="n">r0V</span><span class="p">[</span><span class="n">ArmsVector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
      <span class="k">for</span><span class="p">(</span><span class="kt">double</span> <span class="n">r</span><span class="o">=</span><span class="mf">0.00001</span><span class="p">;</span><span class="n">r</span><span class="o">&lt;</span><span class="n">rMax</span><span class="p">;</span><span class="n">r</span><span class="o">+=</span> <span class="mf">.01</span><span class="p">){</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">theta0</span><span class="o">+</span><span class="n">psi0fac</span><span class="o">*</span><span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="n">r</span><span class="o">/</span><span class="n">r0</span><span class="p">));</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">-</span><span class="n">x</span><span class="p">;</span>
        <span class="n">yy</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">-</span><span class="n">y</span><span class="p">;</span>
        <span class="n">drdr</span> <span class="o">=</span> <span class="n">xx</span><span class="o">*</span><span class="n">xx</span> <span class="o">+</span> <span class="n">yy</span><span class="o">*</span><span class="n">yy</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">drdr</span><span class="o">&lt;</span><span class="n">ddr</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">ddr</span> <span class="o">=</span> <span class="n">drdr</span><span class="p">;</span>
          <span class="n">arm</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">SPIRALARMMODEL</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span><span class="p">(</span><span class="kt">double</span> <span class="n">r</span><span class="o">=</span><span class="mf">0.00001</span><span class="p">;</span><span class="n">r</span><span class="o">&lt;</span><span class="n">rMax</span><span class="p">;</span><span class="n">r</span><span class="o">+=</span> <span class="mf">.03</span><span class="p">){</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">EvalTaylorCordesArmTheta</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">ArmsVector</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">-</span><span class="n">x</span><span class="p">;</span>
        <span class="n">yy</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">-</span><span class="n">y</span><span class="p">;</span>
        <span class="n">drdr</span> <span class="o">=</span> <span class="n">xx</span><span class="o">*</span><span class="n">xx</span> <span class="o">+</span> <span class="n">yy</span><span class="o">*</span><span class="n">yy</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">drdr</span><span class="o">&lt;</span><span class="n">ddr</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">ddr</span> <span class="o">=</span> <span class="n">drdr</span><span class="p">;</span>
          <span class="n">arm</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&quot;GetDistanceToNearestSpiralArm: WTF? Specify proper spiral arm model!&quot;</span><span class="o">&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">DistanceToClosestArm</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">ddr</span><span class="p">);</span>
  <span class="n">ClosestArm</span> <span class="o">=</span> <span class="n">ArmsVector</span><span class="p">[</span><span class="n">arm</span><span class="p">];</span>
<span class="c1">//  std::cout&lt;&lt;&quot;Distance = &quot;&lt;&lt;ddr&lt;&lt;&quot; Arm = &quot;&lt;&lt;ClosestArm&lt;&lt;std::endl;</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">double</span> <span class="n">Astro</span><span class="o">::</span><span class="n">GetDistanceToGivenSpiralArm</span><span class="p">(</span><span class="kt">double</span> <span class="n">x</span><span class="p">,</span> <span class="kt">double</span> <span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="n">arm</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">double</span> <span class="n">theta</span><span class="p">,</span><span class="n">drdr</span><span class="p">,</span><span class="n">xx</span><span class="p">,</span><span class="n">yy</span><span class="p">,</span><span class="n">theta0</span><span class="p">,</span><span class="n">psi0fac</span><span class="p">,</span><span class="n">r0</span><span class="p">;</span>
  <span class="n">theta</span> <span class="o">=</span> <span class="n">drdr</span> <span class="o">=</span> <span class="n">xx</span> <span class="o">=</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">theta0</span> <span class="o">=</span> <span class="n">psi0fac</span> <span class="o">=</span> <span class="n">r0</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">ddr</span><span class="o">=</span><span class="mf">1.e12</span><span class="p">;</span>

  <span class="k">if</span><span class="p">(</span><span class="n">SPIRALARMMODEL</span><span class="o">==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ArmsVector</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">!=</span><span class="mi">4</span><span class="p">)</span> <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&quot;GetDistanceToNearestSpiralArm: Number of arms is wrong (n=&quot;</span><span class="o">&lt;&lt;</span><span class="n">ArmsVector</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">&lt;&lt;</span><span class="s">&quot;; Vallee model has 4 arms). Returning 0 value.&quot;</span><span class="o">&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="n">SPIRALARMMODEL</span><span class="o">==</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">ArmsVector</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">!=</span><span class="mi">4</span><span class="p">)</span> <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&quot;GetDistanceToNearestSpiralArm: Number of arms is wrong (n=&quot;</span><span class="o">&lt;&lt;</span><span class="n">ArmsVector</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">&lt;&lt;</span><span class="s">&quot;; Taylor&amp;Cordes model has 4 arms). Returning 0 value.&quot;</span><span class="o">&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">SPIRALARMMODEL</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">theta0</span> <span class="o">=</span> <span class="p">(</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.</span><span class="p">)</span><span class="o">*</span><span class="n">theta0V</span><span class="p">[</span><span class="n">arm</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
      <span class="n">psi0fac</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="n">tan</span><span class="p">((</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.</span><span class="p">)</span><span class="o">*</span><span class="n">psi0V</span><span class="p">[</span><span class="n">arm</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span><span class="o">-</span><span class="mf">1.</span><span class="p">);</span>
      <span class="n">r0</span> <span class="o">=</span> <span class="n">r0V</span><span class="p">[</span><span class="n">arm</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
      <span class="k">for</span><span class="p">(</span><span class="kt">double</span> <span class="n">r</span><span class="o">=</span><span class="mf">0.00001</span><span class="p">;</span><span class="n">r</span><span class="o">&lt;</span><span class="n">rMax</span><span class="p">;</span><span class="n">r</span><span class="o">+=</span> <span class="mf">.05</span><span class="p">){</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">theta0</span><span class="o">+</span><span class="n">psi0fac</span><span class="o">*</span><span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="n">r</span><span class="o">/</span><span class="n">r0</span><span class="p">));</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">-</span><span class="n">x</span><span class="p">;</span>
        <span class="n">yy</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">-</span><span class="n">y</span><span class="p">;</span>
        <span class="n">drdr</span> <span class="o">=</span> <span class="n">xx</span><span class="o">*</span><span class="n">xx</span> <span class="o">+</span> <span class="n">yy</span><span class="o">*</span><span class="n">yy</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">drdr</span><span class="o">&lt;</span><span class="n">ddr</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">ddr</span> <span class="o">=</span> <span class="n">drdr</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">SPIRALARMMODEL</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span><span class="p">(</span><span class="kt">double</span> <span class="n">r</span><span class="o">=</span><span class="mf">0.00001</span><span class="p">;</span><span class="n">r</span><span class="o">&lt;</span><span class="n">rMax</span><span class="p">;</span><span class="n">r</span><span class="o">+=</span> <span class="mf">.03</span><span class="p">){</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">EvalTaylorCordesArmTheta</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">arm</span><span class="p">);</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">-</span><span class="n">x</span><span class="p">;</span>
        <span class="n">yy</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">-</span><span class="n">y</span><span class="p">;</span>
        <span class="n">drdr</span> <span class="o">=</span> <span class="n">xx</span><span class="o">*</span><span class="n">xx</span> <span class="o">+</span> <span class="n">yy</span><span class="o">*</span><span class="n">yy</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">drdr</span><span class="o">&lt;</span><span class="n">ddr</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">ddr</span> <span class="o">=</span> <span class="n">drdr</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&quot;GetDistanceToGivenSpiralArm: WTF? Specify proper spiral arm model! Returning 0.&quot;</span><span class="o">&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
      <span class="k">return</span> <span class="mf">0.</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="k">return</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">ddr</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">double</span> <span class="n">Astro</span><span class="o">::</span><span class="n">EvalTaylorCordesArmTheta</span><span class="p">(</span><span class="kt">double</span> <span class="n">r</span><span class="p">,</span> <span class="kt">int</span> <span class="n">arm</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">double</span> <span class="n">theta</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">arm</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Astro::EvalTaylorCordesArmTheta: Requested Arm 0! (Arm Index &quot;</span>
            <span class="s">&quot;starts a 1, not 0. Returning 0. &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">gsl_interp_accel</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">rmin</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">rmax</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">arm</span><span class="p">){</span>
    <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
      <span class="n">a</span> <span class="o">=</span> <span class="n">accArm1</span><span class="p">;</span>
      <span class="n">rmin</span> <span class="o">=</span> <span class="n">x_a1</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">rmax</span> <span class="o">=</span> <span class="n">x_a1</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
      <span class="n">a</span> <span class="o">=</span> <span class="n">accArm2</span><span class="p">;</span>
      <span class="n">rmin</span> <span class="o">=</span> <span class="n">x_a2</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">rmax</span> <span class="o">=</span> <span class="n">x_a2</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
      <span class="n">a</span> <span class="o">=</span> <span class="n">accArm3</span><span class="p">;</span>
      <span class="n">rmin</span> <span class="o">=</span> <span class="n">x_a3</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">rmax</span> <span class="o">=</span> <span class="n">x_a3</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">4</span><span class="o">:</span>
      <span class="n">a</span> <span class="o">=</span> <span class="n">accArm4</span><span class="p">;</span>
      <span class="n">rmin</span> <span class="o">=</span> <span class="n">x_a4</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">rmax</span> <span class="o">=</span> <span class="n">x_a4</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="n">r</span><span class="o">&lt;</span><span class="n">rmin</span> <span class="o">||</span> <span class="n">r</span><span class="o">&gt;</span><span class="n">rmax</span><span class="p">)</span> <span class="k">return</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="c1">//cout &lt;&lt; &quot;-&gt; &quot; &lt;&lt; arm &lt;&lt; &quot; &quot; &lt;&lt; r&lt;&lt;&quot; &quot; &lt;&lt; rmin &lt;&lt; &quot; &quot; &lt;&lt;rmax &lt;&lt; endl;</span>
  <span class="n">theta</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">EvalSpline</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">TaylorCordesArms</span><span class="p">[</span><span class="n">arm</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span><span class="n">a</span><span class="p">,</span>
                             <span class="n">__func__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">);</span>
  <span class="n">theta</span> <span class="o">*=</span> <span class="p">(</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">theta</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">double</span> <span class="n">Astro</span><span class="o">::</span><span class="n">EvalTaylorCordesArmGalactocentricRadius</span><span class="p">(</span><span class="kt">double</span> <span class="n">theta</span><span class="p">,</span> <span class="kt">int</span> <span class="n">arm</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">double</span> <span class="n">r</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">arm</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Astro::EvalTaylorCordesArmGalactocentricRadius: Requested Arm 0! &quot;</span>
             <span class="s">&quot;(Arm Index starts a 1, not 0.) Returning 0. &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">gsl_interp_accel</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">thetamin</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">thetamax</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">arm</span><span class="p">){</span>
    <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
      <span class="n">a</span> <span class="o">=</span> <span class="n">accArm1Inv</span><span class="p">;</span>
      <span class="n">thetamin</span> <span class="o">=</span> <span class="n">y_a1</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">thetamax</span> <span class="o">=</span> <span class="n">y_a1</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
      <span class="n">a</span> <span class="o">=</span> <span class="n">accArm2Inv</span><span class="p">;</span>
      <span class="n">thetamin</span> <span class="o">=</span> <span class="n">y_a2</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">thetamax</span> <span class="o">=</span> <span class="n">y_a2</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
      <span class="n">a</span> <span class="o">=</span> <span class="n">accArm3Inv</span><span class="p">;</span>
      <span class="n">thetamin</span> <span class="o">=</span> <span class="n">y_a3</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">thetamax</span> <span class="o">=</span> <span class="n">y_a3</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">4</span><span class="o">:</span>
      <span class="n">a</span> <span class="o">=</span> <span class="n">accArm4Inv</span><span class="p">;</span>
      <span class="n">thetamin</span> <span class="o">=</span> <span class="n">y_a4</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">thetamax</span> <span class="o">=</span> <span class="n">y_a4</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="n">theta</span><span class="o">&lt;</span><span class="n">thetamin</span> <span class="o">||</span> <span class="n">theta</span><span class="o">&gt;</span><span class="n">thetamax</span><span class="p">)</span> <span class="k">return</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="n">r</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">EvalSpline</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span><span class="n">TaylorCordesArmsInv</span><span class="p">[</span><span class="n">arm</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span><span class="n">a</span><span class="p">,</span>
                             <span class="n">__func__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Astro</span><span class="o">::</span><span class="n">SetSurfaceDensityModel</span><span class="p">(</span><span class="n">string</span> <span class="n">surfacedensitymodel</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">surfacedensitymodel</span><span class="p">.</span><span class="n">compare</span><span class="p">(</span><span class="s">&quot;CaseBhattacharya&quot;</span><span class="p">))</span> <span class="n">SURFACEDENSITYMODEL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">surfacedensitymodel</span><span class="p">.</span><span class="n">compare</span><span class="p">(</span><span class="s">&quot;IusifovKucuk&quot;</span><span class="p">))</span> <span class="n">SURFACEDENSITYMODEL</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">surfacedensitymodel</span><span class="p">.</span><span class="n">compare</span><span class="p">(</span><span class="s">&quot;Linear&quot;</span><span class="p">))</span> <span class="n">SURFACEDENSITYMODEL</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&quot;Astro::SetSurfaceDensityModel: Specify supported surface density model (currently &#39;CaseBhattacharya&#39;, &#39;IusifovKucuk&#39; and &#39;Linear&#39;)! returning 0 value.&quot;</span><span class="o">&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Astro</span><span class="o">::</span><span class="n">SetCentralStructureModel</span><span class="p">(</span><span class="n">string</span> <span class="n">centralstructuremodel</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">centralstructuremodel</span><span class="p">.</span><span class="n">compare</span><span class="p">(</span><span class="s">&quot;Bar&quot;</span><span class="p">))</span> <span class="n">CENTRALSTRUCTUREMODEL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">centralstructuremodel</span><span class="p">.</span><span class="n">compare</span><span class="p">(</span><span class="s">&quot;Disk&quot;</span><span class="p">))</span> <span class="n">CENTRALSTRUCTUREMODEL</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&quot;Astro::SetCentralStructureModel: Specify central structure model (currently &#39;Bar&#39; and &#39;Disk&#39;)! returning 0 value.&quot;</span><span class="o">&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Astro</span><span class="o">::</span><span class="n">SetSpiralArmModel</span><span class="p">(</span><span class="n">string</span> <span class="n">spiralarmmodel</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">spiralarmmodel</span><span class="p">.</span><span class="n">compare</span><span class="p">(</span><span class="s">&quot;Vallee&quot;</span><span class="p">))</span> <span class="n">SPIRALARMMODEL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">spiralarmmodel</span><span class="p">.</span><span class="n">compare</span><span class="p">(</span><span class="s">&quot;TaylorCordes&quot;</span><span class="p">))</span> <span class="n">SPIRALARMMODEL</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">spiralarmmodel</span><span class="p">.</span><span class="n">compare</span><span class="p">(</span><span class="s">&quot;Flat&quot;</span><span class="p">))</span> <span class="n">SPIRALARMMODEL</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&quot;Astro::SetSpiralArmModel: Specify supported spiral arm model (currently &#39;Vallee&#39; and &#39;TaylorCordes&#39;)! returning 0 value.&quot;</span><span class="o">&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Astro</span><span class="o">::</span><span class="n">SetMainSequenceBubbleModel</span><span class="p">(</span><span class="n">string</span> <span class="n">msbubblemodel</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">msbubblemodel</span><span class="p">.</span><span class="n">compare</span><span class="p">(</span><span class="s">&quot;Weaver&quot;</span><span class="p">))</span> <span class="n">MSBUBBLEMODEL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">msbubblemodel</span><span class="p">.</span><span class="n">compare</span><span class="p">(</span><span class="s">&quot;Chen&quot;</span><span class="p">))</span> <span class="n">MSBUBBLEMODEL</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&quot;Astro::SetMainSequenceBubbleModel: Specify supported main sequence wind bubble model (currently &#39;Weaver&#39; and &#39;Chen&#39;)! Defaulting to Weaver&#39;s model.&quot;</span><span class="o">&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">vector</span><span class="o">&lt;</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">Astro</span><span class="o">::</span><span class="n">DiceGalacticPositions</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="n">GetRandomGalactocentricRadii</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
  <span class="n">vector</span><span class="o">&lt;</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">v</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">;</span>
  <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">n</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">GalacticPositionXY</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">GetRandomArm</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">x</span> <span class="o">&amp;&amp;</span> <span class="n">y</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">z</span> <span class="o">=</span> <span class="n">GetRandomZValue</span><span class="p">(</span><span class="n">scaleHeight</span><span class="p">);</span>
      <span class="n">RandomGaussianShift</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">armWidth</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
      <span class="n">v</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">());</span>
      <span class="n">v</span><span class="p">[</span><span class="n">v</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">push_back</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
      <span class="n">v</span><span class="p">[</span><span class="n">v</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">push_back</span><span class="p">(</span><span class="n">y</span><span class="p">);</span>
      <span class="n">v</span><span class="p">[</span><span class="n">v</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">push_back</span><span class="p">(</span><span class="n">z</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">v</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * return a random spiral arm (identifier, i.e. an unsigned integer)</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">Astro</span><span class="o">::</span><span class="n">GetRandomArm</span><span class="p">(</span><span class="kt">double</span> <span class="n">r</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">vint</span> <span class="o">=</span> <span class="n">ArmsVector</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">ArmsVector</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">cout</span><span class="o">&lt;&lt;</span> <span class="n">ArmsVector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="n">SPIRALARMMODEL</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">//QUIETMODE = 1;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">r</span><span class="o">&lt;</span><span class="n">x_a1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span> <span class="n">r</span><span class="o">&gt;</span><span class="n">x_a1</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="n">DisableArm</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">r</span><span class="o">&lt;</span><span class="n">x_a2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span> <span class="n">r</span><span class="o">&gt;</span><span class="n">x_a2</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span> <span class="n">DisableArm</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">r</span><span class="o">&lt;</span><span class="n">x_a3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span> <span class="n">r</span><span class="o">&gt;</span><span class="n">x_a3</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span> <span class="n">DisableArm</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">r</span><span class="o">&lt;</span><span class="n">x_a4</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span> <span class="n">r</span><span class="o">&gt;</span><span class="n">x_a4</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span> <span class="n">DisableArm</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">ArmsVector</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
  <span class="kt">double</span> <span class="n">v</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">Random</span><span class="p">();</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">for</span><span class="p">(;</span><span class="n">i</span><span class="o">&lt;=</span><span class="n">size</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//cout &lt;&lt; &quot;-- &quot; &lt;&lt; i &lt;&lt; std::endl;</span>
    <span class="kt">double</span> <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">i</span><span class="o">/</span><span class="n">size</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">x</span><span class="o">&gt;</span><span class="n">v</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kt">int</span> <span class="n">arm</span> <span class="o">=</span> <span class="n">ArmsVector</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
  <span class="n">ArmsVector</span> <span class="o">=</span> <span class="n">vint</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">arm</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Return x,y coordinates of position along the i-th spiral arm or in the central structure at</span>
<span class="cm"> * the Galactocentric radius r</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">Astro</span><span class="o">::</span><span class="n">GalacticPositionXY</span><span class="p">(</span><span class="kt">double</span> <span class="n">r</span><span class="p">,</span> <span class="kt">int</span> <span class="n">arm</span><span class="p">,</span> <span class="kt">double</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">,</span> <span class="kt">double</span> <span class="o">&amp;</span><span class="n">y</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">y</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">arm</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Astro::GalacticPositionXY: Arm 0 does not exits! Returing 0. &quot;</span>
            <span class="s">&quot;values&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="cm">/* Central Structure */</span>
  <span class="k">if</span><span class="p">(</span><span class="n">r</span><span class="o">&lt;</span><span class="n">barRadius</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">CENTRALSTRUCTUREMODEL</span><span class="p">)</span> <span class="n">Bar</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">);</span>
    <span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">CENTRALSTRUCTUREMODEL</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="n">Disk</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">);</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Astro::GalacticPositionXY: Please specify proper central galactic&quot;</span>
              <span class="s">&quot;structure. Options: Bar,Bulge. Exiting&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="cm">/* Spiral arms */</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">SPIRALARMMODEL</span><span class="p">)</span> <span class="n">ValleeSpiral</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">arm</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">);</span>
  <span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">SPIRALARMMODEL</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="n">TaylorCordesSpiral</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">arm</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">);</span>
  <span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">SPIRALARMMODEL</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span> <span class="n">Disk</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">);</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&quot;Astro::GalacticPositionXY: Please specify proper available spiral arm model. Options: Vallee,TaylorCordes. Returning zero coordinates&quot;</span><span class="o">&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Astro</span><span class="o">::</span><span class="n">PositionOnSpiralArmAngular</span><span class="p">(</span><span class="kt">double</span> <span class="n">theta</span><span class="p">,</span> <span class="kt">int</span> <span class="n">arm</span><span class="p">,</span> <span class="kt">double</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">,</span> <span class="kt">double</span> <span class="o">&amp;</span><span class="n">y</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">SPIRALARMMODEL</span><span class="p">)</span>  <span class="n">ValleeSpiral</span><span class="p">(</span><span class="n">ValleeSpiralAngular</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span><span class="n">arm</span><span class="p">),</span><span class="n">arm</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">);</span>
  <span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">SPIRALARMMODEL</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="n">TaylorCordesSpiral</span><span class="p">(</span><span class="n">TaylorCordesSpiralAngular</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span><span class="n">arm</span><span class="p">),</span><span class="n">arm</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">);</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&quot;Astro::LogarithmicSpiral: Please specify proper available spiral arm model. Options: Vallee,TaylorCordes. Returning zero coordinates&quot;</span><span class="o">&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">y</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="p">}</span>

<span class="c1">//  std::cout&lt;&lt;&quot;theta -&gt; r: &quot;&lt;&lt;theta&lt;&lt;&quot; -&gt; &quot;&lt;&lt;ValleeSpiralAngular(theta,arm)&lt;&lt;&quot; -&gt;  x,y : &quot;&lt;&lt;x&lt;&lt;&quot; &quot;&lt;&lt;y&lt;&lt;std::endl;</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">Astro</span><span class="o">::</span><span class="n">GetRandomGalactocentricRadii</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">double</span> <span class="n">rmin</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">rmax</span> <span class="o">=</span> <span class="mf">20.</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="n">SURFACEDENSITYMODEL</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span> <span class="k">return</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">LinearRandom</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="n">rmin</span><span class="p">,</span><span class="n">rmax</span><span class="p">,</span><span class="n">n</span><span class="p">);</span>
  <span class="n">vector</span><span class="o">&lt;</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">v</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">steps</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">dr</span> <span class="o">=</span> <span class="p">(</span><span class="n">rmax</span><span class="o">-</span><span class="n">rmin</span><span class="p">)</span><span class="o">/</span><span class="n">steps</span><span class="p">;</span>
  <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">steps</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">double</span> <span class="n">r</span><span class="p">,</span><span class="n">val</span><span class="p">;</span>
    <span class="n">r</span>  <span class="o">=</span> <span class="n">rmin</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">dr</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">SURFACEDENSITYMODEL</span><span class="p">)</span> <span class="n">val</span> <span class="o">=</span> <span class="n">CaseBhattacharyaProfile</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
    <span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">SURFACEDENSITYMODEL</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="n">val</span> <span class="o">=</span> <span class="n">IusifovKucukProfile</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
    <span class="k">else</span> <span class="k">break</span><span class="p">;</span>
    <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">TwoDVectorPushBack</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">v</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">CustomFunctionRandom</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">v</span><span class="p">[</span><span class="n">v</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">n</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">double</span> <span class="n">Astro</span><span class="o">::</span><span class="n">CaseBhattacharyaProfile</span><span class="p">(</span><span class="kt">double</span> <span class="n">r</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="mf">2.</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">r</span><span class="o">*</span><span class="n">pow</span><span class="p">(</span><span class="n">r</span><span class="o">/</span><span class="mf">8.5</span><span class="p">,</span><span class="mf">2.</span><span class="p">)</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">5.1</span><span class="o">*</span><span class="p">(</span><span class="n">r</span><span class="o">-</span><span class="mf">8.5</span><span class="p">)</span><span class="o">/</span><span class="mf">8.5</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">double</span> <span class="n">Astro</span><span class="o">::</span><span class="n">IusifovKucukProfile</span><span class="p">(</span><span class="kt">double</span> <span class="n">r</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="mf">2.</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">r</span><span class="o">*</span><span class="n">pow</span><span class="p">((</span><span class="n">r</span><span class="o">+</span><span class="mf">0.55</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">8.5</span><span class="o">+</span><span class="mf">0.55</span><span class="p">),</span><span class="mf">1.64</span><span class="p">)</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">4.01</span><span class="o">*</span><span class="p">(</span><span class="n">r</span><span class="o">-</span><span class="mf">8.5</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">8.5</span><span class="o">+</span><span class="mf">0.55</span><span class="p">));</span>
<span class="p">}</span>
<span class="kt">double</span> <span class="n">Astro</span><span class="o">::</span><span class="n">GetRandomZValue</span><span class="p">(</span><span class="kt">double</span> <span class="n">scaleHeight</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">SignRandom</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">ExponentialRandom</span><span class="p">(</span><span class="n">scaleHeight</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">5.</span><span class="o">*</span><span class="n">scaleHeight</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gaussian shift along concentric circle (retains r-distribution), but</span>
<span class="cm"> * looks odd with TaylorCordes spirals</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">Astro</span><span class="o">::</span><span class="n">RandomTangentialShift</span><span class="p">(</span><span class="kt">double</span> <span class="n">r</span><span class="p">,</span> <span class="kt">double</span> <span class="n">width</span><span class="p">,</span> <span class="kt">double</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">,</span> <span class="kt">double</span> <span class="o">&amp;</span><span class="n">y</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">double</span> <span class="n">dtheta</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">GaussianRandom</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">r</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">x_r</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">dtheta</span><span class="p">)</span><span class="o">-</span><span class="n">y</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">dtheta</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">y_r</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">dtheta</span><span class="p">)</span><span class="o">+</span><span class="n">y</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">dtheta</span><span class="p">);</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">x_r</span><span class="p">;</span>
  <span class="n">y</span> <span class="o">=</span> <span class="n">y_r</span><span class="p">;</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/**</span>
<span class="cm"> * gaussian shift along concentric circle (retains r-distribution), but</span>
<span class="cm"> * looks odd with TaylorCordes spirals</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">Astro</span><span class="o">::</span><span class="n">RandomGaussianShift</span><span class="p">(</span><span class="kt">double</span> <span class="n">r</span><span class="p">,</span> <span class="kt">double</span> <span class="n">width</span><span class="p">,</span> <span class="kt">double</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">,</span> <span class="kt">double</span> <span class="o">&amp;</span><span class="n">y</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">x</span> <span class="o">+=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">GaussianRandom</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
  <span class="n">y</span> <span class="o">+=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">GaussianRandom</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Astro</span><span class="o">::</span><span class="n">ValleeSpiral</span><span class="p">(</span><span class="kt">double</span> <span class="n">r</span><span class="p">,</span> <span class="kt">int</span> <span class="n">arm</span><span class="p">,</span> <span class="kt">double</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">,</span> <span class="kt">double</span> <span class="o">&amp;</span><span class="n">y</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="n">arm</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&quot;Astro::ValleeSpiral: Arm numbers start at 1 (here: &quot;</span><span class="o">&lt;&lt;</span><span class="n">arm</span><span class="o">&lt;&lt;</span><span class="s">&quot;). Returning zero value&quot;</span><span class="o">&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kt">bool</span> <span class="n">ARMNOTTHERE</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">ArmsVector</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span><span class="k">if</span><span class="p">(</span><span class="n">arm</span><span class="o">==</span><span class="n">ArmsVector</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="n">ARMNOTTHERE</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;}</span>
  <span class="k">if</span><span class="p">(</span><span class="n">ARMNOTTHERE</span><span class="o">==</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&quot;Astro::ValleeSpiral: Arm number &quot;</span><span class="o">&lt;&lt;</span><span class="n">arm</span><span class="o">&lt;&lt;</span><span class="s">&quot; not there. Returning zero value.&quot;</span><span class="o">&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kt">double</span> <span class="n">psi0</span> <span class="o">=</span> <span class="p">(</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.</span><span class="p">)</span><span class="o">*</span><span class="n">psi0V</span><span class="p">[</span><span class="n">arm</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">theta0</span> <span class="o">=</span> <span class="p">(</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.</span><span class="p">)</span><span class="o">*</span><span class="n">theta0V</span><span class="p">[</span><span class="n">arm</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">r0</span> <span class="o">=</span> <span class="n">r0V</span><span class="p">[</span><span class="n">arm</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">delta_theta</span> <span class="o">=</span> <span class="n">log</span><span class="p">(</span><span class="n">r</span><span class="o">/</span><span class="n">r0</span><span class="p">)</span><span class="o">/</span><span class="n">tan</span><span class="p">(</span><span class="n">psi0</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">theta</span> <span class="o">=</span> <span class="n">theta0</span> <span class="o">+</span> <span class="n">delta_theta</span><span class="p">;</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">);</span>
  <span class="n">y</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">);</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">double</span> <span class="n">Astro</span><span class="o">::</span><span class="n">ValleeSpiralAngular</span><span class="p">(</span><span class="kt">double</span> <span class="n">theta</span><span class="p">,</span> <span class="kt">int</span> <span class="n">arm</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="n">arm</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&quot;Astro::ValleeSpiral: Arm numbers start at 1 (here: &quot;</span><span class="o">&lt;&lt;</span><span class="n">arm</span><span class="o">&lt;&lt;</span><span class="s">&quot;). Returning zero value&quot;</span><span class="o">&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kt">bool</span> <span class="n">ARMNOTTHERE</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">ArmsVector</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span><span class="k">if</span><span class="p">(</span><span class="n">arm</span><span class="o">==</span><span class="n">ArmsVector</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="n">ARMNOTTHERE</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;}</span>
  <span class="k">if</span><span class="p">(</span><span class="n">ARMNOTTHERE</span><span class="o">==</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&quot;Astro::ValleeSpiral: Arm number &quot;</span><span class="o">&lt;&lt;</span><span class="n">arm</span><span class="o">&lt;&lt;</span><span class="s">&quot; not there. Returning zero value.&quot;</span><span class="o">&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kt">double</span> <span class="n">psi0</span> <span class="o">=</span> <span class="p">(</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.</span><span class="p">)</span><span class="o">*</span><span class="n">psi0V</span><span class="p">[</span><span class="n">arm</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">theta0</span> <span class="o">=</span> <span class="p">(</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.</span><span class="p">)</span><span class="o">*</span><span class="n">theta0V</span><span class="p">[</span><span class="n">arm</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">r0</span> <span class="o">=</span> <span class="n">r0V</span><span class="p">[</span><span class="n">arm</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">delta_theta</span> <span class="o">=</span> <span class="p">(</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.</span><span class="p">)</span><span class="o">*</span><span class="n">theta</span><span class="o">-</span><span class="n">theta0</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">r</span> <span class="o">=</span> <span class="n">r0</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="n">delta_theta</span><span class="o">*</span><span class="n">tan</span><span class="p">(</span><span class="n">psi0</span><span class="p">));</span>
  <span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Astro</span><span class="o">::</span><span class="n">TaylorCordesSpiral</span><span class="p">(</span><span class="kt">double</span> <span class="n">r</span><span class="p">,</span> <span class="kt">int</span> <span class="n">arm</span><span class="p">,</span> <span class="kt">double</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">,</span> <span class="kt">double</span> <span class="o">&amp;</span><span class="n">y</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="n">arm</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&quot;Astro::TaylorCordesSpiral: Arm numbers start at 1 (here: &quot;</span><span class="o">&lt;&lt;</span><span class="n">arm</span><span class="o">&lt;&lt;</span><span class="s">&quot;). Returning zero value&quot;</span><span class="o">&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kt">bool</span> <span class="n">ARMNOTTHERE</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">ArmsVector</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span><span class="k">if</span><span class="p">(</span><span class="n">arm</span><span class="o">==</span><span class="n">ArmsVector</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="n">ARMNOTTHERE</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;}</span>
  <span class="k">if</span><span class="p">(</span><span class="n">ARMNOTTHERE</span><span class="o">==</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&quot;Astro::TaylorCordesSpiral: Arm number &quot;</span><span class="o">&lt;&lt;</span><span class="n">arm</span><span class="o">&lt;&lt;</span><span class="s">&quot; not there. Returning zero value.&quot;</span><span class="o">&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kt">double</span> <span class="n">theta</span> <span class="o">=</span> <span class="n">EvalTaylorCordesArmTheta</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">arm</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">theta</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">);</span>
  <span class="n">y</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">);</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">double</span> <span class="n">Astro</span><span class="o">::</span><span class="n">TaylorCordesSpiralAngular</span><span class="p">(</span><span class="kt">double</span> <span class="n">theta</span><span class="p">,</span> <span class="kt">int</span> <span class="n">arm</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="n">arm</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&quot;Astro::TaylorCordesSpiral: Arm numbers start at 1 (here: &quot;</span><span class="o">&lt;&lt;</span><span class="n">arm</span><span class="o">&lt;&lt;</span><span class="s">&quot;). Returning zero value&quot;</span><span class="o">&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kt">bool</span> <span class="n">ARMNOTTHERE</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">ArmsVector</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span><span class="k">if</span><span class="p">(</span><span class="n">arm</span><span class="o">==</span><span class="n">ArmsVector</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="n">ARMNOTTHERE</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;}</span>
  <span class="k">if</span><span class="p">(</span><span class="n">ARMNOTTHERE</span><span class="o">==</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&quot;Astro::TaylorCordesSpiral: Arm number &quot;</span><span class="o">&lt;&lt;</span><span class="n">arm</span><span class="o">&lt;&lt;</span><span class="s">&quot; not there. Returning zero value.&quot;</span><span class="o">&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kt">double</span> <span class="n">r</span> <span class="o">=</span> <span class="n">EvalTaylorCordesArmGalactocentricRadius</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span><span class="n">arm</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Get random xy Coordinates on a circular disk</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">Astro</span><span class="o">::</span><span class="n">Disk</span><span class="p">(</span><span class="kt">double</span> <span class="n">r</span><span class="p">,</span> <span class="kt">double</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">,</span> <span class="kt">double</span> <span class="o">&amp;</span><span class="n">y</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">y</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">theta</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">Random</span><span class="p">();</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">);</span>
  <span class="n">y</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">);</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Get xy Coordinates on a central bar inclined with an angle &#39;angle&#39; clockwise</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">Astro</span><span class="o">::</span><span class="n">Bar</span><span class="p">(</span><span class="kt">double</span> <span class="n">r</span><span class="p">,</span> <span class="kt">double</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">,</span> <span class="kt">double</span> <span class="o">&amp;</span><span class="n">y</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">double</span> <span class="n">angle</span> <span class="o">=</span> <span class="mf">90.</span> <span class="o">-</span> <span class="n">barAngle</span> <span class="p">;</span> <span class="c1">//90 - x because angle is relative to Sun-GC line (y-dir)</span>
  <span class="n">angle</span> <span class="o">*=</span> <span class="n">pi</span><span class="o">/</span><span class="mf">180.</span><span class="p">;</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">y</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="n">r</span> <span class="o">*=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">SignRandom</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="p">);</span>
  <span class="n">y</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">angle</span><span class="p">);</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * radial distribution that gives a flat appearance of the Astro</span>
<span class="cm"> */</span>
<span class="kt">double</span> <span class="n">Astro</span><span class="o">::</span><span class="n">LinearSurfDens</span><span class="p">(</span><span class="kt">double</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span><span class="n">par</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">double</span> <span class="n">xx</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="k">if</span><span class="p">(</span><span class="n">xx</span><span class="o">&lt;=</span><span class="mf">3.</span><span class="p">)</span> <span class="k">return</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">pow</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span><span class="mf">0.5</span><span class="p">);</span>
  <span class="k">else</span> <span class="k">return</span> <span class="mf">0.87</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">//**  Here starts the dynamics model collection!  *//</span>


<span class="cm">/**</span>
<span class="cm"> * Radius and shock speed in the thin shell approximation. Implementation in</span>
<span class="cm"> * CalculateThinShellApproximation() member function.</span>
<span class="cm"> */</span>
<span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">Astro</span><span class="o">::</span><span class="n">ThinShellRadiusAndSpeed</span><span class="p">(</span><span class="kt">double</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">v</span><span class="p">,</span><span class="n">vzero</span><span class="p">;</span>
  <span class="n">vzero</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mf">0.</span><span class="p">);</span>
  <span class="n">vzero</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mf">0.</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">R</span><span class="p">,</span><span class="n">V</span><span class="p">;</span>
  <span class="n">t</span><span class="o">*=</span><span class="n">yr_to_sec</span><span class="p">;</span>

  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">thinshellradius</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">||</span> <span class="o">!</span><span class="n">thinshellvelocity</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Astro::ThinShellRadiusAndSpeed: You have to run the calculation &quot;</span>
            <span class="s">&quot;first via CalculateThinShellApproximation()! Returning (r=0,v=0)!&quot;</span>
            <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">vzero</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="n">t</span><span class="o">&lt;=</span><span class="n">thinshellsolutiontmin</span> <span class="o">||</span> <span class="n">t</span><span class="o">&gt;=</span><span class="n">thinshellsolutiontmax</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">QUIETMODE</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Astro::ThinShellRadiusAndSpeed: time outside solution boundaries &quot;</span>
           <span class="o">&lt;&lt;</span> <span class="s">&quot;(t=&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">t</span><span class="o">/</span><span class="n">yr_to_sec</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; outside [&quot;</span>
           <span class="o">&lt;&lt;</span> <span class="n">thinshellsolutiontmin</span><span class="o">/</span><span class="n">yr_to_sec</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span>
           <span class="o">&lt;&lt;</span> <span class="n">thinshellsolutiontmax</span><span class="o">/</span><span class="n">yr_to_sec</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;]). &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
      <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Returning (r=0,v=0)!&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">vzero</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">R</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">EvalSpline</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">thinshellradiuslookup</span><span class="p">,</span><span class="n">atsrad</span><span class="p">,</span><span class="n">__func__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">);</span>
  <span class="n">V</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">EvalSpline</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">thinshellvelocitylookup</span><span class="p">,</span><span class="n">atsvel</span><span class="p">,</span><span class="n">__func__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">);</span>
  <span class="n">v</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">R</span><span class="p">);</span>
  <span class="n">v</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">V</span><span class="p">);</span>

  <span class="k">return</span> <span class="n">v</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * This is the thin shell approximation for adiabatic shocks.</span>
<span class="cm"> * The implementation here is taken from the appendix in</span>
<span class="cm"> * Ptuskin&amp;Zirakashvili 2005 (A&amp;A 429, 755â765 (2005)).</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">Astro</span><span class="o">::</span><span class="n">CalculateThinShellApproximation</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">dProfile</span><span class="p">,</span>
                                            <span class="kt">double</span> <span class="n">E</span><span class="p">,</span> <span class="kt">double</span> <span class="n">AdiabIndex</span><span class="p">,</span>
                                            <span class="kt">double</span> <span class="n">tmin</span><span class="p">,</span> <span class="kt">double</span> <span class="n">tmax</span><span class="p">,</span>
                                            <span class="kt">int</span> <span class="n">steps</span><span class="p">)</span> <span class="p">{</span>

  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">dProfile</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Astro::CalculateThinShellApproximation: density profile empty.&quot;</span>
            <span class="s">&quot;Exiting.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">E</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Astro::CalculateThinShellApproximation: Blast energy is zero.&quot;</span>
            <span class="s">&quot;Exiting.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">AdiabIndex</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Astro::CalculateThinShellApproximation: Adiabatic index energy is&quot;</span>
            <span class="s">&quot;zero. Exiting.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="n">thinshellradius</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">Clear2DVector</span><span class="p">(</span><span class="n">thinshellradius</span><span class="p">);</span>
    <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">Clear2DVector</span><span class="p">(</span><span class="n">thinshellvelocity</span><span class="p">);</span>
    <span class="n">gsl_spline_free</span><span class="p">(</span><span class="n">thinshellradiuslookup</span><span class="p">);</span>
    <span class="n">gsl_spline_free</span><span class="p">(</span><span class="n">thinshellvelocitylookup</span><span class="p">);</span>
    <span class="n">gsl_interp_accel_reset</span><span class="p">(</span><span class="n">atsrad</span><span class="p">);</span>
    <span class="n">gsl_interp_accel_reset</span><span class="p">(</span><span class="n">atsvel</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="cm">/* fill a lookup of mass vs. radius, needed in the integral in (A.4.1) */</span>
  <span class="n">vector</span><span class="o">&lt;</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">massintegrand</span><span class="p">;</span>
  <span class="n">vector</span><span class="o">&lt;</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">mass</span><span class="p">;</span>
  <span class="n">vector</span><span class="o">&lt;</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">fintegrand</span><span class="p">;</span>
  <span class="n">vector</span><span class="o">&lt;</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">fintegral</span><span class="p">;</span>
  <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">dProfile</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">double</span> <span class="n">r</span> <span class="o">=</span> <span class="n">dProfile</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
    <span class="kt">double</span> <span class="n">n</span> <span class="o">=</span> <span class="n">dProfile</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
    <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">TwoDVectorPushBack</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="mf">4.</span><span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">m_p_g</span> <span class="o">*</span> <span class="n">n</span> <span class="o">*</span> <span class="n">r</span> <span class="o">*</span> <span class="n">r</span><span class="p">,</span><span class="n">massintegrand</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">mass</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">IntegratedProfile</span><span class="p">(</span><span class="n">massintegrand</span><span class="p">);</span>

  <span class="cm">/* Fill a Graph Velocity vs. Radius first. Eq.   (A.4) */</span>

  <span class="cm">/* fintegrand is the integrand in (A.4.I). */</span>
  <span class="kt">double</span> <span class="n">r0</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">y</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">w</span> <span class="o">=</span> <span class="mf">6.</span><span class="o">*</span><span class="p">(</span><span class="n">AdiabIndex</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">AdiabIndex</span><span class="o">+</span><span class="mf">1.</span><span class="p">);</span>
  <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">mass</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">mass</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">mass</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
    <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">TwoDVectorPushBack</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">pow</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">w</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span><span class="o">*</span><span class="n">m</span><span class="p">,</span><span class="n">fintegrand</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">fintegral</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">IntegratedProfile</span><span class="p">(</span><span class="n">fintegrand</span><span class="p">);</span>

  <span class="n">gsl_spline</span> <span class="o">*</span><span class="n">masslookup</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">GSLsplineFromTwoDVector</span><span class="p">(</span><span class="n">mass</span><span class="p">);</span>
  <span class="n">gsl_interp_accel</span> <span class="o">*</span><span class="n">amass</span> <span class="o">=</span> <span class="n">gsl_interp_accel_alloc</span><span class="p">();</span>

    <span class="cm">/* Finally fill TGraph with V vs R, as well as 1./V vs R for time calculation. */</span>
  <span class="n">vector</span><span class="o">&lt;</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">velocity</span><span class="p">,</span><span class="n">inversevelocity</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">k</span><span class="o">=</span><span class="p">(</span><span class="n">AdiabIndex</span><span class="o">+</span><span class="mf">1.</span><span class="p">)</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">w</span><span class="o">*</span><span class="n">E</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">;</span>
  <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">fintegral</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">fintegral</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">fintegral</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">EvalSpline</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">masslookup</span><span class="p">,</span><span class="n">amass</span><span class="p">,</span><span class="n">__func__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">);</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">k</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">y</span><span class="o">/</span><span class="p">(</span><span class="n">m</span><span class="o">*</span><span class="n">m</span><span class="o">*</span><span class="n">pow</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">w</span><span class="p">)));</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">v</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

    <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">TwoDVectorPushBack</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">velocity</span><span class="p">);</span>
    <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">TwoDVectorPushBack</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="mf">1.</span><span class="o">/</span><span class="n">v</span><span class="p">,</span><span class="n">inversevelocity</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="cm">/* This fills the t vs R vector (A.4.II)*/</span>
  <span class="n">gsl_spline</span> <span class="o">*</span><span class="n">timelookup</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">GSLsplineFromTwoDVector</span><span class="p">(</span>
                                    <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">IntegratedProfile</span><span class="p">(</span><span class="n">inversevelocity</span><span class="p">)</span>
                                   <span class="p">);</span>
  <span class="n">gsl_interp_accel</span> <span class="o">*</span><span class="n">atime</span> <span class="o">=</span> <span class="n">gsl_interp_accel_alloc</span><span class="p">();</span>

  <span class="cm">/* but what we want is not t(r) but rather r(t) -&gt; invert the TGraph! */</span>
  <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">inversevelocity</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">inversevelocity</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">EvalSpline</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">timelookup</span><span class="p">,</span><span class="n">atime</span><span class="p">,</span><span class="n">__func__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">);</span>
    <span class="n">r0</span> <span class="o">=</span> <span class="n">velocity</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">velocity</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span><span class="n">r</span><span class="o">!=</span><span class="n">r0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Astro::CalculateThinShellApproximation: Radius and Velocity &quot;</span>
                 <span class="s">&quot;calculations do not match! Exiting!&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">r</span><span class="o">&lt;</span><span class="n">rMinInternalBoundary</span><span class="o">||</span><span class="n">r</span><span class="o">&gt;</span><span class="n">rMaxInternalBoundary</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">t</span><span class="o">&lt;</span><span class="n">tMinInternalBoundary</span><span class="o">||</span><span class="n">t</span><span class="o">&gt;</span><span class="n">tMaxInternalBoundary</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

    <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">TwoDVectorPushBack</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">thinshellradius</span><span class="p">);</span>
    <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">TwoDVectorPushBack</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">thinshellvelocity</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">thinshellradius</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">SortTwoDVector</span><span class="p">(</span><span class="n">thinshellradius</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
  <span class="n">thinshellvelocity</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">SortTwoDVector</span><span class="p">(</span><span class="n">thinshellvelocity</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
  <span class="n">thinshellsolutiontmin</span> <span class="o">=</span> <span class="n">thinshellradius</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
  <span class="n">thinshellsolutiontmax</span> <span class="o">=</span> <span class="n">thinshellradius</span><span class="p">[</span><span class="n">thinshellradius</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>

  <span class="n">thinshellradiuslookup</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">GSLsplineFromTwoDVector</span><span class="p">(</span><span class="n">thinshellradius</span><span class="p">);</span>
  <span class="n">thinshellvelocitylookup</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">GSLsplineFromTwoDVector</span><span class="p">(</span><span class="n">thinshellvelocity</span><span class="p">);</span>

  <span class="c1">// make the r and v time profiles</span>
  <span class="k">if</span><span class="p">(</span><span class="n">steps</span> <span class="o">&amp;&amp;</span> <span class="n">tmin</span> <span class="o">&amp;&amp;</span> <span class="n">tmax</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">tmin</span><span class="o">&gt;=</span><span class="n">tmax</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Astro::CalculateThinShellApproximation: Can&#39;t create profiles&quot;</span>
              <span class="s">&quot;because tmin &gt;= tmax (&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">tmin</span> <span class="o">&lt;&lt;</span><span class="s">&quot; &gt;= &quot;</span><span class="o">&lt;&lt;</span> <span class="n">tmax</span> <span class="o">&lt;&lt;</span>
              <span class="s">&quot;) Exiting!&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kt">double</span> <span class="n">logtmin</span> <span class="o">=</span> <span class="n">log10</span><span class="p">(</span><span class="n">tmin</span><span class="p">);</span>
    <span class="kt">double</span> <span class="n">logtmax</span> <span class="o">=</span> <span class="n">log10</span><span class="p">(</span><span class="n">tmax</span><span class="p">);</span>
    <span class="kt">double</span> <span class="n">dlogt</span> <span class="o">=</span> <span class="p">(</span><span class="n">logtmax</span><span class="o">-</span><span class="n">logtmin</span><span class="p">)</span><span class="o">/</span><span class="n">steps</span><span class="p">;</span>
    <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">Clear2DVector</span><span class="p">(</span><span class="n">forwardshockradiusprofile</span><span class="p">);</span>
    <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">Clear2DVector</span><span class="p">(</span><span class="n">forwardshockvelocityprofile</span><span class="p">);</span>
    <span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">x</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">t</span><span class="o">=</span><span class="mf">0.</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">double</span> <span class="n">logt</span> <span class="o">=</span> <span class="n">logtmin</span> <span class="p">;</span> <span class="n">logt</span> <span class="o">&lt;</span> <span class="n">logtmax</span> <span class="p">;</span> <span class="n">logt</span> <span class="o">+=</span> <span class="n">dlogt</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">t</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span><span class="n">logt</span><span class="p">);</span>
      <span class="n">x</span> <span class="o">=</span> <span class="n">ThinShellRadiusAndSpeed</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
      <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">TwoDVectorPushBack</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">pc_to_cm</span><span class="p">,</span><span class="n">forwardshockradiusprofile</span><span class="p">);</span>
      <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">TwoDVectorPushBack</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">forwardshockvelocityprofile</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">Astro</span><span class="o">::</span><span class="n">TrueloveMcKeeRadiusAndSpeed</span><span class="p">(</span><span class="kt">double</span> <span class="n">t</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">REVERSE</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">v</span><span class="p">,</span><span class="n">vzero</span><span class="p">;</span>
  <span class="n">vzero</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mf">0.</span><span class="p">);</span>
  <span class="n">vzero</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mf">0.</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">R</span><span class="p">,</span><span class="n">V</span><span class="p">;</span>
  <span class="n">t</span><span class="o">*=</span><span class="n">yr_to_sec</span><span class="p">;</span>

  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">r_edforward</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">||</span> <span class="o">!</span><span class="n">v_edforward</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">||</span> <span class="o">!</span><span class="n">r_stforward</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">||</span>
     <span class="o">!</span><span class="n">v_stforward</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">||</span> <span class="o">!</span><span class="n">r_edreverse</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">||</span> <span class="o">!</span><span class="n">v_edreverse</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">||</span>
     <span class="o">!</span><span class="n">r_streverse</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">||</span> <span class="o">!</span><span class="n">v_streverse</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">||</span>
     <span class="n">truelovemckeeparams</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">23</span><span class="p">)</span> <span class="p">{</span>

     <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Astro::TrueloveMcKeeRadiusAndSpeed: You have to run the calculation &quot;</span>
             <span class="s">&quot;first via CalculateThinShellApproximation()! Returning (r=0,v=0)!&quot;</span>
          <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kt">double</span> <span class="n">tmin</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">tmax</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">ttrans</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">sedovtime</span> <span class="o">=</span> <span class="n">truelovemckeeparams</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">coreexittime</span> <span class="o">=</span> <span class="n">truelovemckeeparams</span><span class="p">[</span><span class="mi">21</span><span class="p">];</span>
  <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">truelovemckeeparams</span><span class="p">[</span><span class="mi">22</span><span class="p">];</span>

  <span class="k">if</span><span class="p">(</span><span class="n">REVERSE</span><span class="p">)</span> <span class="p">(</span><span class="n">index</span><span class="o">&gt;</span><span class="mi">5</span><span class="p">)</span> <span class="o">?</span> <span class="n">ttrans</span> <span class="o">=</span> <span class="nl">coreexittime</span><span class="p">:</span> <span class="n">ttrans</span> <span class="o">=</span> <span class="n">sedovtime</span><span class="p">;</span>
  <span class="k">else</span> <span class="n">ttrans</span> <span class="o">=</span> <span class="n">sedovtime</span><span class="p">;</span>

  <span class="k">if</span><span class="p">(</span><span class="n">t</span><span class="o">&lt;</span><span class="n">ttrans</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">REVERSE</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">tmin</span> <span class="o">=</span> <span class="n">truelovemckeetminred</span><span class="p">;</span>
      <span class="n">tmax</span> <span class="o">=</span> <span class="n">truelovemckeetmaxred</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="n">tmin</span> <span class="o">=</span> <span class="n">truelovemckeetminfed</span><span class="p">;</span>
      <span class="n">tmax</span> <span class="o">=</span> <span class="n">truelovemckeetmaxfed</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">REVERSE</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">tmin</span> <span class="o">=</span> <span class="n">truelovemckeetminrst</span><span class="p">;</span>
      <span class="n">tmax</span> <span class="o">=</span> <span class="n">truelovemckeetmaxrst</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="n">tmin</span> <span class="o">=</span> <span class="n">truelovemckeetminfst</span><span class="p">;</span>
      <span class="n">tmax</span> <span class="o">=</span> <span class="n">truelovemckeetmaxfst</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="n">tmin</span> <span class="o">&gt;=</span> <span class="n">tmax</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Astro::TrueloveMcKeeRadiusAndSpeed: Something wrong with time &quot;</span>
            <span class="s">&quot;boundaries &quot;</span>
         <span class="o">&lt;&lt;</span> <span class="s">&quot;(tmin=&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">tmin</span><span class="o">/</span><span class="n">yr_to_sec</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; , tmax = &quot;</span>
         <span class="o">&lt;&lt;</span> <span class="n">tmax</span><span class="o">/</span><span class="n">yr_to_sec</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;). Returning (r=0,v=0)!&quot;</span>
         <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">vzero</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="n">t</span><span class="o">&lt;</span><span class="n">tmin</span> <span class="o">||</span> <span class="n">t</span><span class="o">&gt;</span><span class="n">tmax</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">QUIETMODE</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Astro::TrueloveMcKeeRadiusAndSpeed: time outside solution &quot;</span>
           <span class="o">&lt;&lt;</span> <span class="s">&quot;boundaries (t=&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">t</span><span class="o">/</span><span class="n">yr_to_sec</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; outside [&quot;</span>
           <span class="o">&lt;&lt;</span> <span class="n">tmin</span><span class="o">/</span><span class="n">yr_to_sec</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;,&quot;</span>
           <span class="o">&lt;&lt;</span> <span class="n">tmax</span><span class="o">/</span><span class="n">yr_to_sec</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;]). &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
      <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Returning (r=0,v=0)!&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">vzero</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span><span class="p">(</span><span class="n">t</span><span class="o">&lt;</span><span class="n">ttrans</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">REVERSE</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">R</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">EvalSpline</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">r_edreverselookup</span><span class="p">,</span><span class="n">aredr</span><span class="p">,</span><span class="n">__func__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">);</span>
      <span class="n">V</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">EvalSpline</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">v_edreverselookup</span><span class="p">,</span><span class="n">avedr</span><span class="p">,</span><span class="n">__func__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="n">R</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">EvalSpline</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">r_edforwardlookup</span><span class="p">,</span><span class="n">aredf</span><span class="p">,</span><span class="n">__func__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">);</span>
      <span class="n">V</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">EvalSpline</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">v_edforwardlookup</span><span class="p">,</span><span class="n">avedf</span><span class="p">,</span><span class="n">__func__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">REVERSE</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">R</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">EvalSpline</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">r_streverselookup</span><span class="p">,</span><span class="n">arstr</span><span class="p">,</span><span class="n">__func__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">);</span>
      <span class="n">V</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">EvalSpline</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">v_streverselookup</span><span class="p">,</span><span class="n">avstr</span><span class="p">,</span><span class="n">__func__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="n">R</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">EvalSpline</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">r_stforwardlookup</span><span class="p">,</span><span class="n">arstf</span><span class="p">,</span><span class="n">__func__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">);</span>
      <span class="n">V</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">EvalSpline</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">v_stforwardlookup</span><span class="p">,</span><span class="n">avstf</span><span class="p">,</span><span class="n">__func__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">v</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">R</span><span class="p">);</span>
  <span class="n">v</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">V</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">v</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Astro</span><span class="o">::</span><span class="n">CalculateTrueloveMcKeeSolution</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">pars</span><span class="p">,</span> <span class="kt">double</span> <span class="n">tmin</span><span class="p">,</span>
                                           <span class="kt">double</span> <span class="n">tmax</span><span class="p">,</span> <span class="kt">int</span> <span class="n">steps</span><span class="p">)</span> <span class="p">{</span>

  <span class="k">if</span><span class="p">(</span><span class="n">pars</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">!=</span><span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Astro::CalculateTrueloveMcKeeSolution: wrong number of parameters (&quot;</span>
         <span class="o">&lt;&lt;</span> <span class="n">pars</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;). Parameter list takes exactly 4 &quot;</span>
            <span class="s">&quot;parameters: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; - [0] ambient density (cm^-3) &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; - [1] SN blast energy (erg) &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; - [2] SN ejecta mass (mSol) &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; - [3] density index &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Exiting!&quot;</span> <span class="o">&lt;&lt;</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">CalculateTrueLoveMcKeeParams</span><span class="p">(</span><span class="n">pars</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">truelovemckeeparams</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&quot;Astro::CalculateTrueloveMcKeeSolution: &quot;</span>
               <span class="s">&quot;No paramters given. Exiting.&quot;</span><span class="o">&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>


  <span class="kt">double</span> <span class="n">charradiustruelovemckee</span> <span class="o">=</span> <span class="n">truelovemckeeparams</span><span class="p">[</span><span class="mi">17</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">chartimetruelovemckee</span> <span class="o">=</span> <span class="n">truelovemckeeparams</span><span class="p">[</span><span class="mi">18</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">charvelocitytruelovemckee</span> <span class="o">=</span> <span class="n">truelovemckeeparams</span><span class="p">[</span><span class="mi">19</span><span class="p">];</span>


  <span class="kt">bool</span> <span class="n">SKIPFWS</span><span class="p">,</span><span class="n">SKIPRVS</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">x0</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="n">dx</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">yr</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">tr</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">rr</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">vr</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">truelovemckeeparams</span><span class="p">[</span><span class="mi">22</span><span class="p">];</span>
  <span class="k">if</span><span class="p">(</span><span class="n">index</span><span class="o">&lt;</span><span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">rMinInternalBoundary</span><span class="o">/</span><span class="n">charradiustruelovemckee</span><span class="p">;</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="n">rMaxInternalBoundary</span><span class="o">/</span><span class="n">charradiustruelovemckee</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">tMinInternalBoundary</span><span class="o">/</span><span class="n">chartimetruelovemckee</span><span class="p">;</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="n">tMaxInternalBoundary</span><span class="o">/</span><span class="n">chartimetruelovemckee</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">dx</span><span class="o">=</span><span class="n">log10</span><span class="p">(</span><span class="n">x1</span><span class="o">/</span><span class="n">x0</span><span class="p">)</span><span class="o">/</span><span class="n">steps</span><span class="p">;</span>
  <span class="k">for</span><span class="p">(</span><span class="kt">double</span> <span class="n">x</span><span class="o">=</span><span class="n">x0</span><span class="p">;</span><span class="n">x</span><span class="o">&lt;</span><span class="n">x1</span><span class="p">;</span><span class="n">x</span><span class="o">=</span><span class="n">pow</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span><span class="n">log10</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">+</span><span class="n">dx</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">SKIPFWS</span><span class="o">=</span><span class="n">SKIPRVS</span><span class="o">=</span><span class="nb">false</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">TrueloveMcKeeEjectaDominatedForwardShock</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">v</span><span class="p">))</span> <span class="n">SKIPFWS</span><span class="o">=</span><span class="nb">true</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">TrueloveMcKeeEjectaDominatedReverseShock</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">yr</span><span class="p">,</span><span class="n">vr</span><span class="p">))</span> <span class="n">SKIPRVS</span><span class="o">=</span><span class="nb">true</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">index</span><span class="o">&lt;</span><span class="mi">5</span><span class="p">)</span> <span class="p">{</span><span class="n">r</span><span class="o">=</span><span class="n">x</span><span class="p">;</span><span class="n">t</span><span class="o">=</span><span class="n">y</span><span class="p">;</span><span class="n">tr</span><span class="o">=</span><span class="n">yr</span><span class="p">,</span><span class="n">rr</span><span class="o">=</span><span class="n">x</span><span class="p">;}</span>
    <span class="k">else</span> <span class="p">{</span><span class="n">r</span><span class="o">=</span><span class="n">y</span><span class="p">;</span><span class="n">t</span><span class="o">=</span><span class="n">x</span><span class="p">;</span><span class="n">rr</span><span class="o">=</span><span class="n">yr</span><span class="p">;</span><span class="n">tr</span><span class="o">=</span><span class="n">x</span><span class="p">;}</span>
    <span class="n">t</span><span class="o">*=</span><span class="n">chartimetruelovemckee</span><span class="p">;</span>
    <span class="n">r</span><span class="o">*=</span><span class="n">charradiustruelovemckee</span><span class="p">;</span>
    <span class="n">v</span><span class="o">*=</span><span class="n">charvelocitytruelovemckee</span><span class="p">;</span>
    <span class="n">tr</span><span class="o">*=</span><span class="n">chartimetruelovemckee</span><span class="p">;</span>
    <span class="n">rr</span><span class="o">*=</span><span class="n">charradiustruelovemckee</span><span class="p">;</span>
    <span class="n">vr</span><span class="o">*=</span><span class="n">charvelocitytruelovemckee</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">SKIPFWS</span><span class="o">==</span><span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">TwoDVectorPushBack</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">r_edforward</span><span class="p">);</span>
      <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">TwoDVectorPushBack</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">v_edforward</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">SKIPRVS</span><span class="o">==</span><span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">TwoDVectorPushBack</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span><span class="n">rr</span><span class="p">,</span><span class="n">r_edreverse</span><span class="p">);</span>
      <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">TwoDVectorPushBack</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span><span class="n">vr</span><span class="p">,</span><span class="n">v_edreverse</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">x0</span> <span class="o">=</span> <span class="n">tMinInternalBoundary</span><span class="o">/</span><span class="n">chartimetruelovemckee</span><span class="p">;</span>
  <span class="n">x1</span> <span class="o">=</span> <span class="n">tMaxInternalBoundary</span><span class="o">/</span><span class="n">chartimetruelovemckee</span><span class="p">;</span>
  <span class="n">dx</span><span class="o">=</span><span class="n">log10</span><span class="p">(</span><span class="n">x1</span><span class="o">/</span><span class="n">x0</span><span class="p">)</span><span class="o">/</span><span class="n">steps</span><span class="p">;</span>
  <span class="k">for</span><span class="p">(</span><span class="kt">double</span> <span class="n">x</span><span class="o">=</span><span class="n">x0</span><span class="p">;</span><span class="n">x</span><span class="o">&lt;</span><span class="n">x1</span><span class="p">;</span><span class="n">x</span><span class="o">=</span><span class="n">pow</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span><span class="n">log10</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">+</span><span class="n">dx</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">SKIPFWS</span><span class="o">=</span><span class="n">SKIPRVS</span><span class="o">=</span><span class="nb">false</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">TrueloveMcKeeSedovTaylorPhaseForwardShock</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">v</span><span class="p">))</span> <span class="n">SKIPFWS</span><span class="o">=</span><span class="nb">true</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">TrueloveMcKeeSedovTaylorPhaseReverseShock</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">rr</span><span class="p">,</span><span class="n">vr</span><span class="p">))</span> <span class="n">SKIPRVS</span><span class="o">=</span><span class="nb">true</span><span class="p">;</span>
    <span class="n">t</span><span class="o">=</span><span class="n">x</span><span class="o">*</span><span class="n">chartimetruelovemckee</span><span class="p">;</span>
    <span class="n">r</span><span class="o">*=</span><span class="n">charradiustruelovemckee</span><span class="p">;</span>
    <span class="n">v</span><span class="o">*=</span><span class="n">charvelocitytruelovemckee</span><span class="p">;</span>
    <span class="n">tr</span><span class="o">=</span><span class="n">x</span><span class="o">*</span><span class="n">chartimetruelovemckee</span><span class="p">;</span>
    <span class="n">rr</span><span class="o">*=</span><span class="n">charradiustruelovemckee</span><span class="p">;</span>
    <span class="n">vr</span><span class="o">*=</span><span class="n">charvelocitytruelovemckee</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">SKIPFWS</span><span class="o">==</span><span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">TwoDVectorPushBack</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">r_stforward</span><span class="p">);</span>
      <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">TwoDVectorPushBack</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">v_stforward</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">SKIPRVS</span><span class="o">==</span><span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">TwoDVectorPushBack</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span><span class="n">rr</span><span class="p">,</span><span class="n">r_streverse</span><span class="p">);</span>
      <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">TwoDVectorPushBack</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span><span class="n">vr</span><span class="p">,</span><span class="n">v_streverse</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="cm">/* sort TGraphs in time and get minimum and maximum time boundaries */</span>
  <span class="n">r_edforward</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">SortTwoDVector</span><span class="p">(</span><span class="n">r_edforward</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
  <span class="n">v_edforward</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">SortTwoDVector</span><span class="p">(</span><span class="n">v_edforward</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
  <span class="n">r_edreverse</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">SortTwoDVector</span><span class="p">(</span><span class="n">r_edreverse</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
  <span class="n">v_edreverse</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">SortTwoDVector</span><span class="p">(</span><span class="n">v_edreverse</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
  <span class="n">r_stforward</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">SortTwoDVector</span><span class="p">(</span><span class="n">r_stforward</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
  <span class="n">v_stforward</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">SortTwoDVector</span><span class="p">(</span><span class="n">v_stforward</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
  <span class="n">r_streverse</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">SortTwoDVector</span><span class="p">(</span><span class="n">r_streverse</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
  <span class="n">v_streverse</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">SortTwoDVector</span><span class="p">(</span><span class="n">v_streverse</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>

  <span class="n">truelovemckeetminfed</span> <span class="o">=</span> <span class="n">r_edforward</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
  <span class="n">truelovemckeetminfst</span> <span class="o">=</span> <span class="n">r_stforward</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
  <span class="n">truelovemckeetmaxfed</span> <span class="o">=</span> <span class="n">r_edforward</span><span class="p">[</span><span class="n">r_edforward</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
  <span class="n">truelovemckeetmaxfst</span> <span class="o">=</span> <span class="n">r_stforward</span><span class="p">[</span><span class="n">r_stforward</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>

  <span class="n">truelovemckeetminred</span> <span class="o">=</span> <span class="n">r_edreverse</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
  <span class="n">truelovemckeetminrst</span> <span class="o">=</span> <span class="n">r_streverse</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
  <span class="n">truelovemckeetmaxred</span> <span class="o">=</span> <span class="n">r_edreverse</span><span class="p">[</span><span class="n">r_edreverse</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
  <span class="n">truelovemckeetmaxrst</span> <span class="o">=</span> <span class="n">r_streverse</span><span class="p">[</span><span class="n">r_streverse</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>

  <span class="n">r_edforwardlookup</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">GSLsplineFromTwoDVector</span><span class="p">(</span><span class="n">r_edforward</span><span class="p">);</span>
  <span class="n">v_edforwardlookup</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">GSLsplineFromTwoDVector</span><span class="p">(</span><span class="n">v_edforward</span><span class="p">);</span>
  <span class="n">r_edreverselookup</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">GSLsplineFromTwoDVector</span><span class="p">(</span><span class="n">r_edreverse</span><span class="p">);</span>
  <span class="n">v_edreverselookup</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">GSLsplineFromTwoDVector</span><span class="p">(</span><span class="n">v_edreverse</span><span class="p">);</span>

  <span class="n">r_stforwardlookup</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">GSLsplineFromTwoDVector</span><span class="p">(</span><span class="n">r_stforward</span><span class="p">);</span>
  <span class="n">v_stforwardlookup</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">GSLsplineFromTwoDVector</span><span class="p">(</span><span class="n">v_stforward</span><span class="p">);</span>
  <span class="n">r_streverselookup</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">GSLsplineFromTwoDVector</span><span class="p">(</span><span class="n">r_streverse</span><span class="p">);</span>
  <span class="n">v_streverselookup</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">GSLsplineFromTwoDVector</span><span class="p">(</span><span class="n">v_streverse</span><span class="p">);</span>

  <span class="c1">// make the r and v time profiles</span>
  <span class="k">if</span><span class="p">(</span><span class="n">steps</span> <span class="o">&amp;&amp;</span> <span class="n">tmin</span> <span class="o">&amp;&amp;</span> <span class="n">tmax</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">tmin</span><span class="o">&gt;=</span><span class="n">tmax</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Astro::CalculateThinShellApproximation: Can&#39;t create profiles&quot;</span>
              <span class="s">&quot;because tmin &gt;= tmax (&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">tmin</span> <span class="o">&lt;&lt;</span><span class="s">&quot; &gt;= &quot;</span><span class="o">&lt;&lt;</span> <span class="n">tmax</span> <span class="o">&lt;&lt;</span>
              <span class="s">&quot;) Exiting!&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kt">double</span> <span class="n">logtmin</span> <span class="o">=</span> <span class="n">log10</span><span class="p">(</span><span class="n">tmin</span><span class="p">);</span>
    <span class="kt">double</span> <span class="n">logtmax</span> <span class="o">=</span> <span class="n">log10</span><span class="p">(</span><span class="n">tmax</span><span class="p">);</span>
    <span class="kt">double</span> <span class="n">dlogt</span> <span class="o">=</span> <span class="p">(</span><span class="n">logtmax</span><span class="o">-</span><span class="n">logtmin</span><span class="p">)</span><span class="o">/</span><span class="n">steps</span><span class="p">;</span>
    <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">Clear2DVector</span><span class="p">(</span><span class="n">forwardshockradiusprofile</span><span class="p">);</span>
    <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">Clear2DVector</span><span class="p">(</span><span class="n">forwardshockvelocityprofile</span><span class="p">);</span>
    <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">Clear2DVector</span><span class="p">(</span><span class="n">reverseshockradiusprofile</span><span class="p">);</span>
    <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">Clear2DVector</span><span class="p">(</span><span class="n">reverseshockvelocityprofile</span><span class="p">);</span>
    <span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">x</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">t</span><span class="o">=</span><span class="mf">0.</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">double</span> <span class="n">logt</span> <span class="o">=</span> <span class="n">logtmin</span> <span class="p">;</span> <span class="n">logt</span> <span class="o">&lt;</span> <span class="n">logtmax</span> <span class="p">;</span> <span class="n">logt</span> <span class="o">+=</span> <span class="n">dlogt</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">t</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span><span class="n">logt</span><span class="p">);</span>
      <span class="n">x</span> <span class="o">=</span> <span class="n">TrueloveMcKeeRadiusAndSpeedForward</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
      <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">TwoDVectorPushBack</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">pc_to_cm</span><span class="p">,</span><span class="n">forwardshockradiusprofile</span><span class="p">);</span>
      <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">TwoDVectorPushBack</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">forwardshockvelocityprofile</span><span class="p">);</span>
      <span class="n">x</span> <span class="o">=</span> <span class="n">TrueloveMcKeeRadiusAndSpeedReverse</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
      <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">TwoDVectorPushBack</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">pc_to_cm</span><span class="p">,</span><span class="n">reverseshockradiusprofile</span><span class="p">);</span>
      <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">TwoDVectorPushBack</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">reverseshockvelocityprofile</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">Astro</span><span class="o">::</span><span class="n">TrueloveMcKeeEjectaDominatedForwardShock</span><span class="p">(</span><span class="kt">double</span> <span class="n">x</span><span class="p">,</span>
                                                    <span class="kt">double</span> <span class="o">&amp;</span><span class="n">Y</span><span class="p">,</span> <span class="kt">double</span> <span class="o">&amp;</span><span class="n">V</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">double</span> <span class="n">l_ED</span> <span class="o">=</span> <span class="n">truelovemckeeparams</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">phi_ED</span> <span class="o">=</span> <span class="n">truelovemckeeparams</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">phi_EDeff</span> <span class="o">=</span> <span class="n">truelovemckeeparams</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">f_n</span> <span class="o">=</span> <span class="n">truelovemckeeparams</span><span class="p">[</span><span class="mi">14</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">alpha</span> <span class="o">=</span> <span class="n">truelovemckeeparams</span><span class="p">[</span><span class="mi">15</span><span class="p">];</span>
  <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">truelovemckeeparams</span><span class="p">[</span><span class="mi">22</span><span class="p">];</span>

  <span class="k">if</span><span class="p">(</span><span class="n">index</span><span class="o">&lt;</span><span class="mf">5.</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">-</span><span class="p">((</span><span class="mf">3.</span><span class="o">-</span><span class="n">index</span><span class="p">)</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">phi_EDeff</span><span class="o">/</span><span class="p">(</span><span class="n">l_ED</span><span class="o">*</span><span class="n">f_n</span><span class="p">))</span><span class="o">*</span><span class="n">pow</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="mf">1.5</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">Y</span><span class="o">&lt;=</span><span class="mf">0.</span><span class="p">)</span> <span class="p">{</span><span class="n">Y</span><span class="o">=</span><span class="mf">0.</span><span class="p">;</span><span class="n">V</span><span class="o">=</span><span class="mf">0.</span><span class="p">;</span><span class="k">return</span> <span class="mi">1</span><span class="p">;}</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="o">-</span><span class="mf">2.</span><span class="o">/</span><span class="p">(</span><span class="mf">3.</span><span class="o">-</span><span class="n">index</span><span class="p">));</span>
    <span class="n">Y</span> <span class="o">*=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">alpha</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="o">/</span><span class="n">l_ED</span><span class="p">;</span>

    <span class="n">V</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">-</span><span class="p">((</span><span class="mf">3.</span><span class="o">-</span><span class="n">index</span><span class="p">)</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">phi_EDeff</span><span class="o">/</span><span class="p">(</span><span class="n">l_ED</span><span class="o">*</span><span class="n">f_n</span><span class="p">))</span><span class="o">*</span><span class="n">pow</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="mf">1.5</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">V</span><span class="o">&lt;=</span><span class="mf">0.</span><span class="p">)</span> <span class="p">{</span><span class="n">Y</span><span class="o">=</span><span class="mf">0.</span><span class="p">;</span><span class="n">V</span><span class="o">=</span><span class="mf">0.</span><span class="p">;</span><span class="k">return</span> <span class="mi">1</span><span class="p">;}</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="n">V</span><span class="p">,(</span><span class="mf">5.</span><span class="o">-</span><span class="n">index</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">3.</span><span class="o">-</span><span class="n">index</span><span class="p">));</span>
    <span class="n">V</span> <span class="o">*=</span> <span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="o">/</span><span class="n">alpha</span><span class="p">)</span><span class="o">*</span><span class="n">l_ED</span><span class="p">;</span>
    <span class="n">V</span> <span class="o">/=</span> <span class="mf">1.</span><span class="o">+</span><span class="p">(</span><span class="n">index</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">phi_EDeff</span><span class="o">/</span><span class="p">(</span><span class="n">l_ED</span><span class="o">*</span><span class="n">f_n</span><span class="p">))</span><span class="o">*</span><span class="n">pow</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="mf">1.5</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="mf">27.</span><span class="o">*</span><span class="n">pow</span><span class="p">(</span><span class="n">l_ED</span><span class="p">,</span><span class="n">index</span><span class="o">-</span><span class="mf">2.</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">phi_ED</span><span class="o">*</span><span class="p">(</span><span class="mf">4.</span><span class="o">*</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="n">index</span><span class="o">*</span><span class="p">(</span><span class="n">index</span><span class="o">-</span><span class="mf">3.</span><span class="p">));</span>
    <span class="n">Y</span><span class="o">*=</span> <span class="n">pow</span><span class="p">((</span><span class="mf">10.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">index</span><span class="o">-</span><span class="mf">5.</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">index</span><span class="o">-</span><span class="mf">3.</span><span class="p">),(</span><span class="n">index</span><span class="o">-</span><span class="mf">3.</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">Y</span><span class="o">&lt;=</span><span class="mf">0.</span><span class="p">)</span> <span class="p">{</span><span class="n">Y</span><span class="o">=</span><span class="mf">0.</span><span class="p">;</span><span class="n">V</span><span class="o">=</span><span class="mf">0.</span><span class="p">;</span><span class="k">return</span> <span class="mi">1</span><span class="p">;}</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="mf">1.</span><span class="o">/</span><span class="n">index</span><span class="p">);</span>
    <span class="n">Y</span> <span class="o">*=</span> <span class="n">pow</span><span class="p">(</span><span class="n">x</span><span class="p">,(</span><span class="n">index</span><span class="o">-</span><span class="mf">3.</span><span class="p">)</span><span class="o">/</span><span class="n">index</span><span class="p">);</span>

    <span class="n">V</span> <span class="o">=</span> <span class="mf">27.</span><span class="o">/</span><span class="p">(</span><span class="mf">4.</span><span class="o">*</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="n">pow</span><span class="p">(</span><span class="n">index</span><span class="o">*</span><span class="p">(</span><span class="n">index</span><span class="o">-</span><span class="mf">3.</span><span class="p">),</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span><span class="o">*</span><span class="n">pow</span><span class="p">(</span><span class="n">l_ED</span><span class="p">,</span><span class="n">index</span><span class="o">-</span><span class="mf">2.</span><span class="p">)</span><span class="o">/</span><span class="n">phi_ED</span><span class="p">;</span>
    <span class="n">V</span> <span class="o">*=</span> <span class="n">pow</span><span class="p">((</span><span class="mf">10.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">index</span><span class="o">-</span><span class="mf">5.</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">index</span><span class="o">-</span><span class="mf">3.</span><span class="p">),(</span><span class="n">index</span><span class="o">-</span><span class="mf">3.</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">V</span><span class="o">&lt;=</span><span class="mf">0.</span><span class="p">)</span> <span class="p">{</span><span class="n">Y</span><span class="o">=</span><span class="mf">0.</span><span class="p">;</span><span class="n">V</span><span class="o">=</span><span class="mf">0.</span><span class="p">;</span><span class="k">return</span> <span class="mi">1</span><span class="p">;}</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="n">V</span><span class="p">,</span><span class="mf">1.</span><span class="o">/</span><span class="n">index</span><span class="p">);</span>
    <span class="n">V</span> <span class="o">*=</span> <span class="p">(</span><span class="n">index</span><span class="o">-</span><span class="mf">3.</span><span class="p">)</span><span class="o">/</span><span class="n">index</span><span class="o">*</span><span class="n">pow</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="o">-</span><span class="mf">3.</span><span class="o">/</span><span class="n">index</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="n">Y</span><span class="o">&lt;</span><span class="mf">0.</span><span class="p">)</span> <span class="n">Y</span><span class="o">=</span><span class="mf">0.</span><span class="p">;</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">Astro</span><span class="o">::</span><span class="n">TrueloveMcKeeSedovTaylorPhaseForwardShock</span><span class="p">(</span><span class="kt">double</span> <span class="n">t</span><span class="p">,</span>
                                                     <span class="kt">double</span> <span class="o">&amp;</span><span class="n">R</span><span class="p">,</span> <span class="kt">double</span> <span class="o">&amp;</span><span class="n">V</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">double</span> <span class="n">tSt</span><span class="o">=</span><span class="n">truelovemckeeparams</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">rSt</span><span class="o">=</span><span class="n">truelovemckeeparams</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">eta</span><span class="o">=</span><span class="mf">0.4</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">zeta</span><span class="o">=</span><span class="mf">2.026</span><span class="p">;</span>

  <span class="kt">double</span> <span class="n">k</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="n">rSt</span><span class="p">,</span><span class="mf">1.</span><span class="o">/</span><span class="n">eta</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">l</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="n">rSt</span><span class="p">,</span><span class="mf">2.5</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">m</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">zeta</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="n">tSt</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="o">-</span><span class="n">m</span> <span class="o">&gt;=</span> <span class="n">k</span> <span class="o">||</span> <span class="o">-</span><span class="n">m</span> <span class="o">&gt;=</span> <span class="n">l</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">R</span><span class="o">=</span><span class="n">V</span><span class="o">=</span><span class="mf">0.</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">R</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="n">m</span><span class="p">,</span><span class="n">eta</span><span class="p">);</span>
  <span class="n">V</span> <span class="o">=</span> <span class="mf">0.4</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">zeta</span><span class="p">)</span><span class="o">*</span><span class="n">pow</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="n">m</span><span class="p">,</span><span class="o">-</span><span class="mf">0.6</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="n">R</span><span class="o">&lt;</span><span class="mf">0.</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">R</span><span class="o">=</span><span class="n">V</span><span class="o">=</span><span class="mf">0.</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">Astro</span><span class="o">::</span><span class="n">TrueloveMcKeeSedovTaylorPhaseReverseShock</span><span class="p">(</span><span class="kt">double</span> <span class="n">t</span><span class="p">,</span> <span class="kt">double</span> <span class="o">&amp;</span><span class="n">R</span><span class="p">,</span> <span class="kt">double</span> <span class="o">&amp;</span><span class="n">V</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">double</span> <span class="n">r_rSt</span> <span class="o">=</span> <span class="n">truelovemckeeparams</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">a_rSt</span> <span class="o">=</span> <span class="n">truelovemckeeparams</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">tSt</span> <span class="o">=</span> <span class="n">truelovemckeeparams</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">v_rSt</span> <span class="o">=</span> <span class="n">truelovemckeeparams</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">r_rCore</span> <span class="o">=</span> <span class="n">truelovemckeeparams</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">a_rCore</span> <span class="o">=</span> <span class="n">truelovemckeeparams</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">tCore</span> <span class="o">=</span> <span class="n">truelovemckeeparams</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">v_rCore</span> <span class="o">=</span> <span class="n">truelovemckeeparams</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
  <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">truelovemckeeparams</span><span class="p">[</span><span class="mi">22</span><span class="p">];</span>

  <span class="kt">double</span> <span class="n">r_rRel</span><span class="p">,</span><span class="n">tRel</span><span class="p">,</span><span class="n">a_rRel</span><span class="p">,</span><span class="n">v_rRel</span><span class="p">;</span>
  <span class="n">r_rRel</span><span class="o">=</span><span class="n">tRel</span><span class="o">=</span><span class="n">a_rRel</span><span class="o">=</span><span class="n">v_rRel</span><span class="o">=</span><span class="mf">0.</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="n">index</span><span class="o">&lt;</span><span class="mf">3.</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">tRel</span> <span class="o">=</span> <span class="n">tSt</span><span class="p">;</span>
    <span class="n">r_rRel</span> <span class="o">=</span> <span class="n">r_rSt</span><span class="p">;</span>
    <span class="n">a_rRel</span> <span class="o">=</span> <span class="n">a_rSt</span><span class="p">;</span>
    <span class="n">v_rRel</span> <span class="o">=</span> <span class="n">v_rSt</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">index</span><span class="o">&gt;</span><span class="mf">5.</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">tRel</span> <span class="o">=</span> <span class="n">tCore</span><span class="p">;</span>
    <span class="n">r_rRel</span> <span class="o">=</span> <span class="n">r_rCore</span><span class="p">;</span>
    <span class="n">a_rRel</span> <span class="o">=</span> <span class="n">a_rCore</span><span class="p">;</span>
    <span class="n">v_rRel</span> <span class="o">=</span> <span class="n">v_rCore</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&quot;Astro::TrueloveMcKeeSedovTaylorPhaseReverseShock: &quot;</span>
               <span class="s">&quot;Whaaat?! I have to implement the reverse shock if index = 4!&quot;</span>
               <span class="s">&quot;Exiting!&quot;</span><span class="o">&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">R</span><span class="o">=</span><span class="n">V</span><span class="o">=</span><span class="mf">0.</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">R</span> <span class="o">=</span> <span class="n">t</span><span class="o">*</span><span class="p">(</span><span class="n">r_rRel</span><span class="o">/</span><span class="n">tRel</span> <span class="o">-</span> <span class="n">a_rRel</span><span class="o">*</span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="n">tRel</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">v_rRel</span><span class="o">-</span><span class="n">a_rRel</span><span class="o">*</span><span class="n">tRel</span><span class="p">)</span><span class="o">*</span><span class="n">log</span><span class="p">(</span><span class="n">t</span><span class="o">/</span><span class="n">tRel</span><span class="p">));</span>
  <span class="n">V</span> <span class="o">=</span> <span class="n">v_rRel</span><span class="o">+</span><span class="n">a_rRel</span><span class="o">*</span><span class="p">(</span><span class="n">t</span><span class="o">-</span><span class="n">tRel</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="n">R</span><span class="o">&lt;</span><span class="mf">0.</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">R</span><span class="o">=</span><span class="n">V</span><span class="o">=</span><span class="mf">0.</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">Astro</span><span class="o">::</span><span class="n">TrueloveMcKeeEjectaDominatedReverseShock</span><span class="p">(</span><span class="kt">double</span> <span class="n">x</span><span class="p">,</span>
                                                    <span class="kt">double</span> <span class="o">&amp;</span><span class="n">Y</span><span class="p">,</span> <span class="kt">double</span> <span class="o">&amp;</span><span class="n">V</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">double</span> <span class="n">l_ED</span> <span class="o">=</span> <span class="n">truelovemckeeparams</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">phi_ED</span> <span class="o">=</span> <span class="n">truelovemckeeparams</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">f_n</span> <span class="o">=</span> <span class="n">truelovemckeeparams</span><span class="p">[</span><span class="mi">14</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">alpha</span> <span class="o">=</span> <span class="n">truelovemckeeparams</span><span class="p">[</span><span class="mi">15</span><span class="p">];</span>
  <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">truelovemckeeparams</span><span class="p">[</span><span class="mi">22</span><span class="p">];</span>

  <span class="k">if</span><span class="p">(</span><span class="n">index</span><span class="o">&lt;</span><span class="mf">5.</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">-</span><span class="p">((</span><span class="mf">3.</span><span class="o">-</span><span class="n">index</span><span class="p">)</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">phi_ED</span><span class="o">/</span><span class="p">(</span><span class="n">l_ED</span><span class="o">*</span><span class="n">f_n</span><span class="p">))</span><span class="o">*</span><span class="n">pow</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">l_ED</span><span class="p">,</span><span class="mf">1.5</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">Y</span><span class="o">&lt;=</span><span class="mf">0.</span><span class="p">)</span> <span class="p">{</span><span class="n">Y</span><span class="o">=</span><span class="mf">0.</span><span class="p">;</span><span class="n">V</span><span class="o">=</span><span class="mf">0.</span><span class="p">;</span><span class="k">return</span> <span class="mi">1</span><span class="p">;}</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="o">-</span><span class="mf">2.</span><span class="o">/</span><span class="p">(</span><span class="mf">3.</span><span class="o">-</span><span class="n">index</span><span class="p">));</span>
    <span class="n">Y</span> <span class="o">*=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">alpha</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="p">;</span>

    <span class="n">V</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">-</span><span class="p">((</span><span class="mf">3.</span><span class="o">-</span><span class="n">index</span><span class="p">)</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">phi_ED</span><span class="o">/</span><span class="n">f_n</span><span class="p">)</span><span class="o">*</span><span class="n">l_ED</span><span class="o">*</span><span class="n">pow</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="mf">1.5</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">V</span><span class="o">&lt;=</span><span class="mf">0.</span><span class="p">)</span> <span class="p">{</span><span class="n">Y</span><span class="o">=</span><span class="mf">0.</span><span class="p">;</span><span class="n">V</span><span class="o">=</span><span class="mf">0.</span><span class="p">;</span><span class="k">return</span> <span class="mi">1</span><span class="p">;}</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="n">V</span><span class="p">,</span><span class="mf">2.</span><span class="o">/</span><span class="p">(</span><span class="mf">3.</span><span class="o">-</span><span class="n">index</span><span class="p">));</span>
    <span class="n">V</span> <span class="o">*=</span> <span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">phi_ED</span><span class="o">/</span><span class="p">(</span><span class="n">alpha</span><span class="o">*</span><span class="n">f_n</span><span class="p">))</span><span class="o">*</span><span class="n">l_ED</span><span class="o">*</span><span class="n">pow</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="mf">1.5</span><span class="p">);</span>
    <span class="n">V</span> <span class="o">/=</span> <span class="mf">1.</span><span class="o">+</span><span class="p">(</span><span class="n">index</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">phi_ED</span><span class="o">/</span><span class="n">f_n</span><span class="p">)</span><span class="o">*</span><span class="n">l_ED</span><span class="o">*</span><span class="n">pow</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="mf">1.5</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="mf">27.</span><span class="o">/</span><span class="p">(</span><span class="mf">4.</span><span class="o">*</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="n">pow</span><span class="p">(</span><span class="n">index</span><span class="o">*</span><span class="p">(</span><span class="n">index</span><span class="o">-</span><span class="mf">3.</span><span class="p">),</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span><span class="o">*</span><span class="n">pow</span><span class="p">(</span><span class="n">l_ED</span><span class="p">,</span><span class="n">index</span><span class="o">-</span><span class="mf">2.</span><span class="p">)</span><span class="o">/</span><span class="n">phi_ED</span><span class="p">;</span>
    <span class="n">Y</span> <span class="o">*=</span> <span class="n">pow</span><span class="p">((</span><span class="mf">10.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">index</span><span class="o">-</span><span class="mf">5.</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">index</span><span class="o">-</span><span class="mf">3.</span><span class="p">),(</span><span class="n">index</span><span class="o">-</span><span class="mf">3.</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">Y</span><span class="o">&lt;=</span><span class="mf">0.</span><span class="p">)</span> <span class="p">{</span><span class="n">Y</span><span class="o">=</span><span class="mf">0.</span><span class="p">;</span><span class="n">V</span><span class="o">=</span><span class="mf">0.</span><span class="p">;</span><span class="k">return</span> <span class="mi">1</span><span class="p">;}</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="mf">1.</span><span class="o">/</span><span class="n">index</span><span class="p">);</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">Y</span><span class="o">*</span><span class="mf">3.</span><span class="o">/</span><span class="p">(</span><span class="n">index</span><span class="o">*</span><span class="n">l_ED</span><span class="p">)</span><span class="o">*</span><span class="n">pow</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="o">-</span><span class="mf">3.</span><span class="o">/</span><span class="n">index</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">V</span><span class="o">&lt;=</span><span class="mf">0.</span><span class="p">)</span> <span class="p">{</span><span class="n">Y</span><span class="o">=</span><span class="mf">0.</span><span class="p">;</span><span class="n">V</span><span class="o">=</span><span class="mf">0.</span><span class="p">;</span><span class="k">return</span> <span class="mi">1</span><span class="p">;}</span>
    <span class="n">Y</span> <span class="o">*=</span> <span class="n">pow</span><span class="p">(</span><span class="n">x</span><span class="p">,(</span><span class="n">index</span><span class="o">-</span><span class="mf">3.</span><span class="p">)</span><span class="o">/</span><span class="n">index</span><span class="p">)</span><span class="o">/</span><span class="n">l_ED</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="n">Y</span><span class="o">&lt;</span><span class="mf">0.</span><span class="p">)</span> <span class="n">Y</span><span class="o">=</span><span class="mf">0.</span><span class="p">;</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Astro</span><span class="o">::</span><span class="n">CalculateTrueLoveMcKeeParams</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">pars</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">double</span> <span class="n">n</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">e</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">mej</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">mSol</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">index</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

  <span class="cm">/* Eq (1) */</span>
  <span class="kt">double</span> <span class="n">charradiustruelovemckee</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="n">mej</span><span class="p">,</span><span class="mf">1.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span><span class="o">*</span><span class="n">pow</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="n">m_p_g</span><span class="p">,</span><span class="o">-</span><span class="mf">1.</span><span class="o">/</span><span class="mf">3.</span><span class="p">);</span>
  <span class="cm">/* Eq (2) */</span>
  <span class="kt">double</span> <span class="n">chartimetruelovemckee</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="o">-</span><span class="mf">1.</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span><span class="o">*</span><span class="n">pow</span><span class="p">(</span><span class="n">mej</span><span class="p">,</span><span class="mf">5.</span><span class="o">/</span><span class="mf">6.</span><span class="p">)</span><span class="o">*</span><span class="n">pow</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="n">m_p_g</span><span class="p">,</span><span class="o">-</span><span class="mf">1.</span><span class="o">/</span><span class="mf">3.</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">charvelocitytruelovemckee</span><span class="o">=</span><span class="n">charradiustruelovemckee</span><span class="o">/</span><span class="n">chartimetruelovemckee</span><span class="p">;</span>

  <span class="cm">/* format: {l_ED,w_core,phi_ED,phi_EDeff,t*_ST,R*_ST,R*_r_ST,v~*_r_ST,a~*_r_ST,t*_ref,t*_core,r*_r_core,v~*_r_core,a~*_r_core,f_n,alpha,eta} */</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">index</span><span class="p">)</span>          <span class="n">truelovemckeeparams</span> <span class="o">=</span> <span class="p">{</span>  <span class="mf">1.1</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.343</span><span class="p">,</span> <span class="mf">0.0961</span><span class="p">,</span> <span class="mf">0.495</span><span class="p">,</span> <span class="mf">0.727</span><span class="p">,</span> <span class="mf">0.545</span><span class="p">,</span> <span class="mf">0.585</span><span class="p">,</span> <span class="mf">0.106</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span>    <span class="mf">0.</span><span class="p">,</span>    <span class="mf">0.</span><span class="p">,</span>    <span class="mf">0.</span><span class="p">,</span>    <span class="mf">0.</span><span class="p">};</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">index</span><span class="o">==</span> <span class="mf">2.</span><span class="p">)</span> <span class="n">truelovemckeeparams</span> <span class="o">=</span> <span class="p">{</span>  <span class="mf">1.1</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.343</span><span class="p">,</span> <span class="mf">0.0947</span><span class="p">,</span> <span class="mf">0.387</span><span class="p">,</span> <span class="mf">0.679</span><span class="p">,</span> <span class="mf">0.503</span><span class="p">,</span> <span class="mf">0.686</span><span class="p">,</span><span class="o">-</span><span class="mf">0.151</span><span class="p">,</span> <span class="mf">1.6</span><span class="p">,</span>    <span class="mf">0.</span><span class="p">,</span>    <span class="mf">0.</span><span class="p">,</span>    <span class="mf">0.</span><span class="p">,</span>    <span class="mf">0.</span><span class="p">};</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">index</span><span class="o">==</span> <span class="mf">4.</span><span class="p">)</span> <span class="n">truelovemckeeparams</span> <span class="o">=</span> <span class="p">{</span>  <span class="mf">1.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.343</span><span class="p">,</span> <span class="mf">0.0791</span><span class="p">,</span> <span class="mf">0.232</span><span class="p">,</span> <span class="mf">0.587</span><span class="p">,</span>    <span class="mf">0.</span><span class="p">,</span>    <span class="mf">0.</span><span class="p">,</span>    <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span>   <span class="mf">1.7</span><span class="p">,</span>    <span class="mf">0.</span><span class="p">,</span>    <span class="mf">0.</span><span class="p">,</span>    <span class="mf">0.</span><span class="p">};</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">index</span><span class="o">==</span> <span class="mf">6.</span><span class="p">)</span> <span class="n">truelovemckeeparams</span> <span class="o">=</span> <span class="p">{</span> <span class="mf">1.39</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.39</span><span class="p">,</span>     <span class="mf">0.</span><span class="p">,</span>  <span class="mf">1.04</span><span class="p">,</span>  <span class="mf">1.07</span><span class="p">,</span>    <span class="mf">0.</span><span class="p">,</span>    <span class="mf">0.</span><span class="p">,</span>    <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.513</span><span class="p">,</span> <span class="mf">0.541</span><span class="p">,</span> <span class="mf">0.527</span><span class="p">,</span> <span class="mf">0.112</span><span class="p">};</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">index</span><span class="o">==</span> <span class="mf">7.</span><span class="p">)</span> <span class="n">truelovemckeeparams</span> <span class="o">=</span> <span class="p">{</span> <span class="mf">1.26</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.47</span><span class="p">,</span>     <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.732</span><span class="p">,</span> <span class="mf">0.881</span><span class="p">,</span>    <span class="mf">0.</span><span class="p">,</span>    <span class="mf">0.</span><span class="p">,</span>    <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.363</span><span class="p">,</span> <span class="mf">0.469</span><span class="p">,</span> <span class="mf">0.553</span><span class="p">,</span> <span class="mf">0.116</span><span class="p">};</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">index</span><span class="o">==</span> <span class="mf">8.</span><span class="p">)</span> <span class="n">truelovemckeeparams</span> <span class="o">=</span> <span class="p">{</span> <span class="mf">1.21</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.52</span><span class="p">,</span>     <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.605</span><span class="p">,</span> <span class="mf">0.788</span><span class="p">,</span>    <span class="mf">0.</span><span class="p">,</span>    <span class="mf">0.</span><span class="p">,</span>    <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.292</span><span class="p">,</span> <span class="mf">0.413</span><span class="p">,</span> <span class="mf">0.530</span><span class="p">,</span> <span class="mf">0.139</span><span class="p">};</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">index</span><span class="o">==</span> <span class="mf">9.</span><span class="p">)</span> <span class="n">truelovemckeeparams</span> <span class="o">=</span> <span class="p">{</span> <span class="mf">1.19</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.55</span><span class="p">,</span>     <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.523</span><span class="p">,</span> <span class="mf">0.725</span><span class="p">,</span>    <span class="mf">0.</span><span class="p">,</span>    <span class="mf">0.</span><span class="p">,</span>    <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.249</span><span class="p">,</span> <span class="mf">0.371</span><span class="p">,</span> <span class="mf">0.497</span><span class="p">,</span> <span class="mf">0.162</span><span class="p">};</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">index</span><span class="o">==</span><span class="mf">10.</span><span class="p">)</span> <span class="n">truelovemckeeparams</span> <span class="o">=</span> <span class="p">{</span> <span class="mf">1.17</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.57</span><span class="p">,</span>     <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.481</span><span class="p">,</span> <span class="mf">0.687</span><span class="p">,</span>    <span class="mf">0.</span><span class="p">,</span>    <span class="mf">0.</span><span class="p">,</span>    <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.220</span><span class="p">,</span> <span class="mf">0.340</span><span class="p">,</span> <span class="mf">0.463</span><span class="p">,</span> <span class="mf">0.192</span><span class="p">};</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">index</span><span class="o">==</span><span class="mf">12.</span><span class="p">)</span> <span class="n">truelovemckeeparams</span> <span class="o">=</span> <span class="p">{</span> <span class="mf">1.15</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.60</span><span class="p">,</span>     <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.424</span><span class="p">,</span> <span class="mf">0.636</span><span class="p">,</span>    <span class="mf">0.</span><span class="p">,</span>    <span class="mf">0.</span><span class="p">,</span>    <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.182</span><span class="p">,</span> <span class="mf">0.293</span><span class="p">,</span> <span class="mf">0.403</span><span class="p">,</span> <span class="mf">0.251</span><span class="p">};</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">index</span><span class="o">==</span><span class="mf">14.</span><span class="p">)</span> <span class="n">truelovemckeeparams</span> <span class="o">=</span> <span class="p">{</span> <span class="mf">1.14</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.62</span><span class="p">,</span>     <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.389</span><span class="p">,</span> <span class="mf">0.603</span><span class="p">,</span>    <span class="mf">0.</span><span class="p">,</span>    <span class="mf">0.</span><span class="p">,</span>    <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.157</span><span class="p">,</span> <span class="mf">0.259</span><span class="p">,</span> <span class="mf">0.354</span><span class="p">,</span> <span class="mf">0.277</span><span class="p">};</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Astro::CalculateTrueLoveMcKeeParams: Density Index (index=&quot;</span>
         <span class="o">&lt;&lt;</span> <span class="n">index</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;) not supported! Returning nothing.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">truelovemckeeparams</span><span class="o">=</span><span class="p">{};</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kt">double</span> <span class="n">f_n</span><span class="p">,</span><span class="n">alpha</span><span class="p">,</span><span class="n">eta</span><span class="p">,</span><span class="n">w_core</span><span class="p">;</span>
  <span class="n">w_core</span> <span class="o">=</span> <span class="n">truelovemckeeparams</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
  <span class="n">f_n</span> <span class="o">=</span> <span class="p">(</span><span class="mf">3.</span><span class="o">/</span><span class="p">(</span><span class="mf">4.</span><span class="o">*</span><span class="n">pi</span><span class="p">))</span><span class="o">*</span><span class="p">((</span><span class="mf">1.</span><span class="o">-</span><span class="n">index</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="p">(</span><span class="n">index</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span><span class="o">*</span><span class="n">pow</span><span class="p">(</span><span class="n">w_core</span><span class="p">,</span><span class="mf">3.</span><span class="o">-</span><span class="n">index</span><span class="p">)));</span>
  <span class="k">if</span><span class="p">(</span><span class="n">index</span><span class="o">&lt;</span><span class="mf">3.</span><span class="o">&amp;&amp;!</span><span class="n">w_core</span><span class="p">)</span> <span class="n">alpha</span> <span class="o">=</span> <span class="p">(</span><span class="mf">3.</span><span class="o">-</span><span class="n">index</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">5.</span><span class="o">-</span><span class="n">index</span><span class="p">);</span>
  <span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="n">index</span><span class="o">&gt;</span><span class="mf">5.</span><span class="o">&amp;&amp;!</span><span class="n">w_core</span><span class="p">)</span> <span class="n">alpha</span> <span class="o">=</span> <span class="p">(</span><span class="mf">3.</span><span class="o">/</span><span class="mf">5.</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">index</span><span class="o">-</span><span class="mf">3.</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">index</span><span class="o">-</span><span class="mf">5.</span><span class="p">);</span>
  <span class="k">else</span> <span class="n">alpha</span> <span class="o">=</span> <span class="p">(</span><span class="mf">3.</span><span class="o">-</span><span class="n">index</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">5.</span><span class="o">-</span><span class="n">index</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">pow</span><span class="p">(</span><span class="n">w_core</span><span class="p">,</span><span class="o">-</span><span class="p">(</span><span class="mf">5.</span><span class="o">-</span><span class="n">index</span><span class="p">))</span><span class="o">-</span><span class="n">index</span><span class="o">/</span><span class="mf">5.</span><span class="p">)</span>
               <span class="o">/</span><span class="p">(</span><span class="n">pow</span><span class="p">(</span><span class="n">w_core</span><span class="p">,</span><span class="o">-</span><span class="p">(</span><span class="mf">3.</span><span class="o">-</span><span class="n">index</span><span class="p">))</span><span class="o">-</span><span class="n">index</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span><span class="o">*</span><span class="n">pow</span><span class="p">(</span><span class="n">w_core</span><span class="p">,</span><span class="mf">2.</span><span class="p">);</span>
  <span class="n">eta</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="n">index</span><span class="o">&gt;</span><span class="mf">0.</span><span class="p">)</span> <span class="n">eta</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span><span class="o">-</span><span class="mf">3.</span><span class="p">)</span><span class="o">/</span><span class="n">index</span><span class="p">;</span>
  <span class="n">truelovemckeeparams</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">f_n</span><span class="p">);</span>
  <span class="n">truelovemckeeparams</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">alpha</span><span class="p">);</span>
  <span class="n">truelovemckeeparams</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">eta</span><span class="p">);</span>
  <span class="n">truelovemckeeparams</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">charradiustruelovemckee</span><span class="p">);</span>
  <span class="n">truelovemckeeparams</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">chartimetruelovemckee</span><span class="p">);</span>
  <span class="n">truelovemckeeparams</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">charvelocitytruelovemckee</span><span class="p">);</span>
  <span class="n">truelovemckeeparams</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">truelovemckeeparams</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">chartimetruelovemckee</span><span class="p">);</span>
  <span class="n">truelovemckeeparams</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">truelovemckeeparams</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="o">*</span><span class="n">chartimetruelovemckee</span><span class="p">);</span>
  <span class="n">truelovemckeeparams</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>

  <span class="k">if</span><span class="p">(</span><span class="n">truelovemckeeparams</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">23</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Astro::CalculateTrueLoveMcKeeParams: Something went wrong in the&quot;</span>
            <span class="s">&quot;Calculation of the necessary parameter for the Truelove &amp; McKee &quot;</span>
            <span class="s">&quot;solution. Exiting!&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">truelovemckeeparams</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">QUIETMODE</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">vector</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">ParNames</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;l_ED&quot;</span><span class="p">,</span><span class="s">&quot;w_core&quot;</span><span class="p">,</span><span class="s">&quot;phi_ED&quot;</span><span class="p">,</span><span class="s">&quot;phi_EDeff&quot;</span><span class="p">,</span><span class="s">&quot;t*_ST&quot;</span><span class="p">,</span>
                               <span class="s">&quot;R*_ST&quot;</span><span class="p">,</span><span class="s">&quot;R*_r_ST&quot;</span><span class="p">,</span><span class="s">&quot;v~*_r_ST&quot;</span><span class="p">,</span><span class="s">&quot;a~*_r_ST&quot;</span><span class="p">,</span><span class="s">&quot;t*_ref&quot;</span><span class="p">,</span>
                               <span class="s">&quot;t*_core&quot;</span><span class="p">,</span><span class="s">&quot;r*_r_core&quot;</span><span class="p">,</span><span class="s">&quot;v~*_r_core&quot;</span><span class="p">,</span><span class="s">&quot;a~*_r_core&quot;</span><span class="p">,</span>
                               <span class="s">&quot;f_n&quot;</span><span class="p">,</span><span class="s">&quot;alpha&quot;</span><span class="p">,</span><span class="s">&quot;eta&quot;</span><span class="p">,</span><span class="s">&quot;charradiustruelovemckee&quot;</span><span class="p">,</span>
                               <span class="s">&quot;chartimetruelovemckee&quot;</span><span class="p">,</span>
                               <span class="s">&quot;charvelocitytruelovemckee&quot;</span><span class="p">,</span><span class="s">&quot;sedovtaylortime&quot;</span><span class="p">,</span>
                               <span class="s">&quot;coreexittime&quot;</span><span class="p">,</span><span class="s">&quot;index&quot;</span><span class="p">};</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;&gt;&gt; Paramaters for Truelove &amp; McKee&#39;s solution (density index = &quot;</span>
         <span class="o">&lt;&lt;</span> <span class="n">index</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;):&quot;</span> <span class="o">&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">truelovemckeeparams</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;   &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">ParNames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">truelovemckeeparams</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Astro</span><span class="o">::</span><span class="n">CalculateForwardShockInRGWind</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">pars</span><span class="p">,</span> <span class="kt">double</span> <span class="n">tmin</span><span class="p">,</span>
                                          <span class="kt">double</span> <span class="n">tmax</span><span class="p">,</span> <span class="kt">int</span> <span class="n">steps</span><span class="p">)</span> <span class="p">{</span>

  <span class="k">if</span><span class="p">(</span><span class="n">pars</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">!=</span><span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Astro::CalculateForwardShockInRGWind: wrong number of parameters (&quot;</span>
         <span class="o">&lt;&lt;</span> <span class="n">pars</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;). Parameter list takes exactly 10 &quot;</span>
            <span class="s">&quot;parameters: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; - [0] red giant wind radius (pc) &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; - [1] mass loss rate of progenitor red giant (mSol/yr) &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; - [2] red giant wind speed (cm/s) &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; - [3] radius of main-seqence wind bubble (MSWB) (pc) &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; - [4] density inside MSWB (cm^-3) &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; - [5] density of the ISM (cm^-3) &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; - [6] width of the shell at RGW-&gt;MSWB transition (pc) &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; - [7] width of the shell at MSWB-&gt;ISM transition (pc) &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; - [8] SN ejecta mass (mSol) &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; - [9] SN blast energy (erg) &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Returning empty vector!&quot;</span> <span class="o">&lt;&lt;</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">pars1</span> <span class="o">=</span> <span class="n">pars</span><span class="p">;</span>
  <span class="n">pars1</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">pars1</span><span class="p">.</span><span class="n">end</span><span class="p">()</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="n">pars1</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>

  <span class="kt">double</span> <span class="n">RGWSedovRadius</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">*</span><span class="n">mSol</span><span class="o">*</span><span class="n">pars</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">pars</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">mSol</span><span class="o">/</span><span class="n">yr_to_sec</span><span class="p">)</span>
                          <span class="o">/</span><span class="n">pc_to_cm</span><span class="p">;</span>

  <span class="n">vector</span><span class="o">&lt;</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">dprofile</span> <span class="o">=</span> <span class="n">CreateDensityProfile</span><span class="p">(</span><span class="n">pars1</span><span class="p">);</span>
  <span class="n">vector</span><span class="o">&lt;</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">massintegrand</span><span class="p">;</span>
  <span class="n">vector</span><span class="o">&lt;</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">mass</span><span class="p">;</span>
  <span class="n">vector</span><span class="o">&lt;</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">massinverse</span><span class="p">;</span>
  <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">dprofile</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">double</span> <span class="n">r</span> <span class="o">=</span> <span class="n">dprofile</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
    <span class="kt">double</span> <span class="n">n</span> <span class="o">=</span> <span class="n">dprofile</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
    <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">TwoDVectorPushBack</span><span class="p">(</span> <span class="n">r</span><span class="p">,</span> <span class="mf">4.</span><span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">m_p_g</span> <span class="o">*</span> <span class="n">n</span> <span class="o">*</span> <span class="n">r</span> <span class="o">*</span> <span class="n">r</span><span class="p">,</span><span class="n">massintegrand</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">massintegrand</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">SortTwoDVector</span><span class="p">(</span><span class="n">massintegrand</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
  <span class="n">mass</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">IntegratedProfile</span><span class="p">(</span><span class="n">massintegrand</span><span class="p">);</span>
  <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">mass</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">TwoDVectorPushBack</span><span class="p">(</span><span class="n">mass</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">mass</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">massinverse</span><span class="p">);</span>
  <span class="n">massinverse</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">SortTwoDVector</span><span class="p">(</span><span class="n">massinverse</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>

  <span class="n">gsl_spline</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">GSLsplineFromTwoDVector</span><span class="p">(</span><span class="n">massinverse</span><span class="p">);</span>
  <span class="n">gsl_interp_accel</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">gsl_interp_accel_alloc</span><span class="p">();</span>
  <span class="kt">double</span> <span class="n">RGWSedovRadiusFromProfile</span> <span class="o">=</span> <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">EvalSpline</span><span class="p">(</span><span class="n">pars</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">*</span><span class="n">mSol</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">a</span><span class="p">,</span>
                                                        <span class="n">__func__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">);</span>
  <span class="n">RGWSedovRadiusFromProfile</span> <span class="o">/=</span> <span class="n">pc_to_cm</span><span class="p">;</span>
  <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">RGWSedovRadius</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">RGWSedovRadiusFromProfile</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">RGVSR</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
  <span class="p">(</span><span class="n">RGWSedovRadiusFromProfile</span> <span class="o">&gt;</span> <span class="n">RGWSedovRadius</span><span class="p">)</span> <span class="o">?</span> <span class="n">RGVSR</span> <span class="o">=</span> <span class="nl">RGWSedovRadius</span><span class="p">:</span>
    <span class="n">RGVSR</span> <span class="o">=</span> <span class="n">RGWSedovRadiusFromProfile</span><span class="p">;</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">pars2</span><span class="p">;</span>
  <span class="n">pars2</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">pars</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="n">pars2</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">pars</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
  <span class="n">pars2</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">pars</span><span class="p">[</span><span class="mi">8</span><span class="p">]);</span>
  <span class="n">pars2</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">pars</span><span class="p">[</span><span class="mi">9</span><span class="p">]);</span>
  <span class="n">pars2</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">RGVSR</span><span class="p">);</span>

  <span class="n">CalculateThinShellApproximation</span><span class="p">(</span><span class="n">dprofile</span><span class="p">,</span><span class="n">pars</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span><span class="mf">1.333</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>

  <span class="c1">// make the r and v time profiles</span>
  <span class="k">if</span><span class="p">(</span><span class="n">steps</span> <span class="o">&amp;&amp;</span> <span class="n">tmin</span> <span class="o">&amp;&amp;</span> <span class="n">tmax</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">tmin</span><span class="o">&gt;=</span><span class="n">tmax</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Astro::CalculateThinShellApproximation: Can&#39;t create profiles&quot;</span>
              <span class="s">&quot;because tmin &gt;= tmax (&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">tmin</span> <span class="o">&lt;&lt;</span><span class="s">&quot; &gt;= &quot;</span><span class="o">&lt;&lt;</span> <span class="n">tmax</span> <span class="o">&lt;&lt;</span>
              <span class="s">&quot;) Exiting!&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kt">double</span> <span class="n">logtmin</span> <span class="o">=</span> <span class="n">log10</span><span class="p">(</span><span class="n">tmin</span><span class="p">);</span>
    <span class="kt">double</span> <span class="n">logtmax</span> <span class="o">=</span> <span class="n">log10</span><span class="p">(</span><span class="n">tmax</span><span class="p">);</span>
    <span class="kt">double</span> <span class="n">dlogt</span> <span class="o">=</span> <span class="p">(</span><span class="n">logtmax</span><span class="o">-</span><span class="n">logtmin</span><span class="p">)</span><span class="o">/</span><span class="n">steps</span><span class="p">;</span>
    <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">Clear2DVector</span><span class="p">(</span><span class="n">forwardshockradiusprofile</span><span class="p">);</span>
    <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">Clear2DVector</span><span class="p">(</span><span class="n">forwardshockvelocityprofile</span><span class="p">);</span>
    <span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">x</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">t</span><span class="o">=</span><span class="mf">0.</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">double</span> <span class="n">logt</span> <span class="o">=</span> <span class="n">logtmin</span> <span class="p">;</span> <span class="n">logt</span> <span class="o">&lt;</span> <span class="n">logtmax</span> <span class="p">;</span> <span class="n">logt</span> <span class="o">+=</span> <span class="n">dlogt</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">t</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span><span class="n">logt</span><span class="p">);</span>
      <span class="n">x</span> <span class="o">=</span> <span class="n">ForwardShockInRGWind</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">pars2</span><span class="p">,</span><span class="n">dprofile</span><span class="p">);</span>
      <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">TwoDVectorPushBack</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">pc_to_cm</span><span class="p">,</span><span class="n">forwardshockradiusprofile</span><span class="p">);</span>
      <span class="n">fUtils</span><span class="o">-&gt;</span><span class="n">TwoDVectorPushBack</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">forwardshockvelocityprofile</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Free expansion phase forward shock dynamics in red giant wind.</span>
<span class="cm"> * Eq. 14 from Ptuskin&amp;Zirakashvili 2005 (A&amp;A 429, 755â765 (2005))</span>
<span class="cm"> */</span>
 <span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">Astro</span><span class="o">::</span><span class="n">ForwardShockInRGWind</span><span class="p">(</span><span class="kt">double</span> <span class="n">t</span><span class="p">,</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">pars</span><span class="p">,</span>
                                            <span class="n">vector</span><span class="o">&lt;</span> <span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">profile</span><span class="p">){</span>

  <span class="kt">double</span> <span class="n">tScaled</span> <span class="o">=</span> <span class="n">t</span><span class="o">/</span><span class="mf">1.e3</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">mDotRGWindScaled</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">1.e-5</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">vRGWindScaled</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">1.e6</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">mEjScaled</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">Escaled</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="mf">1.e51</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">RGWSedovRadius</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">k</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">V</span><span class="p">;</span>
  <span class="n">k</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="n">pow</span><span class="p">(</span><span class="n">Escaled</span><span class="p">,</span><span class="mf">3.5</span><span class="p">)</span><span class="o">*</span><span class="n">vRGWindScaled</span><span class="o">/</span><span class="p">(</span><span class="n">mDotRGWindScaled</span><span class="o">*</span><span class="n">pow</span><span class="p">(</span><span class="n">mEjScaled</span><span class="p">,</span><span class="mf">2.5</span><span class="p">)),</span><span class="mf">1.</span><span class="o">/</span><span class="mf">8.</span><span class="p">);</span>
  <span class="n">R</span> <span class="o">=</span> <span class="mf">7.7</span><span class="o">*</span><span class="n">k</span><span class="o">*</span><span class="n">pow</span><span class="p">(</span><span class="n">tScaled</span><span class="p">,</span><span class="mf">7.</span><span class="o">/</span><span class="mf">8.</span><span class="p">);</span>
  <span class="n">V</span> <span class="o">=</span> <span class="mf">6.6e3</span><span class="o">*</span><span class="n">k</span><span class="o">*</span><span class="n">pow</span><span class="p">(</span><span class="n">tScaled</span><span class="p">,</span><span class="o">-</span><span class="mf">1.</span><span class="o">/</span><span class="mf">8.</span><span class="p">);</span>
  <span class="n">R</span><span class="o">*=</span><span class="mf">1.15</span><span class="p">;</span><span class="c1">///&lt;this connects the solution to the Thin Shell adiabatic solution</span>
  <span class="n">V</span><span class="o">*=</span><span class="mf">0.9</span><span class="p">;</span><span class="c1">///&lt;this connects the solution to the Thin Shell adiabatic solution</span>
  <span class="c1">//cout&lt;&lt;t&lt;&lt;&quot; &quot;&lt;&lt;R&lt;&lt;&quot; &quot;&lt;&lt;RGWSedovRadius&lt;&lt;std::endl;</span>
  <span class="k">if</span><span class="p">(</span><span class="n">R</span><span class="o">&gt;</span><span class="n">RGWSedovRadius</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">v</span> <span class="o">=</span> <span class="n">ThinShellRadiusAndSpeed</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">pc_to_cm</span><span class="p">;</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">1.e5</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">R</span> <span class="o">*=</span> <span class="n">pc_to_cm</span><span class="p">;</span>
  <span class="n">V</span> <span class="o">*=</span> <span class="mf">1.e5</span><span class="p">;</span>
  <span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">v</span><span class="p">;</span>
  <span class="n">v</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">R</span><span class="p">);</span>
  <span class="n">v</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">V</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">v</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="astro_header.html" class="btn btn-neutral float-right" title="Astro: header" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="astro.html" class="btn btn-neutral" title="Astro" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Joachim Hahn.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.9',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>